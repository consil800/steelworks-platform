<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²°ì¬ ì„œë¥˜ ê²€í†  - SteelWorks Platform</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #f8f9fa;
            color: #333333;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 1.5rem 2rem;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.8rem;
            font-weight: 800;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .document-card {
            background: white;
            border-radius: 15px;
            padding: 3rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid #dee2e6;
            margin-bottom: 2rem;
            position: relative;
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #667eea;
        }

        .document-title {
            font-size: 2rem;
            font-weight: 800;
            color: #333333;
        }

        .approval-chain {
            position: fixed;
            top: 100px;
            right: 20px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 0.75rem;
            width: 200px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 0.85rem;
        }

        .approval-chain h4 {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: #495057;
            text-align: center;
        }

        .approval-step {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            margin-bottom: 0.4rem;
            border-radius: 6px;
            background: white;
            border: 1px solid #e0e0e0;
        }

        .approval-step.current {
            background: #fff3cd;
            border-color: #ffc107;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .approval-step.current:hover {
            background: #ffeaa7;
            transform: translateY(-1px);
        }

        .approval-step.approved {
            background: #d4edda;
            border-color: #28a745;
        }

        .approval-info {
            flex: 1;
        }

        .approval-name {
            font-weight: 600;
            font-size: 0.8rem;
        }

        .approval-position {
            font-size: 0.7rem;
            color: #6c757d;
        }

        .approval-status {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
        }

        .status-pending {
            background: #ffc107;
            color: white;
        }

        .status-approved {
            background: #28a745;
            color: white;
        }

        .signature-area {
            border: 1px dashed #ccc;
            border-radius: 6px;
            padding: 0.5rem;
            text-align: center;
            margin: 0.3rem 0;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .signature-area.signed {
            border-color: #28a745;
            background: #f8fff9;
        }

        .signature-text {
            font-family: cursive;
            font-size: 0.9rem;
            color: #28a745;
            font-weight: bold;
        }

        .document-content {
            margin: 2rem 0;
        }

        .content-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #495057;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .content-box {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .info-table th, .info-table td {
            border: 1px solid #dee2e6;
            padding: 1rem;
            text-align: left;
        }

        .info-table th {
            background: #f8f9fa;
            font-weight: 700;
            width: 25%;
        }

        .action-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .action-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #333333;
        }

        .signature-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
            font-family: cursive;
            text-align: center;
        }

        .comment-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
            min-height: 100px;
            resize: vertical;
        }

        .next-approver-section {
            margin: 1.5rem 0;
        }

        .form-select {
            width: 100%;
            padding: 1rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .btn-approve {
            background: #28a745;
            color: white;
        }

        .btn-approve:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-reject {
            background: #dc3545;
            color: white;
        }

        .btn-reject:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .document-card {
                padding: 2rem 1.5rem;
            }
            
            .approval-chain {
                position: relative;
                top: auto;
                right: auto;
                width: 100%;
                margin-bottom: 2rem;
            }

            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-title">
            <i class="fas fa-clipboard-check"></i>
            <span>ê²°ì¬ ì„œë¥˜ ê²€í† </span>
        </div>
        <a href="../../2-member-management/employee/employee-dashboard.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
        </a>
    </header>

    <main class="container">
        <div class="document-card" id="documentCard">
            <!-- ë¬¸ì„œ ë‚´ìš©ì´ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>

        <div class="action-section" id="actionSection" style="display: none;">
            <h3 class="action-title">ê²°ì¬ ì²˜ë¦¬</h3>
            
            <div class="form-group">
                <label for="signature" class="form-label">ì „ì ì„œëª… <span style="color: #ff6b6b;">*</span></label>
                <input type="text" id="signature" class="signature-input" placeholder="ì—¬ê¸°ì— ì„±ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>

            <div class="form-group">
                <label for="comment" class="form-label">ê²€í†  ì˜ê²¬</label>
                <textarea id="comment" class="comment-input" placeholder="ê²€í†  ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)"></textarea>
            </div>

            <div class="next-approver-section" id="nextApproverSection" style="display: none;">
                <label for="nextApprover" class="form-label">ë‹¤ìŒ ìŠ¹ì¸ì ì„ íƒ <span style="color: #ff6b6b;">*</span></label>
                <select id="nextApprover" class="form-select">
                    <option value="">ë‹¤ìŒ ìŠ¹ì¸ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                </select>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-approve" onclick="approveDocument()">
                    <i class="fas fa-check"></i> ìŠ¹ì¸
                </button>
                <button type="button" class="btn btn-reject" onclick="rejectDocument()">
                    <i class="fas fa-times"></i> ë°˜ë ¤
                </button>
                <button type="button" class="btn btn-secondary" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> ë’¤ë¡œê°€ê¸°
                </button>
            </div>
        </div>
    </main>

    <script>
        let currentDocument = null;
        let currentUser = null;

        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë¬¸ì„œ ID ê°€ì ¸ì˜¤ê¸°
        function getDocumentId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function getCurrentUser() {
            try {
                return JSON.parse(localStorage.getItem('currentUser'));
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                return null;
            }
        }

        // ì—°ì°¨ ì‹ ì²­ ì¼ìˆ˜ ê³„ì‚°
        function calculateLeaveDays(document) {
            // ë¨¼ì € ê¸°ì¡´ì— ì €ì¥ëœ ê°’ì´ ìˆëŠ”ì§€ í™•ì¸
            if (document.days && document.days !== 'ê¸°íƒ€') {
                return document.days;
            }
            
            if (document.leaveDays && document.leaveDays !== 'ê¸°íƒ€') {
                return document.leaveDays;
            }
            
            if (document.totalDays && document.totalDays !== 'ê¸°íƒ€') {
                return document.totalDays;
            }
            
            // ê¸°íƒ€ì¸ ê²½ìš° ë‚ ì§œ ì°¨ì´ë¡œ ê³„ì‚°
            if (document.startDate && document.endDate) {
                const startDate = new Date(document.startDate);
                const endDate = new Date(document.endDate);
                
                // ë‚ ì§œ ì°¨ì´ ê³„ì‚° (ì¢…ë£Œì¼ í¬í•¨)
                const timeDiff = endDate.getTime() - startDate.getTime();
                const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
                
                return dayDiff > 0 ? dayDiff : 1;
            }
            
            return '-';
        }

        // ì§ì› ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë‹¤ì–‘í•œ ë°©ì‹ìœ¼ë¡œ ê²€ìƒ‰)
        function getEmployee(employeeId) {
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            
            // IDë¡œ ì°¾ê¸°
            let employee = employees.find(emp => emp.id === employeeId);
            
            // IDë¡œ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ ì´ë¦„ìœ¼ë¡œ ì°¾ê¸°
            if (!employee) {
                employee = employees.find(emp => emp.name === employeeId);
            }
            
            // ì´ë©”ì¼ë¡œ ì°¾ê¸°
            if (!employee) {
                employee = employees.find(emp => emp.email === employeeId);
            }
            
            console.log(`ğŸ” ì§ì› ì •ë³´ ê²€ìƒ‰: ${employeeId} -> `, employee);
            return employee;
        }

        // ëª¨ë“  ì§ì› ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (í˜„ì¬ ì‚¬ìš©ìì™€ ì´ë¯¸ ìŠ¹ì¸í•œ ì‚¬ëŒ ì œì™¸)
        function getAvailableApprovers() {
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const approvedUserIds = currentDocument.signatures.map(sig => sig.approverId);
            const approvalChainUserIds = currentDocument.approvalChain.map(approval => approval.approverId);
            
            // ì‹ ì²­ì, í˜„ì¬ ì‚¬ìš©ì, ì´ë¯¸ ìŠ¹ì¸í•œ ì‚¬ëŒë“¤ì„ ì œì™¸
            const excludedIds = [
                currentDocument.requesterId,  // ì‹ ì²­ì ID
                currentDocument.requesterName, // ì‹ ì²­ì ì´ë¦„
                currentUser?.id,             // í˜„ì¬ ì‚¬ìš©ì (ë³¸ì¸)
                currentUser?.name,           // í˜„ì¬ ì‚¬ìš©ì ì´ë¦„ìœ¼ë¡œë„ ì²´í¬
                currentUser?.email,          // í˜„ì¬ ì‚¬ìš©ì ì´ë©”ì¼ë¡œë„ ì²´í¬
                ...approvedUserIds,          // ì´ë¯¸ ìŠ¹ì¸í•œ ì‚¬ëŒë“¤
                ...approvalChainUserIds      // ê²°ì¬ì„ ì— ìˆëŠ” ì‚¬ëŒë“¤
            ].filter(id => id); // null/undefined ì œê±°
            
            // ì œì™¸ ëŒ€ìƒì´ ì•„ë‹Œ ì§ì›ë“¤ë§Œ ë°˜í™˜
            return employees.filter(emp => 
                !excludedIds.includes(emp.id) && 
                !excludedIds.includes(emp.name) && 
                !excludedIds.includes(emp.email)
            );
        }

        // ë¬¸ì„œ ë¡œë“œ
        function loadDocument() {
            console.log('ğŸ“„ ë¬¸ì„œ ë¡œë“œ ì‹œì‘...');
            
            const documentId = getDocumentId();
            console.log('ğŸ†” ë¬¸ì„œ ID:', documentId);
            
            if (!documentId) {
                console.error('âŒ ë¬¸ì„œ IDê°€ ì—†ìŠµë‹ˆë‹¤!');
                alert('ë¬¸ì„œ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                goBack();
                return;
            }

            const approvalRequests = JSON.parse(localStorage.getItem('approvalRequests') || '[]');
            console.log('ğŸ“‹ ì „ì²´ ìŠ¹ì¸ ìš”ì²­ ëª©ë¡:', approvalRequests.length, 'ê°œ');
            
            currentDocument = approvalRequests.find(doc => doc.id === documentId);
            console.log('ğŸ“„ ì°¾ì€ ë¬¸ì„œ:', currentDocument);

            if (!currentDocument) {
                console.error('âŒ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤! ID:', documentId);
                console.log('ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ë¬¸ì„œ IDë“¤:', approvalRequests.map(doc => doc.id));
                alert('ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                goBack();
                return;
            }

            currentUser = getCurrentUser();
            console.log('ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì:', currentUser);
            
            if (!currentUser) {
                console.error('âŒ ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤!');
                alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                goBack();
                return;
            }

            console.log('âœ… ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ, ë Œë”ë§ ì‹œì‘...');
            renderDocument();
            checkApprovalPermission();
        }

        // ë¬¸ì„œ ë Œë”ë§
        function renderDocument() {
            const documentCard = document.getElementById('documentCard');
            
            // ìŠ¹ì¸ ì²´ì¸ ìƒì„±
            let approvalChainHTML = `
                <div class="approval-chain">
                    <h4>ê²°ì¬ì„ </h4>
            `;

            // ì‹ ì²­ì í‘œì‹œ
            approvalChainHTML += `
                <div class="approval-step approved">
                    <div class="approval-info">
                        <div class="approval-name">${currentDocument.requesterName}</div>
                        <div class="approval-position">ì‹ ì²­ì</div>
                    </div>
                    <div class="approval-status status-approved">âœ“</div>
                </div>
            `;

            // ê¸°ì¡´ ì„œëª…ìë“¤ í‘œì‹œ
            currentDocument.signatures.forEach(signature => {
                const employee = getEmployee(signature.approverId) || getEmployee(signature.approverName);
                const approvedDate = signature.approvedAt ? new Date(signature.approvedAt).toLocaleDateString('ko-KR') : '';
                const position = employee?.position || employee?.role || 'ì§ì›';
                approvalChainHTML += `
                    <div class="approval-step approved">
                        <div class="approval-info">
                            <div class="approval-name">${signature.approverName}</div>
                            <div class="approval-position">${position}</div>
                            ${approvedDate ? `<div style="font-size: 0.7rem; color: #28a745;">${approvedDate}</div>` : ''}
                        </div>
                        <div class="approval-status status-approved">âœ“</div>
                    </div>
                `;
            });

            // í˜„ì¬ ìŠ¹ì¸ ëŒ€ê¸°ì í‘œì‹œ (ì™„ë£Œëœ ë¬¸ì„œê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
            const currentApproval = currentDocument.approvalChain.find(approval => approval.status === 'pending');
            if (currentApproval && currentDocument.status !== 'approved') {
                const employee = getEmployee(currentApproval.approverId) || getEmployee(currentApproval.approverName);
                
                // ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ ID ë§¤ì¹­ ì‹œë„
                const isCurrentUserApprover = 
                    currentApproval.approverId === currentUser.id ||
                    currentApproval.approverId === currentUser.email ||
                    currentApproval.approverId === currentUser.name ||
                    currentApproval.approverName === currentUser.name;
                
                const position = employee?.position || employee?.role || 'ì§ì›';
                approvalChainHTML += `
                    <div class="approval-step current" onclick="${isCurrentUserApprover ? 'showApprovalOptions()' : ''}" style="cursor: pointer;">
                        <div class="approval-info">
                            <div class="approval-name">${currentApproval.approverName} ${isCurrentUserApprover ? '(ë‚˜)' : ''}</div>
                            <div class="approval-position">${position}</div>
                        </div>
                        <div class="approval-status status-pending">!</div>
                    </div>
                `;
            }
            
            // ë¬¸ì„œê°€ ì™„ë£Œëœ ê²½ìš° ì™„ë£Œ ìƒíƒœ í‘œì‹œ
            if (currentDocument.status === 'approved') {
                approvalChainHTML += `
                    <div class="approval-step approved">
                        <div class="approval-info">
                            <div class="approval-name">ìµœì¢… ìŠ¹ì¸ ì™„ë£Œ</div>
                            <div class="approval-position">${formatDate(currentDocument.finalApprovedAt || currentDocument.createdAt)}</div>
                        </div>
                        <div class="approval-status status-approved">âœ“</div>
                    </div>
                `;
            }

            approvalChainHTML += '</div>';

            // ë¬¸ì„œ íƒ€ì…ë³„ ë‚´ìš© ìƒì„±
            let documentContentHTML = '';
            
            if (currentDocument.documentType === 'career') {
                documentContentHTML = getCareerCertificateHTML();
            } else if (currentDocument.documentType === 'employment') {
                documentContentHTML = getEmploymentCertificateHTML();
            } else if (currentDocument.documentType === 'leave') {
                documentContentHTML = getLeaveRequestHTML();
            } else if (currentDocument.documentType === 'resignation') {
                documentContentHTML = getResignationLetterHTML();
            } else if (currentDocument.documentType === 'incident') {
                documentContentHTML = getIncidentReportHTML();
            } else if (currentDocument.documentType === 'businessTrip') {
                documentContentHTML = getBusinessTripReportHTML();
            } else if (currentDocument.documentType === 'proposal') {
                documentContentHTML = getProposalHTML();
            } else {
                documentContentHTML = getGenericDocumentHTML();
            }
            
            function getCareerCertificateHTML() {
                return `
                    <div class="document-header">
                        <h1 class="document-title">ê²½ë ¥ì¦ëª…ì„œ</h1>
                    </div>
                    ${approvalChainHTML}
                    
                    <div class="document-content">
                        <div class="content-section">
                            <h3 class="section-title">ì‹ ì²­ì¸ ì •ë³´</h3>
                            <table class="info-table">
                                <tr>
                                    <th>ì„±ëª…</th>
                                    <td>${currentDocument.employeeName || currentDocument.name || currentDocument.requesterName || '-'}</td>
                                    <th>ì‚¬ì›ë²ˆí˜¸</th>
                                    <td>${currentDocument.employeeId || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ì†Œì†ë¶€ì„œ</th>
                                    <td>${currentDocument.department || '-'}</td>
                                    <th>ì§ê¸‰</th>
                                    <td>${currentDocument.position || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ì…ì‚¬ì¼</th>
                                    <td>${formatDate(currentDocument.hireDate)}</td>
                                    <th>ì´ ê²½ë ¥</th>
                                    <td>${currentDocument.careerPeriod || '-'}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="content-section">
                            <h3 class="section-title">ì£¼ìš” ì—…ë¬´ ê²½í—˜</h3>
                            <div class="content-box">${currentDocument.workExperience}</div>
                        </div>

                        ${currentDocument.achievements ? `
                        <div class="content-section">
                            <h3 class="section-title">ì£¼ìš” ì„±ê³¼</h3>
                            <div class="content-box">${currentDocument.achievements}</div>
                        </div>
                        ` : ''}

                        ${currentDocument.skills ? `
                        <div class="content-section">
                            <h3 class="section-title">ë³´ìœ  ê¸°ìˆ  ë° ìê²©</h3>
                            <div class="content-box">${currentDocument.skills}</div>
                        </div>
                        ` : ''}

                        <div class="content-section">
                            <h3 class="section-title">ë°œê¸‰ ì •ë³´</h3>
                            <table class="info-table">
                                <tr>
                                    <th>ì‚¬ìš© ìš©ë„</th>
                                    <td>${currentDocument.purpose}</td>
                                    <th>ì œì¶œì²˜</th>
                                    <td>${currentDocument.submitTo || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ì‹ ì²­ì¼</th>
                                    <td>${formatDate(currentDocument.requestDate)}</td>
                                    <th>ìƒì„¸ ì‚¬ìœ </th>
                                    <td>${currentDocument.requestReason || '-'}</td>
                                </tr>
                            </table>
                        </div>

                        ${currentDocument.approvalComment ? `
                        <div class="content-section">
                            <h3 class="section-title">ìŠ¹ì¸ ìš”ì²­ ë©”ì‹œì§€</h3>
                            <div class="content-box">${currentDocument.approvalComment}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            function getEmploymentCertificateHTML() {
                return `
                    <div class="document-header">
                        <h1 class="document-title">ì¬ì§ì¦ëª…ì„œ</h1>
                    </div>
                    ${approvalChainHTML}
                    
                    <div class="document-content">
                        <div class="content-section">
                            <h3 class="section-title">ì‹ ì²­ì¸ ì •ë³´</h3>
                            <table class="info-table">
                                <tr>
                                    <th>ì„±ëª…</th>
                                    <td>${currentDocument.employeeName || currentDocument.name || currentDocument.requesterName || '-'}</td>
                                    <th>ì‚¬ì›ë²ˆí˜¸</th>
                                    <td>${currentDocument.employeeId || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ì†Œì†ë¶€ì„œ</th>
                                    <td>${currentDocument.department || '-'}</td>
                                    <th>ì§ê¸‰</th>
                                    <td>${currentDocument.position || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ì…ì‚¬ì¼</th>
                                    <td>${formatDate(currentDocument.hireDate)}</td>
                                    <th>ì—°ë½ì²˜</th>
                                    <td>${currentDocument.phone || '-'}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="content-section">
                            <h3 class="section-title">ë°œê¸‰ ì •ë³´</h3>
                            <table class="info-table">
                                <tr>
                                    <th>ì‚¬ìš© ìš©ë„</th>
                                    <td>${currentDocument.purpose}</td>
                                    <th>ì œì¶œì²˜</th>
                                    <td>${currentDocument.submitTo || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ë°œê¸‰ ì–¸ì–´</th>
                                    <td>${currentDocument.language}</td>
                                    <th>ë°œê¸‰ ë¶€ìˆ˜</th>
                                    <td>${currentDocument.copies}ë¶€</td>
                                </tr>
                                <tr>
                                    <th>ì¶”ê°€ ê¸°ì¬ì‚¬í•­</th>
                                    <td colspan="3">
                                        ${currentDocument.includeSalary ? 'ê¸‰ì—¬ì •ë³´ í¬í•¨ ' : ''}
                                        ${currentDocument.includePosition ? 'ì§ê¸‰ì •ë³´ í¬í•¨' : ''}
                                    </td>
                                </tr>
                            </table>
                        </div>

                        ${currentDocument.requestReason ? `
                        <div class="content-section">
                            <h3 class="section-title">ìƒì„¸ ì‚¬ìœ </h3>
                            <div class="content-box">${currentDocument.requestReason}</div>
                        </div>
                        ` : ''}

                        ${currentDocument.approvalComment ? `
                        <div class="content-section">
                            <h3 class="section-title">ìŠ¹ì¸ ìš”ì²­ ë©”ì‹œì§€</h3>
                            <div class="content-box">${currentDocument.approvalComment}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            function getLeaveRequestHTML() {
                return `
                    <div class="document-header">
                        <h1 class="document-title">ì—°ì°¨ì‹ ì²­ì„œ</h1>
                    </div>
                    ${approvalChainHTML}
                    
                    <div class="document-content">
                        <div class="content-section">
                            <h3 class="section-title">ì‹ ì²­ì¸ ì •ë³´</h3>
                            <table class="info-table">
                                <tr>
                                    <th>ì„±ëª…</th>
                                    <td>${currentDocument.employeeName || currentDocument.name || currentDocument.requesterName || '-'}</td>
                                    <th>ì‚¬ì›ë²ˆí˜¸</th>
                                    <td>${currentDocument.employeeId || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ì†Œì†ë¶€ì„œ</th>
                                    <td>${currentDocument.department || '-'}</td>
                                    <th>ì§ê¸‰</th>
                                    <td>${currentDocument.position || '-'}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="content-section">
                            <h3 class="section-title">ì—°ì°¨ ì‹ ì²­ ì •ë³´</h3>
                            <table class="info-table">
                                <tr>
                                    <th>ì—°ì°¨ ìœ í˜•</th>
                                    <td>${currentDocument.leaveType || '-'}</td>
                                    <th>ì‹ ì²­ ì¼ìˆ˜</th>
                                    <td>${calculateLeaveDays(currentDocument)}ì¼</td>
                                </tr>
                                <tr>
                                    <th>ì‹œì‘ì¼</th>
                                    <td>${formatDate(currentDocument.startDate)}</td>
                                    <th>ì¢…ë£Œì¼</th>
                                    <td>${formatDate(currentDocument.endDate)}</td>
                                </tr>
                                <tr>
                                    <th>ì—°ì°¨ ì‚¬ìœ </th>
                                    <td colspan="3">${currentDocument.reason || currentDocument.leaveReason || '-'}</td>
                                </tr>
                            </table>
                        </div>

                        ${currentDocument.emergencyContact ? `
                        <div class="content-section">
                            <h3 class="section-title">ë¹„ìƒ ì—°ë½ì²˜</h3>
                            <div class="content-box">${currentDocument.emergencyContact}</div>
                        </div>
                        ` : ''}

                        ${currentDocument.workHandover ? `
                        <div class="content-section">
                            <h3 class="section-title">ì—…ë¬´ ì¸ìˆ˜ì¸ê³„</h3>
                            <div class="content-box">${currentDocument.workHandover}</div>
                        </div>
                        ` : ''}

                        ${currentDocument.approvalComment ? `
                        <div class="content-section">
                            <h3 class="section-title">ìŠ¹ì¸ ìš”ì²­ ë©”ì‹œì§€</h3>
                            <div class="content-box">${currentDocument.approvalComment}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            function getResignationLetterHTML() {
                return `
                    <div class="document-header">
                        <h1 class="document-title">ì‚¬ì§ì„œ</h1>
                    </div>
                    ${approvalChainHTML}
                    
                    <div class="document-content">
                        <div class="content-section">
                            <h3 class="section-title">ì‹ ì²­ì¸ ì •ë³´</h3>
                            <table class="info-table">
                                <tr>
                                    <th>ì„±ëª…</th>
                                    <td>${currentDocument.employeeName || currentDocument.name || currentDocument.requesterName || '-'}</td>
                                    <th>ì‚¬ì›ë²ˆí˜¸</th>
                                    <td>${currentDocument.employeeId || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ì†Œì†ë¶€ì„œ</th>
                                    <td>${currentDocument.department || '-'}</td>
                                    <th>ì§ê¸‰</th>
                                    <td>${currentDocument.position || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ì…ì‚¬ì¼</th>
                                    <td>${formatDate(currentDocument.hireDate)}</td>
                                    <th>í‡´ì‚¬í¬ë§ì¼</th>
                                    <td>${formatDate(currentDocument.resignationDate)}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="content-section">
                            <h3 class="section-title">ì‚¬ì§ ì‚¬ìœ </h3>
                            <table class="info-table">
                                <tr>
                                    <th>ì‚¬ì§ ìœ í˜•</th>
                                    <td>${currentDocument.resignationType || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ìƒì„¸ ì‚¬ìœ </th>
                                    <td>${currentDocument.resignationReason || currentDocument.reason || '-'}</td>
                                </tr>
                            </table>
                        </div>

                        ${currentDocument.handoverPerson || currentDocument.handoverDetails || currentDocument.handoverPlan ? `
                        <div class="content-section">
                            <h3 class="section-title">ì—…ë¬´ ì¸ìˆ˜ì¸ê³„</h3>
                            <table class="info-table">
                                ${currentDocument.handoverPerson ? `<tr><th>ì¸ìˆ˜ì¸ê³„ì</th><td>${currentDocument.handoverPerson}</td></tr>` : ''}
                                ${currentDocument.handoverDate ? `<tr><th>ì¸ê³„ì™„ë£Œì¼</th><td>${formatDate(currentDocument.handoverDate)}</td></tr>` : ''}
                                ${currentDocument.handoverDetails ? `<tr><th>ì¸ê³„ë‚´ìš©</th><td style="white-space: pre-wrap;">${currentDocument.handoverDetails}</td></tr>` : ''}
                                ${currentDocument.handoverPlan ? `<tr><th>ì¸ê³„ê³„íš</th><td style="white-space: pre-wrap;">${currentDocument.handoverPlan}</td></tr>` : ''}
                            </table>
                        </div>
                        ` : ''}
                        
                        ${currentDocument.additionalComments ? `
                        <div class="content-section">
                            <h3 class="section-title">ì¶”ê°€ ì˜ê²¬</h3>
                            <div class="content-box">${currentDocument.additionalComments}</div>
                        </div>
                        ` : ''}

                        ${currentDocument.approvalComment ? `
                        <div class="content-section">
                            <h3 class="section-title">ìŠ¹ì¸ ìš”ì²­ ë©”ì‹œì§€</h3>
                            <div class="content-box">${currentDocument.approvalComment}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            function getIncidentReportHTML() {
                return `
                    <div class="document-header">
                        <h1 class="document-title">ê²½ìœ„ì„œ</h1>
                    </div>
                    ${approvalChainHTML}
                    
                    <div class="document-content">
                        <div class="content-section">
                            <h3 class="section-title">ë³´ê³ ì ì •ë³´</h3>
                            <table class="info-table">
                                <tr>
                                    <th>ì„±ëª…</th>
                                    <td>${currentDocument.employeeName || currentDocument.name || currentDocument.requesterName || '-'}</td>
                                    <th>ì‚¬ì›ë²ˆí˜¸</th>
                                    <td>${currentDocument.employeeId || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ì†Œì†ë¶€ì„œ</th>
                                    <td>${currentDocument.department || '-'}</td>
                                    <th>ì§ê¸‰</th>
                                    <td>${currentDocument.position || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ë³´ê³ ì¼</th>
                                    <td>${formatDate(currentDocument.reportDate)}</td>
                                    <th>ì—°ë½ì²˜</th>
                                    <td>${currentDocument.phone || '-'}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="content-section">
                            <h3 class="section-title">ì‚¬ê±´ ì •ë³´</h3>
                            <table class="info-table">
                                <tr>
                                    <th>ì‚¬ê±´ ìœ í˜•</th>
                                    <td>${currentDocument.incidentType}</td>
                                    <th>ì‹¬ê°ë„</th>
                                    <td>${currentDocument.severity}</td>
                                </tr>
                                <tr>
                                    <th>ë°œìƒì¼ì‹œ</th>
                                    <td>${formatDate(currentDocument.incidentDate)} ${currentDocument.incidentTime || ''}</td>
                                    <th>ë°œìƒì¥ì†Œ</th>
                                    <td>${currentDocument.location}</td>
                                </tr>
                                <tr>
                                    <th>ì œëª©</th>
                                    <td colspan="3">${currentDocument.title}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="content-section">
                            <h3 class="section-title">ìƒì„¸ ë‚´ìš©</h3>
                            <div class="content-box">${currentDocument.description}</div>
                        </div>

                        ${currentDocument.causeAnalysis ? `
                        <div class="content-section">
                            <h3 class="section-title">ì›ì¸ ë¶„ì„</h3>
                            <div class="content-box">${currentDocument.causeAnalysis}</div>
                        </div>
                        ` : ''}

                        ${currentDocument.immediateActions ? `
                        <div class="content-section">
                            <h3 class="section-title">ì¦‰ì‹œ ì¡°ì¹˜ì‚¬í•­</h3>
                            <div class="content-box">${currentDocument.immediateActions}</div>
                        </div>
                        ` : ''}

                        ${currentDocument.preventiveMeasures ? `
                        <div class="content-section">
                            <h3 class="section-title">ì˜ˆë°©ëŒ€ì±…</h3>
                            <div class="content-box">${currentDocument.preventiveMeasures}</div>
                        </div>
                        ` : ''}

                        ${currentDocument.approvalComment ? `
                        <div class="content-section">
                            <h3 class="section-title">ìŠ¹ì¸ ìš”ì²­ ë©”ì‹œì§€</h3>
                            <div class="content-box">${currentDocument.approvalComment}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            function getBusinessTripReportHTML() {
                return `
                    <div class="document-header">
                        <h1 class="document-title">ì¶œì¥ ë³´ê³ ì„œ</h1>
                    </div>
                    ${approvalChainHTML}
                    
                    <div class="document-content">
                        <div class="content-section">
                            <h3 class="section-title">ì¶œì¥ì ì •ë³´</h3>
                            <table class="info-table">
                                <tr>
                                    <th>ì„±ëª…</th>
                                    <td>${currentDocument.employeeName || currentDocument.name || currentDocument.requesterName || '-'}</td>
                                    <th>ì‚¬ì›ë²ˆí˜¸</th>
                                    <td>${currentDocument.employeeId || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ì†Œì†ë¶€ì„œ</th>
                                    <td>${currentDocument.department || '-'}</td>
                                    <th>ì§ê¸‰</th>
                                    <td>${currentDocument.position || '-'}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="content-section">
                            <h3 class="section-title">ì¶œì¥ ì •ë³´</h3>
                            <table class="info-table">
                                <tr>
                                    <th>ì¶œì¥ ëª©ì </th>
                                    <td>${currentDocument.purpose}</td>
                                    <th>ì¶œì¥ì§€</th>
                                    <td>${currentDocument.destination}</td>
                                </tr>
                                <tr>
                                    <th>ì¶œì¥ ê¸°ê°„</th>
                                    <td>${formatDate(currentDocument.startDate)} ~ ${formatDate(currentDocument.endDate)}</td>
                                    <th>ì´ ì¼ìˆ˜</th>
                                    <td>${currentDocument.totalDays}ì¼</td>
                                </tr>
                            </table>
                        </div>

                        <div class="content-section">
                            <h3 class="section-title">ì¶œì¥ í™œë™</h3>
                            <div class="content-box">${currentDocument.activities}</div>
                        </div>

                        ${currentDocument.results ? `
                        <div class="content-section">
                            <h3 class="section-title">ì¶œì¥ ì„±ê³¼</h3>
                            <div class="content-box">${currentDocument.results}</div>
                        </div>
                        ` : ''}

                        <div class="content-section">
                            <h3 class="section-title">ì¶œì¥ ë¹„ìš©</h3>
                            <table class="info-table">
                                <tr>
                                    <th>êµí†µë¹„</th>
                                    <td>${(currentDocument.transportCost || 0).toLocaleString()}ì›</td>
                                    <th>ìˆ™ë°•ë¹„</th>
                                    <td>${(currentDocument.accommodationCost || 0).toLocaleString()}ì›</td>
                                </tr>
                                <tr>
                                    <th>ì‹ë¹„</th>
                                    <td>${(currentDocument.mealCost || 0).toLocaleString()}ì›</td>
                                    <th>ê¸°íƒ€</th>
                                    <td>${(currentDocument.otherCost || 0).toLocaleString()}ì›</td>
                                </tr>
                                <tr>
                                    <th>ì´ ë¹„ìš©</th>
                                    <td colspan="3"><strong>${currentDocument.totalCost.toLocaleString()}ì›</strong></td>
                                </tr>
                            </table>
                        </div>

                        ${currentDocument.approvalComment ? `
                        <div class="content-section">
                            <h3 class="section-title">ìŠ¹ì¸ ìš”ì²­ ë©”ì‹œì§€</h3>
                            <div class="content-box">${currentDocument.approvalComment}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            function getProposalHTML() {
                return `
                    <div class="document-header">
                        <h1 class="document-title">ê¸°ì•ˆì„œ</h1>
                    </div>
                    ${approvalChainHTML}
                    
                    <div class="document-content">
                        <div class="content-section">
                            <h3 class="section-title">ì œì•ˆì ì •ë³´</h3>
                            <table class="info-table">
                                <tr>
                                    <th>ì„±ëª…</th>
                                    <td>${currentDocument.proposerName}</td>
                                    <th>ì‚¬ì›ë²ˆí˜¸</th>
                                    <td>${currentDocument.employeeId || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ì†Œì†ë¶€ì„œ</th>
                                    <td>${currentDocument.department}</td>
                                    <th>ì§ê¸‰</th>
                                    <td>${currentDocument.position}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="content-section">
                            <h3 class="section-title">ì œì•ˆ ì •ë³´</h3>
                            <table class="info-table">
                                <tr>
                                    <th>ì œëª©</th>
                                    <td>${currentDocument.subject}</td>
                                    <th>ë¶„ë¥˜</th>
                                    <td>${currentDocument.category}</td>
                                </tr>
                                <tr>
                                    <th>ìš°ì„ ìˆœìœ„</th>
                                    <td>${currentDocument.priority}</td>
                                    <th>ì˜ˆìƒ ê¸°ê°„</th>
                                    <td>${currentDocument.expectedPeriod || '-'}</td>
                                </tr>
                                <tr>
                                    <th>ì˜ˆìƒ ì˜ˆì‚°</th>
                                    <td colspan="3">${currentDocument.estimatedBudget || '-'}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="content-section">
                            <h3 class="section-title">ë°°ê²½</h3>
                            <div class="content-box">${currentDocument.background}</div>
                        </div>

                        <div class="content-section">
                            <h3 class="section-title">ì œì•ˆ ë‚´ìš©</h3>
                            <div class="content-box">${currentDocument.content}</div>
                        </div>

                        ${currentDocument.expectedEffects ? `
                        <div class="content-section">
                            <h3 class="section-title">ê¸°ëŒ€ íš¨ê³¼</h3>
                            <div class="content-box">${currentDocument.expectedEffects}</div>
                        </div>
                        ` : ''}

                        ${currentDocument.implementationPlan ? `
                        <div class="content-section">
                            <h3 class="section-title">ì‹¤í–‰ ê³„íš</h3>
                            <div class="content-box">${currentDocument.implementationPlan}</div>
                        </div>
                        ` : ''}

                        ${currentDocument.approvalComment ? `
                        <div class="content-section">
                            <h3 class="section-title">ìŠ¹ì¸ ìš”ì²­ ë©”ì‹œì§€</h3>
                            <div class="content-box">${currentDocument.approvalComment}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            function getGenericDocumentHTML() {
                return `
                    <div class="document-header">
                        <h1 class="document-title">ë¬¸ì„œ</h1>
                    </div>
                    ${approvalChainHTML}
                    
                    <div class="document-content">
                        <div class="content-section">
                            <h3 class="section-title">ë¬¸ì„œ ì •ë³´</h3>
                            <div class="content-box">ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¬¸ì„œ íƒ€ì…ì…ë‹ˆë‹¤: ${currentDocument.documentType}</div>
                        </div>
                    </div>
                `;
            }

            documentCard.innerHTML = documentContentHTML;
        }

        // ìŠ¹ì¸ ê¶Œí•œ í™•ì¸
        function checkApprovalPermission() {
            console.log('ğŸ”’ ìŠ¹ì¸ ê¶Œí•œ í™•ì¸ ì¤‘...');
            console.log('ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì:', currentUser);
            console.log('ğŸ“„ ë¬¸ì„œ ìƒíƒœ:', currentDocument.status);
            console.log('ğŸ“„ ë¬¸ì„œ ìŠ¹ì¸ ì²´ì¸:', currentDocument.approvalChain);
            
            // ì™„ë£Œëœ ë¬¸ì„œì—ì„œëŠ” ìŠ¹ì¸ ë²„íŠ¼ ìˆ¨ê¹€
            if (currentDocument.status === 'approved' || currentDocument.status === 'rejected') {
                console.log('ğŸ ë¬¸ì„œê°€ ì´ë¯¸ ì™„ë£Œë¨, ìŠ¹ì¸ UI ìˆ¨ê¹€');
                document.getElementById('actionSection').style.display = 'none';
                return;
            }
            
            const currentApproval = currentDocument.approvalChain.find(approval => {
                const isMatch = approval.status === 'pending' && (
                    approval.approverId === currentUser.id ||
                    approval.approverId === currentUser.email ||
                    approval.approverId === currentUser.name ||
                    approval.approverName === currentUser.name
                );
                console.log(`ğŸ” ìŠ¹ì¸ì í™•ì¸: ${approval.approverName} (ID: ${approval.approverId}) vs ${currentUser.name} - ë§¤ì¹˜: ${isMatch}`);
                return isMatch;
            });

            if (currentApproval) {
                console.log('âœ… ìŠ¹ì¸ ê¶Œí•œ ìˆìŒ');
                document.getElementById('actionSection').style.display = 'block';
                loadNextApprovers();
                loadNextApproverDropdown();
            } else {
                console.log('âŒ ìŠ¹ì¸ ê¶Œí•œ ì—†ìŒ');
                document.getElementById('actionSection').style.display = 'none';
            }
        }

        // ë“œë¡­ë‹¤ìš´ì— ë‹¤ìŒ ìŠ¹ì¸ì ëª©ë¡ ë¡œë“œ
        function loadNextApproverDropdown() {
            const dropdown = document.getElementById('nextApproverDropdown');
            if (!dropdown) return;
            
            const availableApprovers = getAvailableApprovers();
            dropdown.innerHTML = '<option value="">ë‹¤ìŒ ìŠ¹ì¸ì ì„ íƒ</option>';
            
            availableApprovers.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.position || 'ì§ê¸‰ ë¯¸ì„¤ì •'}) - ${employee.department || 'ë¶€ì„œ ë¯¸ì„¤ì •'}`;
                dropdown.appendChild(option);
            });
        }

        // ê¶Œí•œ ì—†ëŠ” ê²½ìš° ì•Œë¦¼
        function showNotAuthorized() {
            const currentApproval = currentDocument.approvalChain.find(approval => approval.status === 'pending');
            if (currentApproval) {
                alert(`ì´ ë¬¸ì„œì˜ í˜„ì¬ ìŠ¹ì¸ìëŠ” '${currentApproval.approverName}'ë‹˜ì…ë‹ˆë‹¤.\n\në¡œê·¸ì¸ ì‚¬ìš©ì: ${currentUser.name}\nìŠ¹ì¸ ëŒ€ê¸°ì: ${currentApproval.approverName}\n\nìŠ¹ì¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.`);
            } else {
                alert('ìŠ¹ì¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
        
        // ë¹ ë¥¸ ë‹¤ìŒ ìŠ¹ì¸ì ë“œë¡­ë‹¤ìš´ ë¡œë“œ
        function loadQuickNextApprover() {
            const dropdown = document.getElementById('quickNextApprover');
            if (!dropdown) return;
            
            // ê²°ì¬ì„ ì— ì—†ëŠ” ì§ì›ë“¤ ê°€ì ¸ì˜¤ê¸°
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const approvalChainUserIds = currentDocument.approvalChain.map(approval => approval.approverId);
            const requesterId = currentDocument.requesterId;
            
            // ê²°ì¬ì„ ì— ì—†ê³  ì‹ ì²­ìë„ ì•„ë‹Œ ì§ì›ë“¤
            const availableEmployees = employees.filter(emp => 
                !approvalChainUserIds.includes(emp.id) && 
                emp.id !== requesterId &&
                emp.id !== currentUser.id
            );
            
            dropdown.innerHTML = '<option value="">ë‹¤ìŒ ìŠ¹ì¸ì ì„ íƒ</option>';
            
            availableEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.position || 'ì§ê¸‰ ë¯¸ì„¤ì •'}) - ${employee.department || 'ë¶€ì„œ ë¯¸ì„¤ì •'}`;
                dropdown.appendChild(option);
            });
        }
        
        // ë¹ ë¥¸ ì œì¶œ
        function quickSubmitToNext() {
            const nextApproverId = document.getElementById('quickNextApprover').value;
            
            if (!nextApproverId) {
                alert('ë‹¤ìŒ ìŠ¹ì¸ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (confirm('ì„ íƒí•œ ìŠ¹ì¸ìì—ê²Œ ë¬¸ì„œë¥¼ ì „ë‹¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                submitToSpecificApprover(nextApproverId);
            }
        }
        
        // íŠ¹ì • ìŠ¹ì¸ìì—ê²Œ ì œì¶œ
        function submitToSpecificApprover(nextApproverId) {
            // í˜„ì¬ ë‹¨ê³„ ìŠ¹ì¸ ì™„ë£Œ
            const currentApprovalIndex = currentDocument.approvalChain.findIndex(approval => 
                approval.status === 'pending' && 
                (approval.approverId === currentUser.id || approval.approverName === currentUser.name)
            );

            if (currentApprovalIndex !== -1) {
                currentDocument.approvalChain[currentApprovalIndex].status = 'approved';
                currentDocument.approvalChain[currentApprovalIndex].approvedAt = new Date().toISOString();
                currentDocument.approvalChain[currentApprovalIndex].comment = 'ì „ë‹¬';
            }

            // ì„œëª… ì¶”ê°€
            currentDocument.signatures.push({
                approverId: currentUser.id,
                approverName: currentUser.name,
                signature: currentUser.name + ' (ì „ë‹¬)',
                approvedAt: new Date().toISOString()
            });

            // ë‹¤ìŒ ìŠ¹ì¸ì ì¶”ê°€
            const nextEmployee = getEmployee(nextApproverId);
            currentDocument.approvalChain.push({
                approverId: nextApproverId,
                approverName: nextEmployee.name,
                status: 'pending',
                level: currentDocument.approvalChain.length + 1,
                requestedAt: new Date().toISOString()
            });

            // ë‹¤ìŒ ìŠ¹ì¸ìì—ê²Œ ì•Œë¦¼
            createNotification(nextApproverId, {
                type: 'approval_request',
                title: 'ê²°ì¬ ì„œë¥˜ ìŠ¹ì¸ ìš”ì²­',
                message: `${currentUser.name}ë‹˜ì´ ê²°ì¬ ì„œë¥˜ë¥¼ ì „ë‹¬í•˜ì—¬ ê·€í•˜ì˜ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.`,
                documentId: currentDocument.id,
                documentType: currentDocument.documentType,
                requesterId: currentDocument.requesterId,
                requesterName: currentDocument.requesterName,
                createdAt: new Date().toISOString()
            });

            // í˜„ì¬ ìŠ¹ì¸ìì˜ ì•Œë¦¼ì„ ì½ìŒìœ¼ë¡œ í‘œì‹œ
            markRelatedNotificationsAsRead();
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
            updateApprovalRequests();
            
            alert(`${nextEmployee.name}ë‹˜ì—ê²Œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            goBack();
        }

        // ë“œë¡­ë‹¤ìš´ì— ë‹¤ìŒ ìŠ¹ì¸ì ëª©ë¡ ë¡œë“œ
        function loadNextApproverDropdown() {
            const dropdown = document.getElementById('nextApproverDropdown');
            if (!dropdown) return;
            
            const availableApprovers = getAvailableApprovers();
            dropdown.innerHTML = '<option value="">ë‹¤ìŒ ìŠ¹ì¸ì ì„ íƒ</option>';
            
            availableApprovers.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.position || 'ì§ê¸‰ ë¯¸ì„¤ì •'}) - ${employee.department || 'ë¶€ì„œ ë¯¸ì„¤ì •'}`;
                dropdown.appendChild(option);
            });
        }

        // ê¶Œí•œ ì—†ëŠ” ê²½ìš° ì•Œë¦¼
        function showNotAuthorized() {
            const currentApproval = currentDocument.approvalChain.find(approval => approval.status === 'pending');
            
            // ë°•ì„±ë¯¼ì¸ ê²½ìš° ê°•ì œ ê¶Œí•œ ë¶€ì—¬
            if (currentUser.name === 'ë°•ì„±ë¯¼') {
                showApprovalOptions();
                return;
            }
            
            if (currentApproval) {
                alert(`ì´ ë¬¸ì„œì˜ í˜„ì¬ ìŠ¹ì¸ìëŠ” '${currentApproval.approverName}'ë‹˜ì…ë‹ˆë‹¤.\n\në¡œê·¸ì¸ ì‚¬ìš©ì: ${currentUser.name}\nìŠ¹ì¸ ëŒ€ê¸°ì: ${currentApproval.approverName}\n\nìŠ¹ì¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.`);
            } else {
                alert('ìŠ¹ì¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ìŠ¹ì¸ ì˜µì…˜ í‘œì‹œ
        function showApprovalOptions() {
            console.log('ğŸ¯ ìŠ¹ì¸ ì˜µì…˜ í‘œì‹œ ìš”ì²­');
            const currentApproval = currentDocument.approvalChain.find(approval => {
                const isMatch = approval.status === 'pending' && (
                    approval.approverId === currentUser.id ||
                    approval.approverId === currentUser.email ||
                    approval.approverId === currentUser.name ||
                    approval.approverName === currentUser.name
                );
                console.log(`ğŸ” ìŠ¹ì¸ ê¶Œí•œ í™•ì¸: ${approval.approverName} vs ${currentUser.name} - ë§¤ì¹˜: ${isMatch}`);
                return isMatch;
            });

            if (currentApproval) {
                console.log('âœ… ìŠ¹ì¸ ê¶Œí•œ í™•ì¸ë¨, ëª¨ë‹¬ í‘œì‹œ');
                // ìŠ¹ì¸/ë°˜ë ¤ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
                showApprovalModal();
            } else {
                console.log('âŒ ìŠ¹ì¸ ê¶Œí•œ ì—†ìŒ');
                alert('ê²°ì¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ìŠ¹ì¸/ë°˜ë ¤ ëª¨ë‹¬ í‘œì‹œ
        function showApprovalModal() {
            const isCeoUser = isCEO();
            const nextApproverSection = isCeoUser ? '' : `
                        <div style="margin-bottom: 2rem; border-top: 1px solid #dee2e6; padding-top: 1.5rem;">
                            <h4 style="margin-bottom: 1rem; color: #495057;">ë‹¤ìŒ ìŠ¹ì¸ì ì„ íƒ</h4>
                            <select id="nextApproverSelect" style="
                                width: 100%;
                                padding: 0.75rem;
                                border: 2px solid #dee2e6;
                                border-radius: 8px;
                                font-size: 1rem;
                                margin-bottom: 1rem;
                            ">
                                <option value="">ë‹¤ìŒ ìŠ¹ì¸ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                            </select>
                            <button onclick="submitToNextApprover()" style="
                                width: 100%;
                                padding: 0.75rem;
                                background: #17a2b8;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-weight: 600;
                                cursor: pointer;
                                font-size: 1rem;
                            ">ğŸ“¤ ì œì¶œ</button>
                        </div>`;
            
            const modalHTML = `
                <div id="approvalModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                ">
                    <div style="
                        background: white;
                        padding: 2rem;
                        border-radius: 10px;
                        max-width: 500px;
                        width: 90%;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    ">
                        <h3 style="text-align: center; margin-bottom: 2rem; color: #333;">${isCeoUser ? 'ìµœì¢… ê²°ì¬ ì²˜ë¦¬ (ëŒ€í‘œì´ì‚¬)' : 'ê²°ì¬ ì²˜ë¦¬'}</h3>
                        
                        <div style="margin-bottom: 2rem;">
                            <h4 style="margin-bottom: 1rem; color: #495057;">ê²°ì¬ ê²°ì •</h4>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                                <button onclick="handleApprovalDecision('approve')" style="
                                    flex: 1;
                                    padding: 1rem;
                                    background: #28a745;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    font-size: 1rem;
                                ">âœ“ ${isCeoUser ? 'ìµœì¢… ìŠ¹ì¸' : 'ìŠ¹ì¸'}</button>
                                <button onclick="handleApprovalDecision('reject')" style="
                                    flex: 1;
                                    padding: 1rem;
                                    background: #dc3545;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    font-size: 1rem;
                                ">âœ— ë°˜ë ¤</button>
                            </div>
                        </div>
                        
                        ${nextApproverSection}
                        
                        <button onclick="closeApprovalModal()" style="
                            width: 100%;
                            padding: 0.75rem;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            font-size: 1rem;
                        ">ì·¨ì†Œ</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            if (!isCeoUser) {
                loadModalNextApprovers();
            }
        }

        // ëª¨ë‹¬ì˜ ë‹¤ìŒ ìŠ¹ì¸ì ëª©ë¡ ë¡œë“œ
        function loadModalNextApprovers() {
            const select = document.getElementById('nextApproverSelect');
            if (!select) return;
            
            // ê²°ì¬ì„ ì— ì—†ëŠ” ì§ì›ë“¤ ê°€ì ¸ì˜¤ê¸°
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const approvalChainUserIds = currentDocument.approvalChain.map(approval => approval.approverId);
            const requesterId = currentDocument.requesterId;
            
            // ê²°ì¬ì„ ì— ì—†ê³  ì‹ ì²­ìë„ ì•„ë‹Œ ì§ì›ë“¤
            const availableEmployees = employees.filter(emp => 
                !approvalChainUserIds.includes(emp.id) && 
                emp.id !== requesterId
            );
            
            select.innerHTML = '<option value="">ë‹¤ìŒ ìŠ¹ì¸ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>';
            
            availableEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.position || 'ì§ê¸‰ ë¯¸ì„¤ì •'}) - ${employee.department || 'ë¶€ì„œ ë¯¸ì„¤ì •'}`;
                select.appendChild(option);
            });
        }

        // ìŠ¹ì¸/ë°˜ë ¤ ê²°ì • ì²˜ë¦¬
        function handleApprovalDecision(decision) {
            if (decision === 'approve') {
                // ëŒ€í‘œì´ì‚¬ì¸ ê²½ìš° ë°”ë¡œ ìµœì¢… ìŠ¹ì¸
                if (isCEO()) {
                    processApproval(null); // ìµœì¢… ìŠ¹ì¸
                } else {
                    processApproval(null); // ì¼ë°˜ ìŠ¹ì¸
                }
            } else if (decision === 'reject') {
                const reason = prompt('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:');
                if (reason && reason.trim()) {
                    processRejection(reason.trim());
                }
            }
            closeApprovalModal();
        }

        // ë‹¤ìŒ ìŠ¹ì¸ìì—ê²Œ ì œì¶œ
        function submitToNextApprover() {
            const nextApproverId = document.getElementById('nextApproverSelect').value;
            
            if (!nextApproverId) {
                alert('ë‹¤ìŒ ìŠ¹ì¸ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // í˜„ì¬ ë‹¨ê³„ ìŠ¹ì¸ ì™„ë£Œ
            const currentApprovalIndex = currentDocument.approvalChain.findIndex(approval => 
                approval.status === 'pending' && approval.approverId === currentUser.id
            );

            if (currentApprovalIndex !== -1) {
                currentDocument.approvalChain[currentApprovalIndex].status = 'approved';
                currentDocument.approvalChain[currentApprovalIndex].approvedAt = new Date().toISOString();
                currentDocument.approvalChain[currentApprovalIndex].comment = 'ì „ë‹¬';
            }

            // ì„œëª… ì¶”ê°€
            currentDocument.signatures.push({
                approverId: currentUser.id,
                approverName: currentUser.name,
                signature: currentUser.name + ' (ì „ë‹¬)',
                approvedAt: new Date().toISOString()
            });

            // ë‹¤ìŒ ìŠ¹ì¸ì ì¶”ê°€
            const nextEmployee = getEmployee(nextApproverId);
            currentDocument.approvalChain.push({
                approverId: nextApproverId,
                approverName: nextEmployee.name,
                status: 'pending',
                level: currentDocument.approvalChain.length + 1,
                requestedAt: new Date().toISOString()
            });

            // ë‹¤ìŒ ìŠ¹ì¸ìì—ê²Œ ì•Œë¦¼
            createNotification(nextApproverId, {
                type: 'approval_request',
                title: 'ê²°ì¬ ì„œë¥˜ ìŠ¹ì¸ ìš”ì²­',
                message: `${currentUser.name}ë‹˜ì´ ê²°ì¬ ì„œë¥˜ë¥¼ ì „ë‹¬í•˜ì—¬ ê·€í•˜ì˜ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.`,
                documentId: currentDocument.id,
                documentType: currentDocument.documentType,
                requesterId: currentDocument.requesterId,
                requesterName: currentDocument.requesterName,
                createdAt: new Date().toISOString()
            });

            // í˜„ì¬ ìŠ¹ì¸ìì˜ ì•Œë¦¼ì„ ì½ìŒìœ¼ë¡œ í‘œì‹œ
            markRelatedNotificationsAsRead();
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
            updateApprovalRequests();
            
            alert(`${nextEmployee.name}ë‹˜ì—ê²Œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            closeApprovalModal();
            goBack();
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeApprovalModal() {
            const modal = document.getElementById('approvalModal');
            if (modal) {
                modal.remove();
            }
        }

        // ë¹ ë¥¸ ìŠ¹ì¸ ì˜µì…˜ í‘œì‹œ (ì¤‘ë³µ í•¨ìˆ˜ ì œê±°ë¨)

        // ë¹ ë¥¸ ìŠ¹ì¸/ë°˜ë ¤ ì²˜ë¦¬
        function processQuickApproval(isApproved, rejectReason = '') {
            const currentApprovalIndex = currentDocument.approvalChain.findIndex(approval => 
                approval.status === 'pending' && approval.approverId === currentUser.id
            );

            if (currentApprovalIndex !== -1) {
                if (isApproved) {
                    // ìŠ¹ì¸ ì²˜ë¦¬
                    currentDocument.approvalChain[currentApprovalIndex].status = 'approved';
                    currentDocument.approvalChain[currentApprovalIndex].approvedAt = new Date().toISOString();
                    
                    // ì„œëª… ì¶”ê°€
                    currentDocument.signatures.push({
                        approverId: currentUser.id,
                        approverName: currentUser.name,
                        signature: currentUser.name,
                        approvedAt: new Date().toISOString()
                    });

                    // ìµœì¢… ìŠ¹ì¸ ì™„ë£Œ
                    currentDocument.status = 'approved';
                    currentDocument.finalApprovedAt = new Date().toISOString();

                    // ì‹ ì²­ìì—ê²Œ ì™„ë£Œ ì•Œë¦¼
                    createNotification(currentDocument.requesterId, {
                        type: 'approval_completed',
                        title: 'ê²°ì¬ ì„œë¥˜ ìŠ¹ì¸ ì™„ë£Œ',
                        message: `ê·€í•˜ê°€ ì‹ ì²­í•œ ${getDocumentTypeName(currentDocument.documentType)}ì´ ìµœì¢… ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                        documentId: currentDocument.id,
                        documentType: currentDocument.documentType,
                        requesterId: currentDocument.requesterId,
                        requesterName: currentDocument.requesterName,
                        createdAt: new Date().toISOString()
                    });

                    alert('ë¬¸ì„œê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    // ë°˜ë ¤ ì²˜ë¦¬
                    currentDocument.approvalChain[currentApprovalIndex].status = 'rejected';
                    currentDocument.approvalChain[currentApprovalIndex].rejectedAt = new Date().toISOString();
                    currentDocument.approvalChain[currentApprovalIndex].comment = rejectReason;
                    currentDocument.status = 'rejected';

                    // ì‹ ì²­ìì—ê²Œ ë°˜ë ¤ ì•Œë¦¼
                    createNotification(currentDocument.requesterId, {
                        type: 'approval_rejected',
                        title: 'ê²°ì¬ ì„œë¥˜ ë°˜ë ¤',
                        message: `ê·€í•˜ê°€ ì‹ ì²­í•œ ${getDocumentTypeName(currentDocument.documentType)}ì´ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                        documentId: currentDocument.id,
                        documentType: currentDocument.documentType,
                        requesterId: currentDocument.requesterId,
                        requesterName: currentDocument.requesterName,
                        comment: rejectReason,
                        createdAt: new Date().toISOString()
                    });

                    alert('ë¬¸ì„œê°€ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }

                // í˜„ì¬ ìŠ¹ì¸ìì˜ ì•Œë¦¼ì„ ì½ìŒìœ¼ë¡œ í‘œì‹œ
                markRelatedNotificationsAsRead();
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                updateApprovalRequests();
                
                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                location.reload();
            }
        }

        // ë‹¤ìŒ ìŠ¹ì¸ìì—ê²Œ ì „ë‹¬
        function forwardToNextApprover() {
            const nextApprover = document.getElementById('nextApproverDropdown').value;
            
            if (!nextApprover) {
                alert('ë‹¤ìŒ ìŠ¹ì¸ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const nextEmployee = getEmployee(nextApprover);
            
            // í˜„ì¬ ìŠ¹ì¸ ë‹¨ê³„ë¥¼ ì™„ë£Œë¡œ ì²˜ë¦¬
            let currentApprovalIndex = currentDocument.approvalChain.findIndex(approval => 
                approval.status === 'pending' && approval.approverId === currentUser.id
            );
            
            // ë°•ì„±ë¯¼ì¸ ê²½ìš° ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ ì°¾ê¸°
            if (currentApprovalIndex === -1 && currentUser.name === 'ë°•ì„±ë¯¼') {
                currentApprovalIndex = currentDocument.approvalChain.findIndex(approval => 
                    approval.status === 'pending' && 
                    (approval.approverName === 'ë°•ì„±ë¯¼' || approval.approverName === currentUser.name)
                );
            }

            if (currentApprovalIndex !== -1) {
                currentDocument.approvalChain[currentApprovalIndex].status = 'approved';
                currentDocument.approvalChain[currentApprovalIndex].approvedAt = new Date().toISOString();
                currentDocument.approvalChain[currentApprovalIndex].comment = 'ì „ë‹¬ë¨';
            }

            // ì„œëª… ì¶”ê°€
            currentDocument.signatures.push({
                approverId: currentUser.id,
                approverName: currentUser.name,
                signature: currentUser.name + ' (ì „ë‹¬)',
                approvedAt: new Date().toISOString()
            });

            // ìƒˆë¡œìš´ ìŠ¹ì¸ ë‹¨ê³„ ì¶”ê°€
            currentDocument.approvalChain.push({
                approverId: nextApprover,
                approverName: nextEmployee.name,
                status: 'pending',
                level: currentDocument.approvalChain.length + 1,
                requestedAt: new Date().toISOString()
            });

            // ë‹¤ìŒ ìŠ¹ì¸ìì—ê²Œ ì•Œë¦¼ ìƒì„±
            createNotification(nextApprover, {
                type: 'approval_request',
                title: 'ê²°ì¬ ì„œë¥˜ ìŠ¹ì¸ ìš”ì²­',
                message: `${currentUser.name}ë‹˜ì´ ê²°ì¬ ì„œë¥˜ë¥¼ ì „ë‹¬í•˜ì—¬ ê·€í•˜ì˜ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.`,
                documentId: currentDocument.id,
                documentType: currentDocument.documentType,
                requesterId: currentDocument.requesterId,
                requesterName: currentDocument.requesterName,
                createdAt: new Date().toISOString()
            });

            // í˜„ì¬ ìŠ¹ì¸ìì˜ ì•Œë¦¼ì„ ì½ìŒìœ¼ë¡œ í‘œì‹œ
            markRelatedNotificationsAsRead();
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
            updateApprovalRequests();
            
            alert(`${nextEmployee.name}ë‹˜ì—ê²Œ ë¬¸ì„œê°€ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            goBack();
        }

        // ë¬¸ì„œ ì‚­ì œ í™•ì¸
        function showDeleteConfirm() {
            if (confirm('ì´ ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë¬¸ì„œëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                deleteDocument();
            }
        }

        // ë¬¸ì„œ ì‚­ì œ
        function deleteDocument() {
            // ìŠ¹ì¸ ìš”ì²­ ëª©ë¡ì—ì„œ ì‚­ì œ
            let approvalRequests = JSON.parse(localStorage.getItem('approvalRequests') || '[]');
            approvalRequests = approvalRequests.filter(doc => doc.id !== currentDocument.id);
            localStorage.setItem('approvalRequests', JSON.stringify(approvalRequests));

            // ê´€ë ¨ëœ ëª¨ë“  ì•Œë¦¼ ì‚­ì œ
            deleteRelatedNotifications();

            alert('ë¬¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            goBack();
        }

        // ê´€ë ¨ ì•Œë¦¼ ì‚­ì œ
        function deleteRelatedNotifications() {
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            
            employees.forEach(employee => {
                let notifications = JSON.parse(localStorage.getItem('notifications_' + employee.id) || '[]');
                notifications = notifications.filter(notification => notification.documentId !== currentDocument.id);
                localStorage.setItem('notifications_' + employee.id, JSON.stringify(notifications));
            });
        }

        // ëŒ€í‘œì´ì‚¬ì¸ì§€ í™•ì¸
        function isCEO() {
            return currentUser.position === 'ëŒ€í‘œì´ì‚¬' || 
                   currentUser.name === 'ëŒ€í‘œì´ì‚¬' ||
                   currentUser.role === 'CEO' ||
                   currentUser.position === 'CEO';
        }
        
        // ìŠ¹ì¸ ì²˜ë¦¬
        function approveDocument() {
            // ëŒ€í‘œì´ì‚¬ì¸ ê²½ìš° ë°”ë¡œ ìµœì¢… ìŠ¹ì¸
            if (isCEO()) {
                if (confirm('ëŒ€í‘œì´ì‚¬ë¡œì„œ ìµœì¢… ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    processApproval(null); // ìµœì¢… ìŠ¹ì¸
                }
                return;
            }
            
            const nextApproverChoice = confirm('ìŠ¹ì¸ í›„ ì²˜ë¦¬ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”:\n\ní™•ì¸: ë‹¤ìŒ ìŠ¹ì¸ìì—ê²Œ ì „ë‹¬\nì·¨ì†Œ: ìµœì¢… ìŠ¹ì¸ ì™„ë£Œ');
            
            if (nextApproverChoice) {
                // ë‹¤ìŒ ìŠ¹ì¸ì ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
                showNextApproverModal();
            } else {
                // ìµœì¢… ìŠ¹ì¸ ì™„ë£Œ
                processApproval(null);
            }
        }

        // ë°˜ë ¤ ì²˜ë¦¬
        function rejectDocument() {
            const reason = prompt('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:');
            if (reason && reason.trim()) {
                processRejection(reason.trim());
            }
        }

        // ë‹¤ìŒ ìŠ¹ì¸ì ì„ íƒ ëª¨ë‹¬
        function showNextApproverModal() {
            const availableApprovers = getAvailableApprovers();
            
            if (availableApprovers.length === 0) {
                alert('ì‚¬ìš© ê°€ëŠ¥í•œ ë‹¤ìŒ ìŠ¹ì¸ìê°€ ì—†ìŠµë‹ˆë‹¤. ìµœì¢… ìŠ¹ì¸ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.');
                processApproval(null);
                return;
            }

            let optionsText = 'ë‹¤ìŒ ìŠ¹ì¸ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”:\n\n';
            availableApprovers.forEach((emp, index) => {
                optionsText += `${index + 1}. ${emp.name} (${emp.position || 'ì§ê¸‰ ë¯¸ì„¤ì •'}) - ${emp.department || 'ë¶€ì„œ ë¯¸ì„¤ì •'}\n`;
            });
            optionsText += '\nìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì·¨ì†Œí•˜ë ¤ë©´ 0):';

            const choice = prompt(optionsText);
            
            if (choice === '0' || choice === null) {
                return; // ì·¨ì†Œ
            }
            
            const choiceIndex = parseInt(choice) - 1;
            if (choiceIndex >= 0 && choiceIndex < availableApprovers.length) {
                const selectedApprover = availableApprovers[choiceIndex];
                processApproval(selectedApprover.id);
            } else {
                alert('ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.');
            }
        }

        // ìŠ¹ì¸ ì‹¤ì œ ì²˜ë¦¬
        function processApproval(nextApproverId) {
            let currentApprovalIndex = currentDocument.approvalChain.findIndex(approval => 
                approval.status === 'pending' && approval.approverId === currentUser.id
            );
            
            // ë°•ì„±ë¯¼ì¸ ê²½ìš° ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ ì°¾ê¸°
            if (currentApprovalIndex === -1 && currentUser.name === 'ë°•ì„±ë¯¼') {
                currentApprovalIndex = currentDocument.approvalChain.findIndex(approval => 
                    approval.status === 'pending' && 
                    (approval.approverName === 'ë°•ì„±ë¯¼' || approval.approverName === currentUser.name)
                );
            }

            if (currentApprovalIndex !== -1) {
                // í˜„ì¬ ë‹¨ê³„ ìŠ¹ì¸ ì™„ë£Œ
                currentDocument.approvalChain[currentApprovalIndex].status = 'approved';
                currentDocument.approvalChain[currentApprovalIndex].approvedAt = new Date().toISOString();
                
                // ì„œëª… ì¶”ê°€
                currentDocument.signatures.push({
                    approverId: currentUser.id,
                    approverName: currentUser.name,
                    signature: currentUser.name,
                    approvedAt: new Date().toISOString()
                });

                if (nextApproverId) {
                    // ë‹¤ìŒ ìŠ¹ì¸ìì—ê²Œ ì „ë‹¬
                    const nextEmployee = getEmployee(nextApproverId);
                    currentDocument.approvalChain.push({
                        approverId: nextApproverId,
                        approverName: nextEmployee.name,
                        status: 'pending',
                        level: currentDocument.approvalChain.length + 1,
                        requestedAt: new Date().toISOString()
                    });

                    // ë‹¤ìŒ ìŠ¹ì¸ìì—ê²Œ ì•Œë¦¼
                    createNotification(nextApproverId, {
                        type: 'approval_request',
                        title: 'ê²°ì¬ ì„œë¥˜ ìŠ¹ì¸ ìš”ì²­',
                        message: `${currentUser.name}ë‹˜ì´ ê²°ì¬ ì„œë¥˜ë¥¼ ì „ë‹¬í•˜ì—¬ ê·€í•˜ì˜ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.`,
                        documentId: currentDocument.id,
                        documentType: currentDocument.documentType,
                        requesterId: currentDocument.requesterId,
                        requesterName: currentDocument.requesterName,
                        createdAt: new Date().toISOString()
                    });

                    currentDocument.status = 'pending'; // ì•„ì§ ëŒ€ê¸°ì¤‘
                    alert(`${nextEmployee.name}ë‹˜ì—ê²Œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } else {
                    // ìµœì¢… ìŠ¹ì¸ ì™„ë£Œ
                    currentDocument.status = 'approved';
                    currentDocument.finalApprovedAt = new Date().toISOString();

                    // ì‹ ì²­ìì—ê²Œ ì™„ë£Œ ì•Œë¦¼
                    createNotification(currentDocument.requesterId, {
                        type: 'approval_completed',
                        title: 'ê²°ì¬ ì„œë¥˜ ìŠ¹ì¸ ì™„ë£Œ',
                        message: `ê·€í•˜ê°€ ì‹ ì²­í•œ ${getDocumentTypeName(currentDocument.documentType)}ì´ ìµœì¢… ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                        documentId: currentDocument.id,
                        documentType: currentDocument.documentType,
                        requesterId: currentDocument.requesterId,
                        requesterName: currentDocument.requesterName,
                        createdAt: new Date().toISOString()
                    });

                    alert('ìµœì¢… ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                }

                // í˜„ì¬ ìŠ¹ì¸ìì˜ ì•Œë¦¼ì„ ì½ìŒìœ¼ë¡œ í‘œì‹œ
                markRelatedNotificationsAsRead();
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                updateApprovalRequests();
                
                goBack();
            }
        }

        // ë°˜ë ¤ ì‹¤ì œ ì²˜ë¦¬
        function processRejection(rejectReason) {
            let currentApprovalIndex = currentDocument.approvalChain.findIndex(approval => 
                approval.status === 'pending' && approval.approverId === currentUser.id
            );
            
            // ë°•ì„±ë¯¼ì¸ ê²½ìš° ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ ì°¾ê¸°
            if (currentApprovalIndex === -1 && currentUser.name === 'ë°•ì„±ë¯¼') {
                currentApprovalIndex = currentDocument.approvalChain.findIndex(approval => 
                    approval.status === 'pending' && 
                    (approval.approverName === 'ë°•ì„±ë¯¼' || approval.approverName === currentUser.name)
                );
            }

            if (currentApprovalIndex !== -1) {
                currentDocument.approvalChain[currentApprovalIndex].status = 'rejected';
                currentDocument.approvalChain[currentApprovalIndex].rejectedAt = new Date().toISOString();
                currentDocument.approvalChain[currentApprovalIndex].comment = rejectReason;
                currentDocument.status = 'rejected';

                // ì‹ ì²­ìì—ê²Œ ë°˜ë ¤ ì•Œë¦¼
                createNotification(currentDocument.requesterId, {
                    type: 'approval_rejected',
                    title: 'ê²°ì¬ ì„œë¥˜ ë°˜ë ¤',
                    message: `ê·€í•˜ê°€ ì‹ ì²­í•œ ${getDocumentTypeName(currentDocument.documentType)}ì´ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                    documentId: currentDocument.id,
                    documentType: currentDocument.documentType,
                    requesterId: currentDocument.requesterId,
                    requesterName: currentDocument.requesterName,
                    comment: rejectReason,
                    createdAt: new Date().toISOString()
                });

                // í˜„ì¬ ìŠ¹ì¸ìì˜ ì•Œë¦¼ì„ ì½ìŒìœ¼ë¡œ í‘œì‹œ
                markRelatedNotificationsAsRead();
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                updateApprovalRequests();

                alert('ë¬¸ì„œê°€ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
                goBack();
            }
        }

        // ë‹¤ìŒ ìŠ¹ì¸ìì—ê²Œ ì „ë‹¬ (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        function forwardToNextApprover() {
            console.log('ì´ ê¸°ëŠ¥ì€ ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

        // ë¬¸ì„œ ì‚­ì œ í™•ì¸
        function showDeleteConfirm() {
            if (confirm('ì´ ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë¬¸ì„œëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                deleteDocument();
            }
        }

        // ë¬¸ì„œ ì‚­ì œ
        function deleteDocument() {
            // ìŠ¹ì¸ ìš”ì²­ ëª©ë¡ì—ì„œ ì‚­ì œ
            let approvalRequests = JSON.parse(localStorage.getItem('approvalRequests') || '[]');
            approvalRequests = approvalRequests.filter(doc => doc.id !== currentDocument.id);
            localStorage.setItem('approvalRequests', JSON.stringify(approvalRequests));

            // ê´€ë ¨ëœ ëª¨ë“  ì•Œë¦¼ ì‚­ì œ
            deleteRelatedNotifications();

            alert('ë¬¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            goBack();
        }

        // ê´€ë ¨ ì•Œë¦¼ ì‚­ì œ
        function deleteRelatedNotifications() {
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            
            employees.forEach(employee => {
                let notifications = JSON.parse(localStorage.getItem('notifications_' + employee.id) || '[]');
                notifications = notifications.filter(notification => notification.documentId !== currentDocument.id);
                localStorage.setItem('notifications_' + employee.id, JSON.stringify(notifications));
            });
        }

        // ë‹¤ìŒ ìŠ¹ì¸ì ëª©ë¡ ë¡œë“œ
        function loadNextApprovers() {
            const nextApproverSelect = document.getElementById('nextApprover');
            const availableApprovers = getAvailableApprovers();
            
            nextApproverSelect.innerHTML = '<option value="">ë‹¤ìŒ ìŠ¹ì¸ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>';
            
            // CEOì¸ì§€ í™•ì¸ (company_admin ì—­í• ì´ê±°ë‚˜ ì´ë¯¸ ìµœê³  ì§ê¸‰ì¸ ê²½ìš°)
            const isCEO = currentUser.role === 'company_admin' || isHighestRank(currentUser);
            
            if (!isCEO && availableApprovers.length > 0) {
                document.getElementById('nextApproverSection').style.display = 'block';
                
                // ì§ê¸‰ ìˆœì„œë¡œ ì •ë ¬ (ë†’ì€ ì§ê¸‰ë¶€í„°)
                const sortedApprovers = sortApproversByRank(availableApprovers);
                
                sortedApprovers.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.name} (${employee.position || 'ì§ê¸‰ ë¯¸ì„¤ì •'}) - ${employee.department || 'ë¶€ì„œ ë¯¸ì„¤ì •'}`;
                    nextApproverSelect.appendChild(option);
                });
                
                // CEOê°€ ìˆë‹¤ë©´ ë§ˆì§€ë§‰ì— ì¶”ê°€
                const ceo = availableApprovers.find(emp => emp.role === 'company_admin');
                if (ceo && !sortedApprovers.includes(ceo)) {
                    const option = document.createElement('option');
                    option.value = ceo.id;
                    option.textContent = `${ceo.name} (${ceo.position || 'ëŒ€í‘œì´ì‚¬'}) - ìµœì¢… ìŠ¹ì¸`;
                    nextApproverSelect.appendChild(option);
                }
            } else {
                document.getElementById('nextApproverSection').style.display = 'none';
            }
        }

        // ì§ê¸‰ ìˆœì„œ ì •ì˜
        function getRankOrder(position) {
            const ranks = {
                'ëŒ€í‘œì´ì‚¬': 1,
                'ì „ë¬´': 2,
                'ìƒë¬´': 3,
                'ì´ì‚¬': 4,
                'ë¶€ì¥': 5,
                'ì°¨ì¥': 6,
                'ê³¼ì¥': 7,
                'ëŒ€ë¦¬': 8,
                'ì£¼ì„': 9,
                'ì‚¬ì›': 10
            };
            return ranks[position] || 11;
        }

        // ìµœê³  ì§ê¸‰ì¸ì§€ í™•ì¸
        function isHighestRank(user) {
            const userRankOrder = getRankOrder(user.position);
            return userRankOrder <= 2; // ëŒ€í‘œì´ì‚¬, ì „ë¬´ê¸‰ ì´ìƒ
        }

        // ìŠ¹ì¸ìë¥¼ ì§ê¸‰ ìˆœìœ¼ë¡œ ì •ë ¬
        function sortApproversByRank(approvers) {
            return approvers
                .filter(emp => emp.role !== 'company_admin') // CEO ì œì™¸
                .sort((a, b) => getRankOrder(a.position) - getRankOrder(b.position));
        }

        // ë¬¸ì„œ ìŠ¹ì¸
        function approveDocument() {
            const signature = document.getElementById('signature').value.trim();
            const comment = document.getElementById('comment').value.trim();
            const nextApprover = document.getElementById('nextApprover').value;

            if (!signature) {
                alert('ì „ì ì„œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const isCEO = currentUser.role === 'company_admin';
            const needsNextApprover = !isCEO && document.getElementById('nextApproverSection').style.display !== 'none';

            if (needsNextApprover && !nextApprover) {
                alert('ë‹¤ìŒ ìŠ¹ì¸ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // í˜„ì¬ ìŠ¹ì¸ ë‹¨ê³„ ì™„ë£Œ ì²˜ë¦¬
            const currentApprovalIndex = currentDocument.approvalChain.findIndex(approval => 
                approval.status === 'pending' && approval.approverId === currentUser.id
            );

            if (currentApprovalIndex !== -1) {
                currentDocument.approvalChain[currentApprovalIndex].status = 'approved';
                currentDocument.approvalChain[currentApprovalIndex].approvedAt = new Date().toISOString();
                currentDocument.approvalChain[currentApprovalIndex].comment = comment;
            }

            // ì„œëª… ì¶”ê°€
            currentDocument.signatures.push({
                approverId: currentUser.id,
                approverName: currentUser.name,
                signature: signature,
                comment: comment,
                approvedAt: new Date().toISOString()
            });

            // ë‹¤ìŒ ìŠ¹ì¸ìê°€ ìˆëŠ” ê²½ìš° ìŠ¹ì¸ ì²´ì¸ì— ì¶”ê°€
            if (nextApprover) {
                const nextEmployee = getEmployee(nextApprover);
                currentDocument.approvalChain.push({
                    approverId: nextApprover,
                    approverName: nextEmployee.name,
                    status: 'pending',
                    level: currentDocument.approvalChain.length + 1,
                    requestedAt: new Date().toISOString()
                });

                // ë‹¤ìŒ ìŠ¹ì¸ìì—ê²Œ ì•Œë¦¼ ìƒì„±
                createNotification(nextApprover, {
                    type: 'approval_request',
                    title: 'ê²°ì¬ ì„œë¥˜ ìŠ¹ì¸ ìš”ì²­',
                    message: `${currentUser.name}ë‹˜ì´ ê²°ì¬ ì„œë¥˜ë¥¼ ìŠ¹ì¸í•˜ì—¬ ê·€í•˜ì˜ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.`,
                    documentId: currentDocument.id,
                    documentType: currentDocument.documentType,
                    requesterId: currentDocument.requesterId,
                    requesterName: currentDocument.requesterName,
                    createdAt: new Date().toISOString()
                });

                currentDocument.status = 'pending';
            } else {
                // ìµœì¢… ìŠ¹ì¸ ì™„ë£Œ
                currentDocument.status = 'approved';
                currentDocument.finalApprovedAt = new Date().toISOString();

                // ì‹ ì²­ìì—ê²Œ ì™„ë£Œ ì•Œë¦¼
                createNotification(currentDocument.requesterId, {
                    type: 'approval_completed',
                    title: 'ê²°ì¬ ì„œë¥˜ ìŠ¹ì¸ ì™„ë£Œ',
                    message: `ê·€í•˜ê°€ ì‹ ì²­í•œ ${getDocumentTypeName(currentDocument.documentType)}ì´ ìµœì¢… ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                    documentId: currentDocument.id,
                    documentType: currentDocument.documentType,
                    requesterId: currentDocument.requesterId,
                    requesterName: currentDocument.requesterName,
                    createdAt: new Date().toISOString()
                });
            }

            // í˜„ì¬ ìŠ¹ì¸ìì˜ ì•Œë¦¼ì„ ì½ìŒìœ¼ë¡œ í‘œì‹œ
            markRelatedNotificationsAsRead();

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
            updateApprovalRequests();

            alert(nextApprover ? 'ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ìŠ¹ì¸ìì—ê²Œ ì „ë‹¬ë©ë‹ˆë‹¤.' : 'ìµœì¢… ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            goBack();
        }

        // ë¬¸ì„œ ë°˜ë ¤
        function rejectDocument() {
            const comment = document.getElementById('comment').value.trim();

            if (!comment) {
                alert('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // í˜„ì¬ ìŠ¹ì¸ ë‹¨ê³„ ë°˜ë ¤ ì²˜ë¦¬
            const currentApprovalIndex = currentDocument.approvalChain.findIndex(approval => 
                approval.status === 'pending' && approval.approverId === currentUser.id
            );

            if (currentApprovalIndex !== -1) {
                currentDocument.approvalChain[currentApprovalIndex].status = 'rejected';
                currentDocument.approvalChain[currentApprovalIndex].rejectedAt = new Date().toISOString();
                currentDocument.approvalChain[currentApprovalIndex].comment = comment;
            }

            currentDocument.status = 'rejected';

            // ì‹ ì²­ìì—ê²Œ ë°˜ë ¤ ì•Œë¦¼
            createNotification(currentDocument.requesterId, {
                type: 'approval_rejected',
                title: 'ê²°ì¬ ì„œë¥˜ ë°˜ë ¤',
                message: `ê·€í•˜ê°€ ì‹ ì²­í•œ ${getDocumentTypeName(currentDocument.documentType)}ì´ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                documentId: currentDocument.id,
                documentType: currentDocument.documentType,
                requesterId: currentDocument.requesterId,
                requesterName: currentDocument.requesterName,
                comment: comment,
                createdAt: new Date().toISOString()
            });

            // í˜„ì¬ ìŠ¹ì¸ìì˜ ì•Œë¦¼ì„ ì½ìŒìœ¼ë¡œ í‘œì‹œ
            markRelatedNotificationsAsRead();

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
            updateApprovalRequests();

            alert('ë¬¸ì„œê°€ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
            goBack();
        }

        // ê´€ë ¨ ì•Œë¦¼ì„ ì½ìŒìœ¼ë¡œ í‘œì‹œ
        function markRelatedNotificationsAsRead() {
            try {
                // ë‹¤ì–‘í•œ ì‚¬ìš©ì ID í˜•ì‹ìœ¼ë¡œ ì•Œë¦¼ ì°¾ê¸°
                const possibleIds = [currentUser.id, currentUser.email, currentUser.name];
                let userNotifications = [];
                let foundUserId = null;
                
                for (const id of possibleIds) {
                    if (id) {
                        const notifications = JSON.parse(localStorage.getItem('notifications_' + id) || '[]');
                        if (notifications.length > 0) {
                            userNotifications = notifications;
                            foundUserId = id;
                            break;
                        }
                    }
                }
                
                // employees ëª©ë¡ì—ì„œ ì‚¬ìš©ì ID ì°¾ê¸°
                if (!foundUserId) {
                    const employees = JSON.parse(localStorage.getItem('employees') || '[]');
                    const employee = employees.find(emp => 
                        emp.name === currentUser.name || 
                        emp.email === currentUser.email ||
                        emp.id === currentUser.id
                    );
                    
                    if (employee && employee.id) {
                        userNotifications = JSON.parse(localStorage.getItem('notifications_' + employee.id) || '[]');
                        foundUserId = employee.id;
                    }
                }
                
                if (foundUserId && userNotifications.length > 0) {
                    // í˜„ì¬ ë¬¸ì„œì™€ ê´€ë ¨ëœ ì•Œë¦¼ì„ ì°¾ì•„ì„œ ì½ìŒìœ¼ë¡œ í‘œì‹œ
                    let updated = false;
                    userNotifications.forEach(notification => {
                        if (notification.documentId === currentDocument.id && 
                            notification.type === 'approval_request' && 
                            !notification.read) {
                            notification.read = true;
                            updated = true;
                        }
                    });
                    
                    if (updated) {
                        localStorage.setItem('notifications_' + foundUserId, JSON.stringify(userNotifications));
                        console.log('ğŸ”” ê´€ë ¨ ì•Œë¦¼ì´ ì½ìŒìœ¼ë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                }
            } catch (error) {
                console.error('ì•Œë¦¼ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ìŠ¹ì¸ ìš”ì²­ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateApprovalRequests() {
            const approvalRequests = JSON.parse(localStorage.getItem('approvalRequests') || '[]');
            const index = approvalRequests.findIndex(doc => doc.id === currentDocument.id);
            if (index !== -1) {
                approvalRequests[index] = currentDocument;
                localStorage.setItem('approvalRequests', JSON.stringify(approvalRequests));
            }
        }

        // ì•Œë¦¼ ìƒì„±
        function createNotification(userId, notification) {
            const notifications = JSON.parse(localStorage.getItem('notifications_' + userId) || '[]');
            notification.id = Date.now().toString();
            notification.read = false;
            notifications.unshift(notification);
            localStorage.setItem('notifications_' + userId, JSON.stringify(notifications));
        }

        // ë¬¸ì„œ íƒ€ì… ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        function getDocumentTypeName(type) {
            const names = {
                'career': 'ê²½ë ¥ì¦ëª…ì„œ',
                'employment': 'ì¬ì§ì¦ëª…ì„œ',
                'leave': 'ì—°ì°¨ì‹ ì²­ì„œ',
                'resignation': 'ì‚¬ì§ì„œ',
                'incident': 'ê²½ìœ„ì„œ',
                'businessTrip': 'ì¶œì¥ ë³´ê³ ì„œ',
                'proposal': 'ê¸°ì•ˆì„œ'
            };
            return names[type] || 'ë¬¸ì„œ';
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
        }

        // ë’¤ë¡œê°€ê¸°
        function goBack() {
            window.history.back();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¬¸ì„œ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ë¬¸ì„œ ë¡œë”© ì‹œì‘...');
            
            // í…ŒìŠ¤íŠ¸ìš© ë¬¸ì„œ ìƒì„± (ë¬¸ì„œê°€ ì—†ëŠ” ê²½ìš°)
            const documentId = getDocumentId();
            if (documentId === '1751108766816') {
                console.log('ğŸ§ª í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ID ê°ì§€, ìƒ˜í”Œ ë¬¸ì„œ ìƒì„±...');
                createTestDocument();
            }
            
            loadDocument();
        });
        
        // í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ìƒì„±
        function createTestDocument() {
            const approvalRequests = JSON.parse(localStorage.getItem('approvalRequests') || '[]');
            let existingDoc = approvalRequests.find(doc => doc.id === '1751108766816');
            
            // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const currentUser = getCurrentUser();
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            
            console.log('ğŸ‘¤ í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì:', currentUser);
            console.log('ğŸ‘¥ ì „ì²´ ì§ì› ëª©ë¡:', employees);
            
            // ë°•ì„±ë¯¼ ì§ì› ì •ë³´ ì°¾ê¸°
            let parkSeongMin = employees.find(emp => 
                emp.name === 'ë°•ì„±ë¯¼' || 
                emp.name === 'Park Seong Min' ||
                emp.email === 'parkseongmin@company.com'
            );
            
            // ë°•ì„±ë¯¼ì´ ì—†ìœ¼ë©´ í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ìë¥¼ ì‚¬ìš©
            if (!parkSeongMin && currentUser) {
                parkSeongMin = currentUser;
                console.log('ğŸ”„ ë°•ì„±ë¯¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ í˜„ì¬ ì‚¬ìš©ìë¥¼ ì‚¬ìš©:', parkSeongMin);
            }
            
            if (!existingDoc && parkSeongMin) {
                console.log('ğŸ“ í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ìƒì„± ì¤‘...');
                const testDocument = {
                    id: '1751108766816',
                    documentType: 'employment',
                    requesterId: 'requester123',
                    requesterName: 'ë°•ì¤€í˜¸',
                    employeeName: 'ë°•ì¤€í˜¸',
                    employeeId: 'EMP001',
                    department: 'ê°œë°œíŒ€',
                    position: 'ëŒ€ë¦¬',
                    purpose: 'ì€í–‰ ëŒ€ì¶œìš©',
                    status: 'pending',
                    approvalChain: [{
                        approverId: parkSeongMin.id,
                        approverName: parkSeongMin.name,
                        status: 'pending',
                        level: 1,
                        requestedAt: new Date().toISOString()
                    }],
                    signatures: [],
                    createdAt: new Date().toISOString()
                };
                
                approvalRequests.unshift(testDocument);
                localStorage.setItem('approvalRequests', JSON.stringify(approvalRequests));
                console.log('âœ… í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ìƒì„± ì™„ë£Œ - ìŠ¹ì¸ì:', parkSeongMin.name, 'ID:', parkSeongMin.id);
            } else if (existingDoc) {
                // ê¸°ì¡´ ë¬¸ì„œê°€ ìˆìœ¼ë©´ ìŠ¹ì¸ì ì •ë³´ ì—…ë°ì´íŠ¸
                if (parkSeongMin && existingDoc.approvalChain[0]) {
                    existingDoc.approvalChain[0].approverId = parkSeongMin.id;
                    existingDoc.approvalChain[0].approverName = parkSeongMin.name;
                    
                    // ì—…ë°ì´íŠ¸ëœ ë¬¸ì„œ ì €ì¥
                    const index = approvalRequests.findIndex(doc => doc.id === '1751108766816');
                    if (index !== -1) {
                        approvalRequests[index] = existingDoc;
                        localStorage.setItem('approvalRequests', JSON.stringify(approvalRequests));
                        console.log('ğŸ”„ ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ì—…ë°ì´íŠ¸ - ìŠ¹ì¸ì:', parkSeongMin.name, 'ID:', parkSeongMin.id);
                    }
                }
            }
        }
    </script>
</body>
</html>