<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">ë‚¨ê²½ìŠ¤í‹¸(ì£¼) ì—…ë¬´ë³´ë“œ</title>
    
    <!-- Favicons -->
    <link href="../../logo.jpg" rel="icon">
    <link href="../../logo.jpg" rel="apple-touch-icon">
    
    <link rel="stylesheet" href="../../shared-assets/css/main.css">
    <link rel="stylesheet" href="../../shared-assets/css/platform.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Database Scripts -->
    <script src="database.js"></script>
    <script src="database-service.js"></script>
    <script src="database-migration.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f5f7fa;
            min-height: 100vh;
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .dashboard-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .welcome-section h1 {
            font-size: 2rem;
            margin: 0 0 0.5rem 0;
            font-weight: 600;
        }
        
        .welcome-section p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
        }
        
        .header-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .header-btn:hover {
            background: white;
            color: #667eea;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .logout-btn:hover {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        
        /* ë©”ì¸ ì½˜í…ì¸  */
        .dashboard-content {
            max-width: 1200px;
            margin: 3rem auto;
            padding: 0 2rem;
        }
        
        /* ë©”ë‰´ ê·¸ë¦¬ë“œ */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .menu-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .menu-card:hover::before {
            transform: translateY(0);
        }
        
        .menu-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            color: white;
        }
        
        .menu-card h3 {
            font-size: 1.25rem;
            margin: 0 0 0.75rem 0;
            color: #333;
        }
        
        .menu-card p {
            color: #666;
            line-height: 1.6;
            margin: 0;
        }
        
        /* ë¹ ë¥¸ í†µê³„ */
        .stats-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 3rem;
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .stats-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-item:hover .stat-value {
            -webkit-text-fill-color: white;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .stat-item:hover .stat-label {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* ìµœê·¼ í™œë™ */
        .activity-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .activity-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }
        
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .activity-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .activity-time {
            font-size: 0.875rem;
            color: #666;
        }
        
        /* ì•Œë¦¼ ë°°ì§€ */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        
        /* í—¤ë” ì•Œë¦¼ ë°°ì§€ */
        .notification-badge-header {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                text-align: center;
                gap: 1.5rem;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
    </div>
    
    <!-- í—¤ë” -->
    <header class="dashboard-header">
        <div class="header-container">
            <div class="welcome-section">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="user-profile-dashboard" onclick="showProfileModal()" style="cursor: pointer;">
                        <img id="profileImageDashboard" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIyNSIgeT0iMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPu2yqTwvc3ZnPgo8L3N2Zz4=" alt="í”„ë¡œí•„" style="width: 50px !important; height: 50px !important; min-width: 50px; min-height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; transition: all 0.3s ease; object-fit: cover; display: block;" />
                    </div>
                    <div>
                        <h1><span id="userName">ì‚¬ìš©ì</span>ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!</h1>
                        <p id="userInfo">ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <a href="#" class="header-btn" onclick="goToHomepage()">
                    <i class="fas fa-home"></i> í™ˆí˜ì´ì§€
                </a>
                <button class="header-btn" id="approvalNotificationBtn" onclick="openApprovalNotifications()" style="position: relative;">
                    <i class="fas fa-bell"></i> ì•Œë¦¼
                    <span id="approvalNotificationBadgeHeader" class="notification-badge-header" style="display: none;">0</span>
                </button>
                <button class="header-btn" id="settingsBtn" onclick="goToSettings()">
                    <i class="fas fa-cog"></i> ì„¤ì •
                </button>
                <button class="header-btn logout-btn" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>
    </header>
    
    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="dashboard-content">
        <!-- ë©”ë‰´ ê·¸ë¦¬ë“œ -->
        <div class="menu-grid">
            <div class="menu-card" onclick="openWorkLog()">
                <div class="menu-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <h3>ì—…ë¬´ì¼ì§€</h3>
                <p>ì˜¤ëŠ˜ì˜ ì—…ë¬´ ë‚´ìš©ì„ ê¸°ë¡í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”. í”„ë¡œì íŠ¸ë³„ ì§„í–‰ìƒí™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            <div class="menu-card" id="clientListCard" onclick="openClientList()">
                <div class="menu-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3>ê±°ë˜ì²˜ëª©ë¡</h3>
                <p>ê±°ë˜ì²˜ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”. ì—°ë½ì²˜ì™€ ê±°ë˜ ì´ë ¥ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            <div class="menu-card" onclick="openCorporateCard()">
                <div class="menu-icon" style="position: relative;">
                    <i class="fas fa-credit-card"></i>
                    <span id="cardNotificationBadge" class="notification-badge" style="display: none;">0</span>
                </div>
                <h3>ë²•ì¸ì¹´ë“œ ì‚¬ìš©</h3>
                <p>ë²•ì¸ì¹´ë“œ ì‚¬ìš© ë‚´ì—­ì„ ë“±ë¡í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”. ê²½ë¹„ ì²˜ë¦¬ í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            <!-- ìŠ¹ì¸ ì•Œë¦¼ ì¹´ë“œëŠ” í—¤ë” ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´ë˜ì–´ ìˆ¨ê¹€ ì²˜ë¦¬
            <div class="menu-card" onclick="openApprovalNotifications()" style="display: none;">
                <div class="menu-icon" style="position: relative; background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                    <i class="fas fa-bell"></i>
                    <span id="approvalNotificationBadge" class="notification-badge" style="display: none;">0</span>
                </div>
                <h3>ìŠ¹ì¸ ì•Œë¦¼</h3>
                <p>ê²°ì¬ ì„œë¥˜ ìŠ¹ì¸ ìš”ì²­ê³¼ ì•Œë¦¼ì„ í™•ì¸í•˜ì„¸ìš”. ëŒ€ê¸° ì¤‘ì¸ ìŠ¹ì¸ ê±´ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            -->
            
            <!-- ì¬ê³ ê´€ë¦¬ ì¹´ë“œëŠ” ê¸°ëŠ¥ ë¯¸êµ¬í˜„ìœ¼ë¡œ ìˆ¨ê¹€ ì²˜ë¦¬
            <div class="menu-card" onclick="openInventoryManagement()">
                <div class="menu-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                    <i class="fas fa-boxes"></i>
                </div>
                <h3>ì¬ê³ ê´€ë¦¬</h3>
                <p>ì¬ê³  í˜„í™©ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”. ì…ì¶œê³  ë‚´ì—­ê³¼ ì¬ê³  ìˆ˜ì¤€ì„ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            -->
            
            <div class="menu-card" onclick="openDocuments()">
                <div class="menu-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <h3>ê²°ì œ ì„œë¥˜</h3>
                <p>ì‚¬ì§ì„œ, ê²½ìœ„ì„œ, ì¬ì§ì¦ëª…ì„œ ë“± ê°ì¢… ê²°ì¬ ì„œë¥˜ë¥¼ ì‘ì„±í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”.</p>
            </div>
        </div>
        
        <!-- ë¹ ë¥¸ í†µê³„ -->
        <div class="stats-section">
            <div class="stats-header">
                <h2>ì´ë²ˆ ë‹¬ í˜„í™©</h2>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="workLogCount">0</div>
                    <div class="stat-label">ì‘ì„±í•œ ì—…ë¬´ì¼ì§€</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="projectCount">0</div>
                    <div class="stat-label">ì§„í–‰ì¤‘ì¸ í”„ë¡œì íŠ¸</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cardUsageCount">0</div>
                    <div class="stat-label">ë²•ì¸ì¹´ë“œ ì‚¬ìš©</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="clientCount">0</div>
                    <div class="stat-label">ê´€ë¦¬ ê±°ë˜ì²˜</div>
                </div>
            </div>
        </div>
        
        <!-- ìµœê·¼ í™œë™ -->
        <div class="activity-section">
            <div class="activity-header">
                <h2>ìµœê·¼ í™œë™</h2>
            </div>
            <div class="activity-list" id="activityList">
                <!-- ìµœê·¼ í™œë™ í•­ëª©ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </main>
    
    <script src="../../shared-assets/js/auth.js"></script>
    <script>
        // ê¸°ë³¸ ì•„ë°”íƒ€ ìƒì„± í•¨ìˆ˜
        function generateDefaultAvatar(name) {
            const initial = name ? name.charAt(0).toUpperCase() : 'U';
            // í•œê¸€ì´ë‚˜ íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬ë¥¼ ìœ„í•´ ì˜ë¬¸ìë§Œ ì‚¬ìš©
            const safeInitial = /^[A-Za-z]/.test(initial) ? initial : 'U';
            
            // btoa ëŒ€ì‹  ì§ì ‘ SVG URL ìƒì„±
            const svgContent = `<svg width="50" height="50" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
                <circle cx="25" cy="25" r="25" fill="#667eea"/>
                <text x="25" y="32" font-family="Arial, sans-serif" font-size="20" fill="white" text-anchor="middle" dominant-baseline="central">${safeInitial}</text>
            </svg>`;
            
            return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgContent)}`;
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        document.addEventListener('DOMContentLoaded', function() {
            const user = AuthManager.getCurrentUser();
            if (!user) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'index.html';
                return;
            }
            
            // ì‚¬ìš©ìë³„ í™˜ì˜ ë©”ì‹œì§€ ì„¤ì •
            let welcomeMessage = '';
            let infoText = '';
            
            switch(user.role) {
                case 'master':
                    welcomeMessage = user.name || 'ë§ˆìŠ¤í„°'; // ë§ˆìŠ¤í„°
                    infoText = 'ë§ˆìŠ¤í„° ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•˜ì…¨ìŠµë‹ˆë‹¤.';
                    break;
                case 'master_admin':
                    welcomeMessage = user.name || 'ì‹œìŠ¤í…œ ê´€ë¦¬ì';
                    infoText = 'ì‹œìŠ¤í…œ ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•˜ì…¨ìŠµë‹ˆë‹¤.';
                    break;
                case 'company_admin':
                    if (user.name === 'ê³ ê°•ì„') {
                        welcomeMessage = 'ê³ ê°•ì„ ëŒ€í‘œ';
                    } else {
                        welcomeMessage = user.name + ' ëŒ€í‘œ';
                    }
                    infoText = `${user.position || 'ëŒ€í‘œì´ì‚¬'} Â· ${user.company || 'íšŒì‚¬ëª…'}`;
                    break;
                case 'company_manager':
                    if (user.name === 'ì´ì›ì„') {
                        welcomeMessage = 'ì´ì›ì„ ê´€ë¦¬ì';
                    } else {
                        welcomeMessage = user.name + ' ê´€ë¦¬ì';
                    }
                    infoText = `${user.position || 'ê´€ë¦¬ì'} Â· ${user.company || 'íšŒì‚¬ëª…'}`;
                    break;
                case 'employee':
                    if (user.name === 'ì´ì˜í¬') {
                        welcomeMessage = 'ì´ì˜í¬';
                    } else {
                        welcomeMessage = user.name;
                    }
                    infoText = `${user.department || 'ë¶€ì„œ'} Â· ${user.position || 'ì§ê¸‰'}`;
                    break;
                default:
                    welcomeMessage = user.name;
                    infoText = 'í™˜ì˜í•©ë‹ˆë‹¤.';
            }
            
            document.getElementById('userName').textContent = welcomeMessage;
            document.getElementById('userInfo').textContent = infoText;
            
            // í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì •
            const profileImage = user.profileImage || user.profile_image || generateDefaultAvatar(user.name || 'User');
            const dashboardImage = document.getElementById('profileImageDashboard');
            if (dashboardImage) {
                dashboardImage.src = profileImage;
            }
            
            // íšŒì‚¬ëª…ì„ ë‚¨ê²½ìŠ¤í‹¸(ì£¼)ë¡œ í•˜ë“œì½”ë”©
            document.getElementById('pageTitle').textContent = 'ë‚¨ê²½ìŠ¤í‹¸(ì£¼) ì—…ë¬´ë³´ë“œ';
            document.title = 'ë‚¨ê²½ìŠ¤í‹¸(ì£¼) ì—…ë¬´ë³´ë“œ';
            
            
            // ì§ì›ì˜ ê²½ìš° ì„¤ì • ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            if (user.role === 'employee') {
                document.getElementById('settingsBtn').style.display = 'none';
            }
            
            // ì§ì›ì´ë‚˜ í™ˆí˜ì´ì§€ ê´€ë¦¬ìì˜ ê²½ìš° ê±°ë˜ì²˜ëª©ë¡ ìˆ¨ê¸°ê¸°
            if (user.role === 'employee' || user.role === 'company_manager') {
                const clientListCard = document.getElementById('clientListCard');
                if (clientListCard) {
                    clientListCard.style.display = 'none';
                }
            }
            
            // ì§ì›ë³„ ë©”ë‰´ ê¶Œí•œ ì ìš©
            applyMenuPermissions(user);
            
            // ë™ì  í†µê³„ ë° í™œë™ ë¡œë“œ
            loadUserStatistics(user);
            loadRecentActivities(user);
            
            // ì•Œë¦¼ ì²´í¬
            checkNotifications(user);
            checkApprovalNotifications(user);
        });
        
        // ë©”ë‰´ ê¸°ëŠ¥ë“¤
        
        function openWorkLog() {
            showLoading();
            setTimeout(() => {
                // ì—…ë¬´ì¼ì§€ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = 'worklog.html';
            }, 500);
        }
        
        function openClientList() {
            showLoading();
            setTimeout(() => {
                // steel-business-appì˜ ê±°ë˜ì²˜ ëª©ë¡ìœ¼ë¡œ ì´ë™
                window.location.href = 'company-list.html';
            }, 500);
        }
        
        function openCorporateCard() {
            showLoading();
            setTimeout(() => {
                window.location.href = 'corporate-card.html';
            }, 500);
        }
        
        function openDocuments() {
            showLoading();
            setTimeout(() => {
                window.location.href = 'documents.html';
            }, 500);
        }
        
        function openApprovalNotifications() {
            showLoading();
            setTimeout(() => {
                window.location.href = 'notifications.html';
            }, 500);
        }
        
        function openInventoryManagement() {
            showLoading();
            setTimeout(() => {
                alert('ì¬ê³ ê´€ë¦¬ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
                hideLoading();
            }, 500);
        }
        
        function openReports() {
            showLoading();
            setTimeout(() => {
                alert('ë³´ê³ ì„œ ì‘ì„± ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
                hideLoading();
            }, 500);
        }
        
        // í™ˆí˜ì´ì§€ë¡œ ì´ë™ (ë¡œê·¸ì¸ ì „ ìƒíƒœ)
        function goToHomepage() {
            // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (ì„¸ì…˜ ì •ë³´ëŠ” ìœ ì§€í•˜ë˜ ë¡œê·¸ì¸ ì „ í™”ë©´ìœ¼ë¡œ)
            const templateId = localStorage.getItem('currentTemplateId');
            if (templateId) {
                // ì €ì¥ëœ í…œí”Œë¦¿ìœ¼ë¡œ ì´ë™
                window.location.href = 'index.html';
            } else {
                // ê¸°ë³¸ í”Œë«í¼ í™ˆí˜ì´ì§€ë¡œ ì´ë™
                window.location.href = 'index.html';
            }
        }
        
        // ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™
        function goToSettings() {
            showLoading();
            setTimeout(() => {
                window.location.href = 'admin-dashboard.html';
            }, 500);
        }
        
        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        function handleLogout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì˜ ì‚¬ìš©ì ì •ë³´ ì‚­ì œ
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userRole');
                localStorage.removeItem('currentTemplateId');
                
                // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ë„ ì‚­ì œ
                sessionStorage.clear();
                
                // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = 'index.html';
            }
        }
        
        // ì§ì›ë³„ ë©”ë‰´ ê¶Œí•œ ì ìš© (ìƒˆë¡œìš´ ê¶Œí•œ ì‹œìŠ¤í…œ)
        function applyMenuPermissions(user) {
            // ê´€ë¦¬ì ê¶Œí•œì´ ìˆìœ¼ë©´ ëª¨ë“  ë©”ë‰´ í‘œì‹œ
            if (user.role === 'master_admin' || user.role === 'company_admin' || user.role === 'company_manager') {
                const menuCards = document.querySelectorAll('.menu-card');
                menuCards.forEach(card => {
                    card.style.display = 'block';
                });
                
                console.log('âœ… ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ëª¨ë“  ë©”ë‰´ í‘œì‹œ:', {
                    user: user.name,
                    role: user.role,
                    department: user.department,
                    position: user.position
                });
                return;
            }
            
            // ì¼ë°˜ ì§ì›ì˜ ê²½ìš° ê¶Œí•œ ì‹œìŠ¤í…œ ì ìš©
            const menuCards = document.querySelectorAll('.menu-card');
            menuCards.forEach(card => {
                card.style.display = 'none';
            });
            
            // ìƒˆë¡œìš´ ê¶Œí•œ ì‹œìŠ¤í…œì—ì„œ ê¶Œí•œ í™•ì¸
            const permissions = JSON.parse(localStorage.getItem('menuPermissions') || '{}');
            
            // ê° ë©”ë‰´ì— ëŒ€í•´ ê¶Œí•œ í™•ì¸
            const menuMappings = {
                'worklog': 'ì—…ë¬´ì¼ì§€',
                'corporate-card': 'ë²•ì¸ì¹´ë“œ ì‚¬ìš©',
                'documents': 'ê²°ì œ ì„œë¥˜'
            };
            
            Object.keys(menuMappings).forEach(menuId => {
                if (checkMenuPermission(menuId, user, permissions)) {
                    showMenuCard(menuMappings[menuId]);
                }
            });
            
            console.log('âœ… ê¶Œí•œ í™•ì¸ ì™„ë£Œ:', {
                user: user.name,
                role: user.role,
                department: user.department,
                position: user.position,
                permissions: permissions
            });
            
            // ê° ë©”ë‰´ì˜ ê¶Œí•œ í™•ì¸ ê²°ê³¼ ìš”ì•½
            console.log('ğŸ“Š ë©”ë‰´ë³„ ê¶Œí•œ í™•ì¸ ê²°ê³¼:');
            Object.keys(menuMappings).forEach(menuId => {
                const hasPermission = checkMenuPermission(menuId, user, permissions);
                console.log(`  ${menuMappings[menuId]}: ${hasPermission ? 'âœ… í—ˆìš©' : 'âŒ ê±°ë¶€'}`);
            });
        }
        
        // ë©”ë‰´ë³„ ê¶Œí•œ í™•ì¸ í•¨ìˆ˜
        function checkMenuPermission(menuId, user, permissions) {
            console.log(`ğŸ” ê¶Œí•œ í™•ì¸ ì¤‘: ${menuId}`, {
                user: user.name,
                department: user.department,
                position: user.position,
                userId: user.id,
                role: user.role
            });
            
            // ëŒ€í‘œì´ì‚¬ëŠ” ëª¨ë“  ê¶Œí•œ í—ˆìš©
            if (user.role === 'company_admin' && user.position === 'ëŒ€í‘œì´ì‚¬') {
                console.log(`âœ… ${menuId}: ëŒ€í‘œì´ì‚¬ ê¶Œí•œìœ¼ë¡œ í—ˆìš©`);
                return true;
            }
            
            // ê¶Œí•œ ì„¤ì •ì´ ì—†ìœ¼ë©´ ê±°ë¶€ (ê¸°ë³¸ ê¶Œí•œì€ íŠ¹ë³„í•œ ê²½ìš°ì—ë§Œ ì ìš©)
            if (!permissions[menuId]) {
                console.log(`ğŸ“ ${menuId}: ê¶Œí•œ ì„¤ì • ì—†ìŒ, ì ‘ê·¼ ê±°ë¶€`);
                return false;
            }
            
            const menuPermission = permissions[menuId];
            console.log(`ğŸ“‹ ${menuId} ê¶Œí•œ ì„¤ì •:`, menuPermission);
            
            // OR ì¡°ê±´: ê°œì¸ë³„, ë¶€ì„œë³„, ì§ê¸‰ë³„ ì¤‘ í•˜ë‚˜ë¼ë„ ê¶Œí•œì´ ìˆìœ¼ë©´ í—ˆìš©
            
            // 1. ê°œì¸ë³„ ê¶Œí•œ í™•ì¸ (ìƒˆë¡œìš´ êµ¬ì¡°)
            if (menuPermission.individuals && menuPermission.individuals[user.id]) {
                console.log(`âœ… ${menuId}: ê°œì¸ë³„ ê¶Œí•œìœ¼ë¡œ í—ˆìš©`);
                return true;
            }
            
            // 2. ë¶€ì„œë³„ ê¶Œí•œ í™•ì¸ (ìƒˆë¡œìš´ êµ¬ì¡°)
            if (user.department && menuPermission.departments) {
                // ì •í™•í•œ ë§¤ì¹­ í™•ì¸
                if (menuPermission.departments[user.department]) {
                    console.log(`âœ… ${menuId}: ë¶€ì„œë³„ ê¶Œí•œìœ¼ë¡œ í—ˆìš© (ì •í™•ë§¤ì¹­: ${user.department})`);
                    return true;
                }
                
                // ìœ ì‚¬í•œ ë¶€ì„œëª… í™•ì¸ (ì˜ì—…íŒ€ <-> ì˜ì—…ë¶€)
                const userDeptNormalized = user.department.replace(/íŒ€|ë¶€/, '');
                const hasMatchingDept = Object.keys(menuPermission.departments).some(dept => {
                    if (!menuPermission.departments[dept]) return false;
                    const deptNormalized = dept.replace(/íŒ€|ë¶€/, '');
                    return userDeptNormalized === deptNormalized;
                });
                
                if (hasMatchingDept) {
                    console.log(`âœ… ${menuId}: ë¶€ì„œë³„ ê¶Œí•œìœ¼ë¡œ í—ˆìš© (ìœ ì‚¬ë§¤ì¹­: ${user.department})`);
                    return true;
                }
            }
            
            // 3. ì§ê¸‰ë³„ ê¶Œí•œ í™•ì¸ (ìƒˆë¡œìš´ êµ¬ì¡°)
            if (user.position && menuPermission.positions && menuPermission.positions[user.position]) {
                console.log(`âœ… ${menuId}: ì§ê¸‰ë³„ ê¶Œí•œìœ¼ë¡œ í—ˆìš© (${user.position})`);
                return true;
            }
            
            // 4. ì–´ë–¤ ê¶Œí•œë„ í•´ë‹¹ë˜ì§€ ì•Šìœ¼ë©´ ì ‘ê·¼ ê±°ë¶€
            console.log(`âŒ ${menuId}: ì„¤ì •ëœ ê¶Œí•œì— í•´ë‹¹ë˜ì§€ ì•ŠìŒ, ì ‘ê·¼ ê±°ë¶€`);
            return false;
        }
        
        // ê¸°ë³¸ ê¶Œí•œ ì„¤ì • (ì—­í• ë³„)
        function getDefaultPermission(menuId, role) {
            const defaultPermissions = {
                'master': ['worklog', 'corporate-card', 'documents'],
                'company_admin': ['worklog', 'corporate-card', 'documents'],
                'company_manager': ['worklog', 'corporate-card', 'documents'],
                'employee': ['worklog']
            };
            
            return defaultPermissions[role] ? defaultPermissions[role].includes(menuId) : false;
        }
        
        function showMenuCard(menuTitle) {
            const menuCards = document.querySelectorAll('.menu-card');
            menuCards.forEach(card => {
                const h3 = card.querySelector('h3');
                if (h3 && h3.textContent.includes(menuTitle)) {
                    card.style.display = 'block';
                }
            });
        }

        // ë¡œë”© í™”ë©´ í‘œì‹œ/ìˆ¨ê¹€
        function showLoading() {
            document.getElementById('loadingScreen').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loadingScreen').classList.remove('active');
        }
        
        // ì‚¬ìš©ì í†µê³„ ë¡œë“œ
        function loadUserStatistics(user) {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // ì´ë²ˆ ë‹¬ ì²«ë‚ ê³¼ ë§ˆì§€ë§‰ë‚  ê³„ì‚°
            const startOfMonth = new Date(currentYear, currentMonth, 1);
            const endOfMonth = new Date(currentYear, currentMonth + 1, 0);
            
            let workLogCount = 0;
            let projectCount = 0;
            let cardUsageCount = 0;
            let clientCount = 0;
            
            try {
                // 1. ì—…ë¬´ì¼ì§€ ì¹´ìš´íŠ¸
                const workLogs = JSON.parse(localStorage.getItem('workLogs') || '[]');
                workLogCount = workLogs.filter(log => {
                    const logDate = new Date(log.date);
                    return log.author === user.name && 
                           logDate >= startOfMonth && 
                           logDate <= endOfMonth;
                }).length;
                
                // 2. ì§„í–‰ì¤‘ì¸ í”„ë¡œì íŠ¸ ì¹´ìš´íŠ¸ (ì—…ë¬´ì¼ì§€ì—ì„œ ìœ ë‹ˆí¬í•œ í”„ë¡œì íŠ¸ëª… ì¶”ì¶œ)
                const currentProjects = new Set();
                workLogs.filter(log => {
                    const logDate = new Date(log.date);
                    return log.author === user.name && 
                           logDate >= startOfMonth && 
                           logDate <= endOfMonth;
                }).forEach(log => {
                    if (log.project && log.project.trim()) {
                        currentProjects.add(log.project.trim());
                    }
                });
                projectCount = currentProjects.size;
                
                // 3. ë²•ì¸ì¹´ë“œ ì‚¬ìš© ì¹´ìš´íŠ¸
                const cardUsages = JSON.parse(localStorage.getItem('corporateCardUsages') || '[]');
                cardUsageCount = cardUsages.filter(usage => {
                    const usageDate = new Date(usage.date);
                    return usage.employee === user.name && 
                           usageDate >= startOfMonth && 
                           usageDate <= endOfMonth;
                }).length;
                
                // 4. ê´€ë¦¬ ê±°ë˜ì²˜ ì¹´ìš´íŠ¸ (ì‚¬ìš©ìê°€ ìƒì„±í•œ ê±°ë˜ì²˜)
                const clients = JSON.parse(localStorage.getItem('clients') || '[]');
                clientCount = clients.filter(client => 
                    client.createdBy === user.name || client.manager === user.name
                ).length;
                
            } catch (error) {
                console.error('í†µê³„ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
            }
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('workLogCount').textContent = workLogCount;
            document.getElementById('projectCount').textContent = projectCount;
            document.getElementById('cardUsageCount').textContent = cardUsageCount;
            document.getElementById('clientCount').textContent = clientCount;
            
            console.log('ğŸ“Š ì‚¬ìš©ì í†µê³„ ë¡œë“œ ì™„ë£Œ:', {
                workLogCount,
                projectCount,
                cardUsageCount,
                clientCount
            });
        }
        
        // ìµœê·¼ í™œë™ ë¡œë“œ
        function loadRecentActivities(user) {
            const activities = [];
            const currentDate = new Date();
            const oneMonthAgo = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, currentDate.getDate());
            
            try {
                // 1. ì—…ë¬´ì¼ì§€ í™œë™
                const workLogs = JSON.parse(localStorage.getItem('workLogs') || '[]');
                workLogs.filter(log => {
                    const logDate = new Date(log.date);
                    return log.author === user.name && logDate >= oneMonthAgo;
                }).slice(0, 5).forEach(log => {
                    activities.push({
                        type: 'worklog',
                        icon: 'fas fa-file-alt',
                        title: `ì—…ë¬´ì¼ì§€ ì‘ì„± - ${log.project || 'ì¼ë°˜ ì—…ë¬´'}`,
                        date: new Date(log.date),
                        originalData: log
                    });
                });
                
                // 2. ë²•ì¸ì¹´ë“œ ì‚¬ìš© í™œë™
                const cardUsages = JSON.parse(localStorage.getItem('corporateCardUsages') || '[]');
                cardUsages.filter(usage => {
                    const usageDate = new Date(usage.date);
                    return usage.employee === user.name && usageDate >= oneMonthAgo;
                }).slice(0, 3).forEach(usage => {
                    activities.push({
                        type: 'card',
                        icon: 'fas fa-credit-card',
                        title: `ë²•ì¸ì¹´ë“œ ì‚¬ìš© - ${usage.purpose || 'ì—…ë¬´ìš©'}`,
                        date: new Date(usage.date),
                        originalData: usage
                    });
                });
                
                // 3. ê±°ë˜ì²˜ ê´€ë ¨ í™œë™
                const clients = JSON.parse(localStorage.getItem('clients') || '[]');
                clients.filter(client => {
                    const createDate = new Date(client.createdAt || client.registrationDate);
                    return (client.createdBy === user.name || client.manager === user.name) && 
                           createDate >= oneMonthAgo;
                }).slice(0, 3).forEach(client => {
                    activities.push({
                        type: 'client',
                        icon: 'fas fa-users',
                        title: `ê±°ë˜ì²˜ ì •ë³´ ì—…ë°ì´íŠ¸ - ${client.companyName}`,
                        date: new Date(client.createdAt || client.registrationDate),
                        originalData: client
                    });
                });
                
                // 4. ë¬¸ì„œ ì‘ì„± í™œë™ (ê²°ì¬ ì„œë¥˜)
                const documents = JSON.parse(localStorage.getItem('documents') || '[]');
                documents.filter(doc => {
                    const docDate = new Date(doc.createdAt);
                    return doc.author === user.name && docDate >= oneMonthAgo;
                }).slice(0, 3).forEach(doc => {
                    activities.push({
                        type: 'document',
                        icon: 'fas fa-file-invoice',
                        title: `${doc.type} ì‘ì„± - ${doc.title}`,
                        date: new Date(doc.createdAt),
                        originalData: doc
                    });
                });
                
            } catch (error) {
                console.error('í™œë™ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
            }
            
            // ë‚ ì§œë³„ ì •ë ¬ (ìµœì‹ ìˆœ)
            activities.sort((a, b) => b.date - a.date);
            
            // ìµœëŒ€ 8ê°œ í™œë™ë§Œ í‘œì‹œ
            const recentActivities = activities.slice(0, 8);
            
            // í™œë™ ëª©ë¡ ì—…ë°ì´íŠ¸
            const activityList = document.getElementById('activityList');
            if (recentActivities.length === 0) {
                activityList.innerHTML = `
                    <div class="activity-item" style="text-align: center; padding: 2rem;">
                        <div style="color: #666; font-size: 1.1rem;">
                            <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                            ìµœê·¼ í•œ ë‹¬ê°„ í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                `;
            } else {
                activityList.innerHTML = recentActivities.map(activity => {
                    const timeAgo = getTimeAgo(activity.date);
                    return `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="${activity.icon}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">${activity.title}</div>
                                <div class="activity-time">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            console.log('ğŸ“ ìµœê·¼ í™œë™ ë¡œë“œ ì™„ë£Œ:', recentActivities.length, 'ê°œ í™œë™');
        }
        
        // ì‹œê°„ ì°¨ì´ ê³„ì‚° í•¨ìˆ˜
        function getTimeAgo(date) {
            const now = new Date();
            const diffInMs = now - date;
            const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
            const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            const diffInWeeks = Math.floor(diffInDays / 7);
            
            if (diffInMinutes < 60) {
                return diffInMinutes <= 1 ? 'ë°©ê¸ˆ ì „' : `${diffInMinutes}ë¶„ ì „`;
            } else if (diffInHours < 24) {
                return `${diffInHours}ì‹œê°„ ì „`;
            } else if (diffInDays < 7) {
                return diffInDays === 1 ? 'ì–´ì œ' : `${diffInDays}ì¼ ì „`;
            } else if (diffInWeeks < 4) {
                return `${diffInWeeks}ì£¼ì¼ ì „`;
            } else {
                return date.toLocaleDateString('ko-KR');
            }
        }
        
        // ì•Œë¦¼ ì²´í¬ í•¨ìˆ˜
        function checkNotifications(user) {
            // ê´€ë¦¬ìë‚˜ ëŒ€í‘œìë§Œ ì•Œë¦¼ ì²´í¬
            if (user.role === 'company_admin' || user.role === 'company_manager' || user.role === 'master') {
                const notifications = JSON.parse(localStorage.getItem('corporateCardNotifications') || '[]');
                const unreadNotifications = notifications.filter(n => !n.read);
                
                const badge = document.getElementById('cardNotificationBadge');
                if (badge) {
                    if (unreadNotifications.length > 0) {
                        badge.textContent = unreadNotifications.length;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }
        }
        
        // ìŠ¹ì¸ ì•Œë¦¼ ì²´í¬
        function checkApprovalNotifications(user) {
            try {
                // employees ëª©ë¡ì—ì„œ ì •í™•í•œ ì‚¬ìš©ì ID ì°¾ê¸°
                const employees = JSON.parse(localStorage.getItem('employees') || '[]');
                const employee = employees.find(emp => 
                    emp.name === user.name || 
                    emp.email === user.email ||
                    emp.id === user.id
                );
                
                let notifications = [];
                if (employee && employee.id) {
                    // ì •í™•í•œ employee IDë¡œ ì•Œë¦¼ ë¡œë“œ
                    notifications = JSON.parse(localStorage.getItem('notifications_' + employee.id) || '[]');
                    console.log(`ğŸ”” ì•Œë¦¼ ë¡œë“œ (${employee.id}):`, notifications.length, 'ê°œ');
                } else if (user.id) {
                    // fallback: í˜„ì¬ ì‚¬ìš©ì IDë¡œ ì‹œë„
                    notifications = JSON.parse(localStorage.getItem('notifications_' + user.id) || '[]');
                    console.log(`ğŸ”” ì•Œë¦¼ ë¡œë“œ (fallback ${user.id}):`, notifications.length, 'ê°œ');
                }
                
                const unreadApprovals = notifications.filter(notification => 
                    !notification.read && 
                    (notification.type === 'approval_request' || 
                     notification.type === 'approval_completed' || 
                     notification.type === 'approval_rejected')
                );
                
                const badge = document.getElementById('approvalNotificationBadge');
                const headerBadge = document.getElementById('approvalNotificationBadgeHeader');
                
                if (unreadApprovals.length > 0) {
                    // ê¸°ì¡´ ì¹´ë“œ ë°°ì§€ (ìˆ¨ê²¨ì§„ ìƒíƒœ)
                    badge.textContent = unreadApprovals.length;
                    badge.style.display = 'flex';
                    
                    // í—¤ë” ë°°ì§€
                    headerBadge.textContent = unreadApprovals.length;
                    headerBadge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                    headerBadge.style.display = 'none';
                }
                
                console.log('ğŸ”” ìŠ¹ì¸ ì•Œë¦¼ ì²´í¬ ì™„ë£Œ:', {
                    userName: user.name,
                    userId: user.id,
                    totalNotifications: notifications.length,
                    unreadApprovals: unreadApprovals.length,
                    approvalNotifications: unreadApprovals
                });
                
                // ë””ë²„ê¹…ì„ ìœ„í•´ ëª¨ë“  ì•Œë¦¼ í‚¤ ì¶œë ¥
                const allNotificationKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('notifications_')) {
                        allNotificationKeys.push(key);
                    }
                }
                console.log('ğŸ“‹ ëª¨ë“  ì•Œë¦¼ í‚¤:', allNotificationKeys);
                
            } catch (error) {
                console.error('ìŠ¹ì¸ ì•Œë¦¼ ì²´í¬ ì˜¤ë¥˜:', error);
            }
        }

        // í˜ì´ì§€ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            
            if (!currentUser) {
                // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                window.location.href = 'login.html';
                return;
            }
            
            // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
                userNameElement.textContent = currentUser.name || 'ì‚¬ìš©ì';
            }
            
            // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            const userInfoElement = document.getElementById('userInfo');
            if (userInfoElement && currentUser.position) {
                userInfoElement.textContent = `${currentUser.position} | ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”.`;
            }
            
            // ê¸°ì¡´ ê¸°ëŠ¥ë“¤ í˜¸ì¶œ
            applyMenuPermissions(currentUser);
            loadUserStatistics(currentUser);
            loadRecentActivities(currentUser);
            checkApprovalNotifications(currentUser);
            
            // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
            hideLoading();
        });
    </script>

    <!-- í”„ë¡œí•„ ëª¨ë‹¬ -->
    <div class="modal" id="profileModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>í”„ë¡œí•„ ì„¤ì •</h2>
                <button class="close-btn" onclick="hideProfileModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="profile-section">
                    <div class="profile-image-section">
                        <div class="current-profile-image">
                            <img id="modalProfileImage" src="" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" />
                        </div>
                        <div class="profile-image-upload">
                            <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="handleProfileImageUpload(event)">
                            <button type="button" onclick="document.getElementById('profileImageInput').click()">ì´ë¯¸ì§€ ë³€ê²½</button>
                        </div>
                    </div>
                    
                    <form id="profileForm">
                        <div class="form-group">
                            <label>ì´ë¦„</label>
                            <input type="text" id="profileUserName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        
                        <div class="form-group">
                            <label>ì´ë©”ì¼</label>
                            <input type="email" id="profileUserEmail" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        
                        <div class="form-group">
                            <label>ë¶€ì„œ</label>
                            <input type="text" id="profileUserDepartment" placeholder="ë¶€ì„œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        
                        <div class="form-group">
                            <label>ì§ì±…</label>
                            <input type="text" id="profileUserPosition" placeholder="ì§ì±…ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        
                        <div class="form-group">
                            <label>ì—°ë½ì²˜</label>
                            <input type="tel" id="profileUserPhone" placeholder="ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        
                        <button type="submit" class="btn-save-profile">í”„ë¡œí•„ ì €ì¥</button>
                    </form>
                </div>
                
                <div class="password-section">
                    <h3>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                    <form id="passwordChangeForm">
                        <div class="form-group">
                            <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        
                        <div class="form-group">
                            <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="newPassword" required minlength="6">
                        </div>
                        
                        <div class="form-group">
                            <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <input type="password" id="confirmPassword" required>
                        </div>
                        
                        <button type="submit" class="btn-change-password">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                    </form>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="handleLogout()" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</button>
                <button onclick="hideProfileModal()" class="btn-close">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <style>
        /* í”„ë¡œí•„ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .profile-image-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .current-profile-image img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
            margin-bottom: 15px;
        }
        
        .profile-image-upload button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group input[readonly] {
            background: #f5f5f5;
        }
        
        .btn-save-profile {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        
        .btn-save-profile:hover {
            background: #5a6fd8;
        }
        
        .password-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .password-section h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .btn-change-password {
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        
        .btn-change-password:hover {
            background: #218838;
        }
        
        .modal-footer {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            border-top: 1px solid #eee;
        }
        
        .btn-logout {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-logout:hover {
            background: #c82333;
        }
        
        .btn-close {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-close:hover {
            background: #545b62;
        }
        
        /* í”„ë¡œí•„ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .user-profile-dashboard {
            position: relative;
            display: inline-block;
        }
        
        .user-profile-dashboard:hover img {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .user-profile-dashboard img {
            width: 50px !important;
            height: 50px !important;
            min-width: 50px !important;
            min-height: 50px !important;
            max-width: 50px !important;
            max-height: 50px !important;
            border-radius: 50% !important;
            object-fit: cover !important;
            display: block !important;
            cursor: pointer !important;
            border: 2px solid #fff !important;
            transition: all 0.3s ease !important;
        }
    </style>

    <script>
        // í”„ë¡œí•„ ëª¨ë‹¬ í‘œì‹œ
        function showProfileModal() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) return;
            
            // í”„ë¡œí•„ ì •ë³´ ì±„ìš°ê¸°
            document.getElementById('profileUserName').value = currentUser.name || '';
            document.getElementById('profileUserEmail').value = currentUser.email || '';
            document.getElementById('profileUserDepartment').value = currentUser.department || '';
            document.getElementById('profileUserPosition').value = currentUser.position || '';
            document.getElementById('profileUserPhone').value = currentUser.phone || '';
            
            const profileImage = currentUser.profileImage || generateDefaultAvatar(currentUser.name || 'User');
            document.getElementById('modalProfileImage').src = profileImage;
            const dashboardImage = document.getElementById('profileImageDashboard');
            if (dashboardImage) {
                dashboardImage.src = profileImage;
            }
            
            document.getElementById('profileModal').style.display = 'flex';
        }
        
        // í”„ë¡œí•„ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
        function hideProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
            // í¼ ì´ˆê¸°í™”
            document.getElementById('passwordChangeForm').reset();
        }
        
        
        // í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ
        async function handleProfileImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // íŒŒì¼ í¬ê¸° ì œí•œ (2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 2MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            // ì´ë¯¸ì§€ íŒŒì¼ í™•ì¸
            if (!file.type.startsWith('image/')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const imageData = e.target.result;
                
                try {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                    
                    // ë°ì´í„°ë² ì´ìŠ¤ì— ì—…ë°ì´íŠ¸
                    if (window.db && currentUser.id) {
                        const userData = {
                            name: currentUser.name,
                            email: currentUser.email,
                            department: currentUser.department,
                            position: currentUser.position,
                            phone: currentUser.phone,
                            profileImage: imageData
                        };
                        
                        await db.updateUser(currentUser.id, userData);
                        console.log('í”„ë¡œí•„ ì´ë¯¸ì§€ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                        
                        // currentUser ê°ì²´ ì—…ë°ì´íŠ¸ (ë°ì´í„°ë² ì´ìŠ¤ ë™ê¸°í™”)
                        currentUser.profileImage = imageData;
                        
                        // localStorageì— ì—…ë°ì´íŠ¸ëœ ì •ë³´ ì €ì¥
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                    
                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById('modalProfileImage').src = imageData;
                    document.getElementById('profileImageDashboard').src = imageData;
                    
                    alert('í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜:', error);
                    alert('í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }
        
        // í”„ë¡œí•„ ì €ì¥
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('profileUserName').value.trim();
            const email = document.getElementById('profileUserEmail').value.trim();
            const department = document.getElementById('profileUserDepartment').value.trim();
            const position = document.getElementById('profileUserPosition').value.trim();
            const phone = document.getElementById('profileUserPhone').value.trim();
            
            if (!name || !email) {
                alert('ì´ë¦„ê³¼ ì´ë©”ì¼ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
                return;
            }
            
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                
                // ë°ì´í„°ë² ì´ìŠ¤ì— ì—…ë°ì´íŠ¸
                if (window.db && currentUser.id) {
                    const userData = {
                        name: name,
                        email: email,
                        department: department,
                        position: position,
                        phone: phone,
                        profileImage: currentUser.profileImage
                    };
                    
                    await db.updateUser(currentUser.id, userData);
                    console.log('ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                    
                    // currentUser ê°ì²´ ì—…ë°ì´íŠ¸ (ë°ì´í„°ë² ì´ìŠ¤ ë™ê¸°í™”)
                    currentUser.name = name;
                    currentUser.email = email;
                    currentUser.department = department;
                    currentUser.position = position;
                    currentUser.phone = phone;
                    
                    // localStorageì— ì—…ë°ì´íŠ¸ëœ ì •ë³´ ì €ì¥
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                document.getElementById('userName').textContent = name;
                document.getElementById('userInfo').textContent = `${position || 'ì§ê¸‰'} | ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”.`;
                
                // í”„ë¡œí•„ ì´ë¯¸ì§€ë„ ì—…ë°ì´íŠ¸
                const profileImage = currentUser.profileImage || generateDefaultAvatar(name);
                const dashboardImage = document.getElementById('profileImageDashboard');
                if (dashboardImage) {
                    dashboardImage.src = profileImage;
                }
                
                alert('í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                hideProfileModal();
                
            } catch (error) {
                console.error('í”„ë¡œí•„ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('í”„ë¡œí•„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
        document.getElementById('passwordChangeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
            this.reset();
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
                const profileImage = currentUser.profileImage || generateDefaultAvatar(currentUser.name || 'User');
                const dashboardImage = document.getElementById('profileImageDashboard');
                if (dashboardImage) {
                    dashboardImage.src = profileImage;
                }
                
                // í”„ë¡œí•„ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ ë“±ë¡ (ë°±ì—…ìš©)
                const profileContainer = document.querySelector('.user-profile-dashboard');
                if (profileContainer) {
                    profileContainer.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('í”„ë¡œí•„ í´ë¦­ë¨'); // ë””ë²„ê·¸ìš©
                        showProfileModal();
                    });
                }
            }
        });
    </script>
</body>
</html>