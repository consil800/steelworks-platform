<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteelWorks Platform - 마스터 대시보드</title>
    <link rel="stylesheet" href="../shared-assets/css/main.css">
    <link rel="stylesheet" href="../shared-assets/css/platform.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Database Manager -->
    <script src="database.js"></script>
    <!-- Domain Manager -->
    <script src="domain-manager.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        /* 네비게이션 바 스타일 */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            height: 70px;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .brand-text h1 {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .brand-text span {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 80px; /* 네비게이션 바 높이만큼 여백 추가 */
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .dashboard-header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
        }
        
        .dashboard-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .stat-card .icon {
            display: inline-block;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
            text-align: center;
            line-height: 50px;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .stat-card h3 {
            margin: 0;
            color: #333;
            font-size: 1.2em;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        .stat-card .trend {
            color: #27ae60;
            font-size: 0.9em;
        }
        
        .dashboard-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            color: #666;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .management-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .management-section h2 {
            margin-top: 0;
            color: #333;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .company-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .company-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .company-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: 16px 16px 0 0;
        }
        
        .company-card.tier-basic::before {
            background: linear-gradient(90deg, #94a3b8, #64748b);
        }
        
        .company-card.tier-standard::before {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        }
        
        .company-card.tier-premium::before {
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
        }
        
        .company-card.tier-enterprise::before {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .company-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-color: #cbd5e1;
        }
        
        .company-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .company-info h4 {
            margin: 0 0 8px 0;
            color: #1e293b;
            font-size: 1.25rem;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .company-domain {
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 8px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .company-tier {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }
        
        .tier-basic {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            color: #475569;
            border: 1px solid #cbd5e1;
        }
        
        .tier-standard {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .tier-premium {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            color: #6d28d9;
            border: 1px solid #c4b5fd;
        }
        
        .tier-enterprise {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        
        .company-details {
            margin-bottom: 20px;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .detail-icon {
            width: 20px;
            margin-right: 12px;
            color: #667eea;
            font-size: 0.875rem;
        }
        
        .detail-text {
            color: #475569;
            font-size: 0.875rem;
            flex: 1;
        }
        
        .detail-text.website-link {
            color: #667eea;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .detail-text.website-link:hover {
            color: #5a67d8;
            text-decoration: underline;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-active {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-inactive {
            background: #fef2f2;
            color: #991b1b;
        }
        
        .company-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f1f5f9;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 0.8rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-sm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #475569, #334155);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #0891b2, #0e7490);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        .add-new-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .add-new-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.3);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group.half-width {
            margin-bottom: 0;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: flex-end;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            max-width: 150px;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-cancel {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            max-width: 120px;
        }
        
        .btn-cancel:hover {
            background: #cbd5e0;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            max-width: 120px;
        }

        .btn-delete:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        .btn-danger:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .permission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .permission-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .permission-card h4 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        .permission-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .permission-item input[type="checkbox"] {
            margin-right: 10px;
        }

        /* 새로 추가된 스타일들 */
        .no-data {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .no-data i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .company-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .company-card:hover {
            transform: translateY(-2px);
        }

        .company-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .company-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .company-info p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status.active {
            background: #d4edda;
            color: #155724;
        }

        .status.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .company-logo {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
        }

        .company-details {
            margin-bottom: 15px;
        }

        .company-details p {
            margin: 5px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .company-details i {
            width: 20px;
            color: #667eea;
        }

        .company-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }



        /* 사용자 관리 스타일 */
        .company-users-section {
            margin-bottom: 30px;
        }

        /* 회사 섹션 제목 스타일은 아래에서 정의됨 */

        /* 사용자 관리 테이블 스타일은 아래 .users-table 섹션에서 정의됨 */
        
        /* 사용자 목록 컨테이너 스타일 */
        .user-list {
            margin-top: 20px;
        }
        
        /* 기존 스타일은 아래 드롭다운 스타일로 대체됨 */
        
        /* 사용자 테이블 스타일 */
        .users-table-container {
            overflow-x: auto;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        
        .users-table thead {
            background: #f8f9fa;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .users-table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            white-space: nowrap;
        }
        
        .users-table tbody tr {
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s ease;
        }
        
        .users-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .users-table td {
            padding: 12px 15px;
            vertical-align: middle;
        }
        
        .user-name strong {
            color: #2d3748;
            font-weight: 600;
        }
        
        .user-contact {
            color: #718096;
            font-size: 0.9rem;
        }
        
        .user-actions-cell {
            width: 150px;
        }
        
        .user-actions-cell .user-actions {
            gap: 5px;
            justify-content: flex-start;
            margin-top: 0;
        }
        
        .user-actions .btn-sm {
            padding: 4px 8px;
            font-size: 0.85rem;
        }
        
        /* 역할 배지 스타일 */
        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .role-badge.master {
            background: #fef3c7;
            color: #92400e;
        }
        
        .role-badge.company_admin,
        .role-badge.admin {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .role-badge.company_manager,
        .role-badge.manager {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .role-badge.company_employee,
        .role-badge.employee {
            background: #d1fae5;
            color: #065f46;
        }
        
        /* 드롭다운 스타일 */
        .company-users-section {
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .company-section-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        
        .company-section-header:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
        }
        
        .company-section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .dropdown-icon {
            transition: transform 0.3s ease;
            font-size: 0.9rem;
        }
        
        .company-users-section.expanded .dropdown-icon {
            transform: rotate(180deg);
        }
        
        .users-table-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: white;
        }
        
        .company-users-section.expanded .users-table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .user-count {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            margin-left: 10px;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .users-table {
                font-size: 0.85rem;
            }
            
            .users-table th,
            .users-table td {
                padding: 8px 10px;
            }
            
            .user-actions-cell {
                width: auto;
            }
        }

        /* 권한 관리 스타일 */
        .permissions-overview {
            margin-bottom: 30px;
        }

        .permissions-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .permission-stat {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .stat-icon.admin {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .stat-icon.manager {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .stat-icon.employee {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .company-permission-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .permission-breakdown {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .role-badge.admin {
            background: #fff3cd;
            color: #856404;
        }

        .role-badge.manager {
            background: #d1ecf1;
            color: #0c5460;
        }

        .role-badge.employee {
            background: #d4edda;
            color: #155724;
        }

        /* 시스템 관리 스타일 */
        .system-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .system-stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .system-stat-card i {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 10px;
        }

        .status-text {
            font-weight: 600;
            margin-top: 10px;
        }

        .status-text.connected {
            color: #28a745;
        }

        .status-text.disconnected {
            color: #dc3545;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .activity-list {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item i {
            color: #667eea;
            width: 20px;
        }

        .activity-item time {
            margin-left: auto;
            color: #666;
            font-size: 0.9rem;
        }
        
        /* 모바일 반응형 디자인 */
        @media (max-width: 768px) {
            .company-list {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .company-card {
                padding: 20px;
            }
            
            .company-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .company-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn-sm {
                width: 100%;
                justify-content: center;
            }
            
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .nav-menu {
                display: none;
            }
            
            .dashboard-header h1 {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .company-card {
                padding: 16px;
            }
            
            .company-info h4 {
                font-size: 1.1rem;
            }
            
            .detail-text {
                font-size: 0.8rem;
            }
        }
        
        /* 애니메이션 */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .company-card {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .company-card:nth-child(1) { animation-delay: 0.1s; }
        .company-card:nth-child(2) { animation-delay: 0.2s; }
        .company-card:nth-child(3) { animation-delay: 0.3s; }
        .company-card:nth-child(4) { animation-delay: 0.4s; }
        .company-card:nth-child(5) { animation-delay: 0.5s; }
        .company-card:nth-child(6) { animation-delay: 0.6s; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <div class="brand-icon">
                    <i class="fas fa-industry"></i>
                </div>
                <div class="brand-text">
                    <h1>SteelWorks</h1>
                    <span>Master Dashboard</span>
                </div>
            </div>
            
            <div class="nav-menu">
                <a href="index.html" class="nav-link">플랫폼 홈</a>
                <a href="#companies" class="nav-link" onclick="showTab('companies')">회사 관리</a>
                <a href="#users" class="nav-link" onclick="showTab('users')">사용자 관리</a>
                <a href="#permissions" class="nav-link" onclick="showTab('permissions')">권한 관리</a>
                <a href="#settings" class="nav-link" onclick="showTab('system')">설정</a>
            </div>
            
            <div class="nav-actions">
                <span class="user-info">
                    <i class="fas fa-crown" style="color: gold;"></i> 마스터 관리자
                </span>
                <button onclick="logout()" class="btn btn-secondary">
                    <i class="fas fa-sign-out-alt"></i> 로그아웃
                </button>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>마스터 대시보드</h1>
            <p>SteelWorks Platform의 모든 회사와 사용자를 관리합니다</p>
        </div>

        <div class="dashboard-stats">
            <div class="stat-card" id="totalCompanies">
                <div class="icon">
                    <i class="fas fa-building"></i>
                </div>
                <h3>등록된 회사</h3>
                <div class="value">0</div>
                <div class="trend">플랫폼 등록 회사</div>
            </div>
            
            <div class="stat-card" id="totalUsers">
                <div class="icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3>총 사용자</h3>
                <div class="value">0</div>
                <div class="trend">직원 수 합계</div>
            </div>
            
            <div class="stat-card" id="activeWebsites">
                <div class="icon">
                    <i class="fas fa-globe"></i>
                </div>
                <h3>활성 홈페이지</h3>
                <div class="value">0</div>
                <div class="trend">사용 중인 회사 수</div>
            </div>
            
            <div class="stat-card" id="systemStatus">
                <div class="icon">
                    <i class="fas fa-server"></i>
                </div>
                <h3>시스템 상태</h3>
                <div class="value" style="font-size: 1.5em;">정상</div>
                <div class="trend">0% 가동률</div>
            </div>
        </div>

        <div class="dashboard-tabs">
            <button class="tab-btn active" onclick="showTab('companies')">
                <i class="fas fa-building"></i> 회사 관리
            </button>
            <button class="tab-btn" onclick="showTab('users'); debugLocalStorage();">
                <i class="fas fa-users"></i> 사용자 관리
            </button>
            <button class="tab-btn" onclick="showTab('permissions')">
                <i class="fas fa-shield-alt"></i> 권한 관리
            </button>
            <button class="tab-btn" onclick="showTab('system')">
                <i class="fas fa-cog"></i> 시스템 설정
            </button>
        </div>

        <div id="companies-tab" class="tab-content active">
            <div class="management-section">
                <h2>회사 관리</h2>
                
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="회사명으로 검색...">
                    <button class="btn btn-primary">
                        <i class="fas fa-search"></i> 검색
                    </button>
                </div>

                <div class="company-list">
                    <!-- 회사 목록이 동적으로 여기에 렌더링됩니다 -->
                </div>
                
                <button class="add-new-btn" onclick="showAddCompanyModal()">
                    <i class="fas fa-plus"></i> 새 회사 추가
                </button>
                
            </div>
        </div>

        <div id="users-tab" class="tab-content">
            <div class="management-section">
                <h2>사용자 관리</h2>
                
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="사용자명 또는 이메일로 검색...">
                    <select class="search-input" style="flex: 0.3;" id="companyFilterSelect">
                        <option value="">모든 회사</option>
                        <!-- 회사 옵션들이 동적으로 추가됩니다 -->
                    </select>
                    <button class="btn btn-primary">
                        <i class="fas fa-search"></i> 검색
                    </button>
                    <button class="btn btn-secondary" onclick="toggleAllCompanySections(true)" title="모든 회사 펼치기">
                        <i class="fas fa-expand-alt"></i> 모두 펼치기
                    </button>
                    <button class="btn btn-secondary" onclick="toggleAllCompanySections(false)" title="모든 회사 접기">
                        <i class="fas fa-compress-alt"></i> 모두 접기
                    </button>
                </div>

                <div class="user-list" id="usersList">
                    <!-- 사용자 목록이 동적으로 여기에 렌더링됩니다 -->
                </div>
            </div>
        </div>

        <div id="permissions-tab" class="tab-content">
            <div class="management-section">
                <h2>권한 관리</h2>
                <div class="permissions-content">
                    <!-- 권한 관리 콘텐츠가 동적으로 렌더링됩니다 -->
                </div>
            </div>
        </div>

        <div id="system-tab" class="tab-content">
            <div class="management-section">
                <h2>시스템 관리</h2>
                <div class="system-content">
                    <!-- 시스템 관리 콘텐츠가 동적으로 렌더링됩니다 -->
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>

    <!-- 새 회사 추가 모달 -->
    <div class="modal-overlay" id="addCompanyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>새 회사 추가</h2>
                <button class="close-btn" onclick="hideAddCompanyModal()">&times;</button>
            </div>
            
            <form id="addCompanyForm" onsubmit="handleAddCompany(event)">
                <div class="form-group">
                    <label for="companyName">법인명(단체명) *</label>
                    <input type="text" id="companyName" name="companyName" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="businessNumber">사업자등록번호 *</label>
                        <input type="text" id="businessNumber" name="businessNumber" placeholder="000-00-00000" required>
                    </div>
                    <div class="form-group">
                        <label for="corporateNumber">법인등록번호</label>
                        <input type="text" id="corporateNumber" name="corporateNumber" placeholder="000000-0000000">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="representative">대표자 *</label>
                        <input type="text" id="representative" name="representative" required>
                    </div>
                    <div class="form-group">
                        <label for="openingDate">개업연월일 *</label>
                        <input type="date" id="openingDate" name="openingDate" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="businessAddress">사업자 소재지 *</label>
                    <input type="text" id="businessAddress" name="businessAddress" placeholder="도로명 주소 또는 지번 주소" required>
                </div>
                
                <div class="form-group">
                    <label for="businessType">사업의 종류 *</label>
                    <input type="text" id="businessType" name="businessType" placeholder="예: 철강 제조업, 자동차 부품 제조업" required>
                </div>
                
                
                <div class="form-group">
                    <label for="websiteUrl">홈페이지 주소</label>
                    <input type="url" id="websiteUrl" name="websiteUrl" placeholder="예: https://consil800.com">
                    <small style="color: #666; font-size: 0.9em; display: block; margin-top: 5px;">홈페이지 전체 주소를 입력하세요 (http:// 또는 https:// 포함)</small>
                </div>
                
                <div class="form-group">
                    <label for="domainUrl">회사 도메인 주소</label>
                    <input type="url" id="domainUrl" name="domainUrl" placeholder="https://www.example.com">
                    <small style="color: #666; font-size: 0.9em; display: block; margin-top: 5px;">
                        회사 공식 홈페이지 도메인 주소를 입력하세요 (선택사항)
                    </small>
                </div>
                
                <button type="submit" class="btn-submit">회사 등록</button>
                <button type="button" class="btn-cancel" onclick="hideAddCompanyModal()">취소</button>
            </form>
        </div>
    </div>

    <!-- 회사 편집 모달 -->
    <div class="modal-overlay" id="editCompanyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>회사 정보 편집</h2>
                <button class="close-btn" onclick="hideEditCompanyModal()">&times;</button>
            </div>
            
            <form id="editCompanyForm" onsubmit="handleEditCompany(event)">
                <input type="hidden" id="editCompanyId" name="editCompanyId">
                
                <div class="form-group">
                    <label for="editCompanyName">법인명(단체명) *</label>
                    <input type="text" id="editCompanyName" name="editCompanyName" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="editBusinessNumber">사업자등록번호 *</label>
                        <input type="text" id="editBusinessNumber" name="editBusinessNumber" placeholder="000-00-00000" required>
                    </div>
                    <div class="form-group half-width">
                        <label for="editCorporateNumber">법인등록번호</label>
                        <input type="text" id="editCorporateNumber" name="editCorporateNumber" placeholder="000000-0000000">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="editRepresentative">대표자 *</label>
                        <input type="text" id="editRepresentative" name="editRepresentative" required>
                    </div>
                    <div class="form-group half-width">
                        <label for="editOpeningDate">개업연월일 *</label>
                        <input type="date" id="editOpeningDate" name="editOpeningDate" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editBusinessAddress">사업자 소재지 *</label>
                    <input type="text" id="editBusinessAddress" name="editBusinessAddress" placeholder="도로명 주소 또는 지번 주소" required>
                </div>
                
                <div class="form-group">
                    <label for="editBusinessType">사업의 종류 *</label>
                    <input type="text" id="editBusinessType" name="editBusinessType" placeholder="예: 철강 제조업, 자동차 부품 제조업" required>
                </div>
                
                <div class="form-group">
                    <label for="editWebsiteUrl">홈페이지 주소</label>
                    <input type="url" id="editWebsiteUrl" name="editWebsiteUrl" placeholder="예: https://consil800.com">
                    <small style="color: #666; font-size: 0.9em; display: block; margin-top: 5px;">홈페이지 전체 주소를 입력하세요 (http:// 또는 https:// 포함)</small>
                </div>
                
                <div class="form-group">
                    <label for="editCompanyEmail">이메일 주소</label>
                    <input type="email" id="editCompanyEmail" name="editCompanyEmail" placeholder="contact@company.com">
                    <small style="color: #666; font-size: 0.9em; display: block; margin-top: 5px;">
                        회사 대표 이메일 주소를 입력하세요 (선택사항)
                    </small>
                </div>
                
                <div class="button-group">
                    <button type="submit" class="btn-submit">수정 완료</button>
                    <button type="button" class="btn-cancel" onclick="hideEditCompanyModal()">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 사용자 편집 모달 -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>사용자 정보 편집</h2>
                <button class="close-btn" onclick="hideEditUserModal()">&times;</button>
            </div>
            
            <form id="editUserForm" onsubmit="handleEditUser(event)">
                <input type="hidden" id="editUserId" name="editUserId">
                
                <div class="form-group">
                    <label for="editUserName">이름 *</label>
                    <input type="text" id="editUserName" name="editUserName" required>
                </div>
                
                <div class="form-group">
                    <label for="editUserPhone">연락처</label>
                    <input type="tel" id="editUserPhone" name="editUserPhone" placeholder="010-0000-0000">
                </div>
                
                <div class="form-group">
                    <label for="editUserDepartment">부서</label>
                    <input type="text" id="editUserDepartment" name="editUserDepartment" placeholder="예: 경영진, 개발팀, 영업팀">
                </div>
                
                <div class="form-group">
                    <label for="editUserEmail">이메일</label>
                    <input type="email" id="editUserEmail" name="editUserEmail" placeholder="example@company.com">
                </div>
                
                <div class="modal-buttons">
                    <button type="submit" class="btn-submit" onclick="console.log('🔥 수정 완료 버튼 클릭됨!');">수정 완료</button>
                    <button type="button" class="btn-delete" onclick="handleDeleteUser()">삭제</button>
                    <button type="button" class="btn-cancel" onclick="hideEditUserModal()">취소</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 전역 변수
        let allCompanies = [];
        let allUsers = [];
        let systemStats = {
            totalCompanies: 0,
            totalUsers: 0,
            activeWebsites: 0
        };

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            // 샘플 데이터 정리
            cleanupSampleData();
            
            await loadDashboardData();
            updateStatistics();
            showTab('companies'); // 기본 탭 설정
        });

        // 샘플 데이터 정리 함수
        function cleanupSampleData() {
            console.log('🧹 샘플 데이터 정리 시작...');
            
            // 샘플 회사 데이터 키들
            const sampleKeys = [
                'platform_companies',
                'companies',
                'users',
                'employees',
                'company_test-company-1_employees',
                'company_test-company-2_employees', 
                'company_test-company-3_employees',
                'company_test-company-1_representative',
                'company_test-company-2_representative',
                'company_test-company-3_representative'
            ];
            
            // 샘플 데이터 제거
            sampleKeys.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    console.log(`🗑️ 제거: ${key}`);
                }
            });
            
            // test-company로 시작하는 모든 키 제거
            const allKeys = Object.keys(localStorage);
            allKeys.forEach(key => {
                if (key.includes('test-company') || key.includes('sample') || key.includes('demo')) {
                    localStorage.removeItem(key);
                    console.log(`🗑️ 샘플 데이터 제거: ${key}`);
                }
            });
            
            console.log('✅ 샘플 데이터 정리 완료');
        }

        // 데이터베이스에서 데이터 로드
        async function loadDashboardData() {
            try {
                // 마스터 권한으로 모든 회사 조회
                if (db && db.client) {
                    const { data: companiesData, error: companiesError } = await db.client
                        .from('companies')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (!companiesError && companiesData) {
                        allCompanies = companiesData;
                    }

                    // 모든 사용자 조회 (마스터 권한)
                    const { data: usersData, error: usersError } = await db.client
                        .from('users')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (!usersError && usersData) {
                        allUsers = usersData;
                    }
                } else {
                    throw new Error('데이터베이스 연결이 필요합니다.');
                }

                console.log('로드된 회사 수:', allCompanies.length);
                console.log('로드된 사용자 수:', allUsers.length);
            } catch (error) {
                console.error('데이터 로드 오류:', error);
                alert('데이터베이스 연결에 실패했습니다. 네트워크 연결을 확인해주세요.');
                throw error;
            }
        }

        // 통계 업데이트
        function updateStatistics() {
            systemStats.totalCompanies = allCompanies.length;
            systemStats.totalUsers = allUsers.length;
            systemStats.activeWebsites = allCompanies.filter(c => c.is_active !== false).length;

            console.log('📊 updateStatistics 호출됨:');
            console.log(`  - 총 회사: ${systemStats.totalCompanies}개`);
            console.log(`  - 총 사용자: ${systemStats.totalUsers}명`);
            console.log(`  - 활성 홈페이지: ${systemStats.activeWebsites}개`);

            // DOM 업데이트
            const totalCompaniesEl = document.querySelector('#totalCompanies .value');
            const totalUsersEl = document.querySelector('#totalUsers .value');
            const activeWebsitesEl = document.querySelector('#activeWebsites .value');
            
            if (totalCompaniesEl) {
                totalCompaniesEl.textContent = systemStats.totalCompanies;
                console.log('✅ 총 회사 수 업데이트:', systemStats.totalCompanies);
            } else {
                console.error('❌ #totalCompanies .value 요소를 찾을 수 없음');
            }
            
            if (totalUsersEl) {
                totalUsersEl.textContent = systemStats.totalUsers;
                console.log('✅ 총 사용자 수 업데이트:', systemStats.totalUsers);
            } else {
                console.error('❌ #totalUsers .value 요소를 찾을 수 없음');
            }
            
            if (activeWebsitesEl) {
                activeWebsitesEl.textContent = systemStats.activeWebsites;
                console.log('✅ 활성 홈페이지 수 업데이트:', systemStats.activeWebsites);
            } else {
                console.error('❌ #activeWebsites .value 요소를 찾을 수 없음');
            }
        }

        // 탭 전환 함수
        function showTab(tabName) {
            // 모든 탭 버튼과 콘텐츠 숨기기
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 클릭된 버튼 찾기
            const clickedBtn = event ? event.target : document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            }
            
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // 탭별 데이터 렌더링
            switch(tabName) {
                case 'companies':
                    renderCompaniesList();
                    updateCompanyFilterDropdown();
                    break;
                case 'users':
                    setTimeout(() => {
                        renderUsersList();
                    }, 100);
                    break;
                case 'permissions':
                    renderPermissionsList();
                    break;
                case 'system':
                    renderSystemSettings();
                    break;
            }
        }

        // 회사 목록 렌더링
        function renderCompaniesList() {
            const companiesGrid = document.querySelector('#companies-tab .company-list');
            if (!companiesGrid) return;

            if (allCompanies.length === 0) {
                companiesGrid.innerHTML = `
                    <div class="no-data" style="grid-column: 1 / -1; text-align: center; padding: 4rem;">
                        <i class="fas fa-building" style="font-size: 4rem; color: #cbd5e1; margin-bottom: 1rem;"></i>
                        <h3 style="color: #64748b; margin-bottom: 1rem;">등록된 회사가 없습니다</h3>
                        <p style="color: #9ca3af; margin-bottom: 2rem;">새로운 회사를 등록하여 시작해보세요</p>
                        <button onclick="addNewCompany()" class="btn btn-primary">
                            <i class="fas fa-plus"></i> 새 회사 등록
                        </button>
                    </div>
                `;
                return;
            }

            companiesGrid.innerHTML = allCompanies.map(company => {
                const tier = (company.subscription_plan || 'basic').toLowerCase();
                const isActive = company.is_active !== false;
                
                return `
                    <div class="company-card tier-${tier}">
                        <div class="company-header">
                            <div class="company-info">
                                <h4>${company.company_name}</h4>
                                <div class="company-domain">${company.domain}</div>
                            </div>
                            <div class="company-tier tier-${tier}">
                                ${getTierDisplayName(tier)}
                            </div>
                        </div>
                        
                        <div class="company-details">
                            <div class="detail-item">
                                <i class="fas fa-phone detail-icon"></i>
                                <span class="detail-text">${company.phone || '연락처 미등록'}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-envelope detail-icon"></i>
                                <span class="detail-text">${company.email || '이메일 미등록'}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-globe detail-icon"></i>
                                ${company.website ? 
                                    `<a href="${company.website}" target="_blank" class="detail-text website-link">${company.website}</a>` :
                                    `<span class="detail-text">홈페이지 미설정</span>`
                                }
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-calendar detail-icon"></i>
                                <span class="detail-text">등록일: ${new Date(company.created_at).toLocaleDateString('ko-KR')}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-circle detail-icon"></i>
                                <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                                    ${isActive ? '활성' : '비활성'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="company-actions">
                            <button onclick="manageCompany('${company.domain}')" class="btn btn-primary btn-sm">
                                <i class="fas fa-cog"></i> 관리
                            </button>
                            <button onclick="viewCompanyHomepage('${company.domain}')" class="btn btn-secondary btn-sm">
                                <i class="fas fa-globe"></i> 홈페이지
                            </button>
                            <button onclick="editCompany('${company.domain}')" class="btn btn-info btn-sm">
                                <i class="fas fa-edit"></i> 수정
                            </button>
                            <button onclick="deleteCompany('${company.domain}', '${company.company_name}')" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i> 삭제
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 회사 필터 드롭다운 업데이트
        function updateCompanyFilterDropdown() {
            const companyFilterSelect = document.getElementById('companyFilterSelect');
            if (!companyFilterSelect) return;

            // 기존 옵션 제거 (첫 번째 "모든 회사" 옵션 제외)
            while (companyFilterSelect.children.length > 1) {
                companyFilterSelect.removeChild(companyFilterSelect.lastChild);
            }

            // 실제 회사 데이터로 옵션 추가
            allCompanies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.domain || company.id;
                option.textContent = company.company_name || company.companyName;
                companyFilterSelect.appendChild(option);
            });
        }

        // 사용자 목록 렌더링
        function renderUsersList() {
            console.log('📋 renderUsersList 호출됨');
            console.log('👥 allUsers 배열:', allUsers);
            console.log('👥 allUsers 개수:', allUsers.length);
            
            const usersGrid = document.getElementById('usersList');
            if (!usersGrid) {
                console.error('❌ usersList 요소를 찾을 수 없음');
                return;
            }

            if (allUsers.length === 0) {
                console.log('⚠️ 사용자가 없음');
                usersGrid.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-users"></i>
                        <p>등록된 사용자가 없습니다.</p>
                    </div>
                `;
                return;
            }

            // 회사별로 그룹화 (마스터 관리자 제외)
            const usersByCompany = allUsers.reduce((acc, user) => {
                // 마스터 관리자는 특정 회사에 속하지 않음
                if (user.role === 'master' || user.role === 'super_admin') {
                    return acc;
                }
                
                const domain = user.company_domain || user.company_id || user.company || 'unknown';
                if (!acc[domain]) acc[domain] = [];
                acc[domain].push(user);
                return acc;
            }, {});
            
            // 마스터 관리자는 별도 섹션에 표시
            const masterUsers = allUsers.filter(user => user.role === 'master' || user.role === 'super_admin');
            if (masterUsers.length > 0) {
                usersByCompany['master'] = masterUsers;
            }
            
            console.log('🏢 회사별 사용자 그룹:', usersByCompany);

            // 회사별 그룹이 없는 경우 전체 사용자를 하나의 그룹으로 표시
            if (Object.keys(usersByCompany).length === 0) {
                usersByCompany['all'] = allUsers;
            }

            usersGrid.innerHTML = Object.entries(usersByCompany).map(([domain, users]) => {
                let sectionTitle = '';
                let sectionIcon = 'fas fa-building';
                
                if (domain === 'master') {
                    sectionTitle = '대표이사';
                    sectionIcon = 'fas fa-crown';
                } else {
                    // domain, company_id, id 등 다양한 방식으로 회사 찾기
                    const company = allCompanies.find(c => 
                        c.domain === domain || 
                        c.id === domain || 
                        c.company_id === domain
                    );
                    sectionTitle = company?.company_name || company?.name || domain;
                }
                
                console.log(`🏢 도메인 ${domain}에 대한 섹션:`, sectionTitle);
                console.log(`👥 해당 섹션의 사용자들:`, users);
                
                return `
                    <div class="company-users-section" data-domain="${domain}">
                        <div class="company-section-header" onclick="toggleCompanyUsers('${domain}')">
                            <div class="company-section-title">
                                <i class="${sectionIcon}"></i>
                                ${sectionTitle}
                                <span class="user-count">${users.length}명</span>
                            </div>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </div>
                        <div class="users-table-container">
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th>이름</th>
                                        <th>역할</th>
                                        <th>부서/직급</th>
                                        <th>ID/이메일</th>
                                        <th>가입일</th>
                                        <th>관리</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${users.map(user => `
                                        <tr class="user-row">
                                            <td class="user-name">
                                                <strong>${user.name || user.username || '이름 없음'}</strong>
                                            </td>
                                            <td>
                                                <span class="role-badge ${user.role}">${getRoleText(user.role)}</span>
                                            </td>
                                            <td>${user.department || '미지정'} / ${user.position || '미지정'}</td>
                                            <td class="user-contact">${user.username || user.email || user.id}</td>
                                            <td>${user.created_at ? new Date(user.created_at).toLocaleDateString('ko-KR') : '정보 없음'}</td>
                                            <td class="user-actions-cell">
                                                <div class="user-actions">
                                                    ${user.role === 'company_admin' || user.role === 'admin' ? `
                                                        <button onclick="changeUserToCEO('${user.id}')" class="btn btn-warning btn-sm" title="대표이사로 변경">
                                                            <i class="fas fa-crown"></i>
                                                        </button>
                                                    ` : ''}
                                                    <button onclick="editUser('${user.id}')" class="btn btn-info btn-sm" title="수정">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="resetUserPassword('${user.id}')" class="btn btn-secondary btn-sm" title="비밀번호 초기화">
                                                        <i class="fas fa-key"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 회사별 사용자 목록 토글 함수
        function toggleCompanyUsers(domain) {
            console.log('🔄 토글 도메인:', domain);
            
            const section = document.querySelector(`[data-domain="${domain}"]`);
            if (!section) {
                console.error('❌ 섹션을 찾을 수 없음:', domain);
                return;
            }
            
            const isExpanded = section.classList.contains('expanded');
            
            if (isExpanded) {
                // 접기
                section.classList.remove('expanded');
                console.log('📁 섹션 접기:', domain);
            } else {
                // 펼치기
                section.classList.add('expanded');
                console.log('📂 섹션 펼치기:', domain);
            }
        }

        // 모든 회사 섹션 펼치기/접기
        function toggleAllCompanySections(expand = null) {
            const sections = document.querySelectorAll('.company-users-section');
            
            sections.forEach(section => {
                if (expand === true || (expand === null && !section.classList.contains('expanded'))) {
                    section.classList.add('expanded');
                } else {
                    section.classList.remove('expanded');
                }
            });
        }

        // 권한 관리 렌더링
        function renderPermissionsList() {
            const permissionsContainer = document.querySelector('#permissions-tab .permissions-content');
            if (!permissionsContainer) return;

            // 회사별 권한 통계
            const companyPermissions = allCompanies.map(company => {
                const companyUsers = allUsers.filter(u => u.company_domain === company.domain);
                const adminCount = companyUsers.filter(u => u.role === 'company_admin').length;
                const managerCount = companyUsers.filter(u => u.role === 'company_manager').length;
                const employeeCount = companyUsers.filter(u => u.role === 'employee').length;

                return {
                    company,
                    adminCount,
                    managerCount,
                    employeeCount,
                    totalUsers: companyUsers.length
                };
            });

            permissionsContainer.innerHTML = `
                <div class="permissions-overview">
                    <h3>권한 현황</h3>
                    <div class="permissions-stats">
                        <div class="permission-stat">
                            <div class="stat-icon admin">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="stat-info">
                                <h4>관리자</h4>
                                <p>${allUsers.filter(u => u.role === 'company_admin').length}명</p>
                            </div>
                        </div>
                        <div class="permission-stat">
                            <div class="stat-icon manager">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="stat-info">
                                <h4>매니저</h4>
                                <p>${allUsers.filter(u => u.role === 'company_manager').length}명</p>
                            </div>
                        </div>
                        <div class="permission-stat">
                            <div class="stat-icon employee">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="stat-info">
                                <h4>직원</h4>
                                <p>${allUsers.filter(u => u.role === 'employee').length}명</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="company-permissions">
                    <h3>회사별 권한 분포</h3>
                    ${companyPermissions.map(cp => `
                        <div class="company-permission-card">
                            <h4>${cp.company.company_name}</h4>
                            <div class="permission-breakdown">
                                <div class="permission-item">
                                    <span class="role-badge admin">관리자</span>
                                    <span class="count">${cp.adminCount}명</span>
                                </div>
                                <div class="permission-item">
                                    <span class="role-badge manager">매니저</span>
                                    <span class="count">${cp.managerCount}명</span>
                                </div>
                                <div class="permission-item">
                                    <span class="role-badge employee">직원</span>
                                    <span class="count">${cp.employeeCount}명</span>
                                </div>
                            </div>
                            <div class="permission-actions">
                                <button onclick="manageCompanyPermissions('${cp.company.domain}')" class="btn btn-primary btn-sm">
                                    <i class="fas fa-cog"></i> 권한 관리
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 시스템 관리 렌더링
        function renderSystemSettings() {
            const systemContainer = document.querySelector('#system-tab .system-content');
            if (!systemContainer) return;

            systemContainer.innerHTML = `
                <div class="system-overview">
                    <h3>시스템 현황</h3>
                    <div class="system-stats-grid">
                        <div class="system-stat-card">
                            <i class="fas fa-database"></i>
                            <h4>데이터베이스</h4>
                            <p class="status-text ${db && db.client ? 'connected' : 'disconnected'}">
                                ${db && db.client ? '연결됨' : '오프라인'}
                            </p>
                        </div>
                        <div class="system-stat-card">
                            <i class="fas fa-server"></i>
                            <h4>서버 상태</h4>
                            <p class="status-text connected">정상</p>
                        </div>
                        <div class="system-stat-card">
                            <i class="fas fa-clock"></i>
                            <h4>마지막 백업</h4>
                            <p class="status-text">${getLastBackupTime()}</p>
                        </div>
                    </div>
                </div>

                <div class="system-actions">
                    <h3>시스템 관리</h3>
                    <div class="action-buttons">
                        <button onclick="backupDatabase()" class="btn btn-primary">
                            <i class="fas fa-download"></i> 데이터베이스 백업
                        </button>
                        <button onclick="clearCache()" class="btn btn-secondary">
                            <i class="fas fa-trash"></i> 캐시 정리
                        </button>
                        <button onclick="exportSystemLogs()" class="btn btn-info">
                            <i class="fas fa-file-download"></i> 시스템 로그 내보내기
                        </button>
                        <button onclick="showSystemSettings()" class="btn btn-warning">
                            <i class="fas fa-cog"></i> 고급 설정
                        </button>
                    </div>
                </div>

                <div class="recent-activities">
                    <h3>최근 활동</h3>
                    <div class="activity-list">
                        <div class="activity-item">
                            <i class="fas fa-user-plus"></i>
                            <span>새 사용자 등록: ${allUsers.length > 0 ? allUsers[0].name : '없음'}</span>
                            <time>${allUsers.length > 0 ? new Date(allUsers[0].created_at).toLocaleDateString('ko-KR') : ''}</time>
                        </div>
                        <div class="activity-item">
                            <i class="fas fa-building"></i>
                            <span>새 회사 등록: ${allCompanies.length > 0 ? allCompanies[0].company_name : '없음'}</span>
                            <time>${allCompanies.length > 0 ? new Date(allCompanies[0].created_at).toLocaleDateString('ko-KR') : ''}</time>
                        </div>
                    </div>
                </div>
            `;
        }

        // 유틸리티 함수들
        function getRoleText(role) {
            const roleMap = {
                'master': '마스터 관리자',
                'company_admin': '회사 관리자',
                'company_manager': '매니저',
                'employee': '직원'
            };
            return roleMap[role] || role;
        }
        
        function getTierDisplayName(tier) {
            const tierMap = {
                'basic': 'Basic',
                'standard': 'Standard',
                'premium': 'Premium',
                'enterprise': 'Enterprise'
            };
            return tierMap[tier] || 'Basic';
        }

        // 사용자를 대표이사로 변경
        async function changeUserToCEO(userId) {
            if (!confirm('이 사용자를 대표이사로 변경하시겠습니까?')) return;

            try {
                if (db && db.client) {
                    const { data, error } = await db.client
                        .from('users')
                        .update({ 
                            role: 'company_admin',
                            position: '대표이사'
                        })
                        .eq('id', userId);

                    if (error) throw error;
                    
                    alert('사용자가 대표이사로 변경되었습니다.');
                    await loadDashboardData();
                    renderUsersList();
                } else {
                    // 오프라인 모드
                    const userIndex = allUsers.findIndex(u => u.id == userId);
                    if (userIndex !== -1) {
                        allUsers[userIndex].role = 'company_admin';
                        allUsers[userIndex].position = '대표이사';
                        localStorage.setItem('users', JSON.stringify(allUsers));
                        renderUsersList();
                    }
                }
            } catch (error) {
                console.error('사용자 권한 변경 오류:', error);
                alert('권한 변경 중 오류가 발생했습니다.');
            }
        }

        // 회사 관리 함수
        function manageCompany(domain) {
            const company = allCompanies.find(c => c.domain === domain);
            if (!company) {
                alert('회사 정보를 찾을 수 없습니다.');
                return;
            }
            
            // 로컬 직원 대시보드로 이동 (회사 도메인을 파라미터로 전달)
            window.location.href = `employee-dashboard.html?company=${domain}`;
        }

        // 회사 홈페이지 보기 함수
        function viewCompanyHomepage(domain) {
            const company = allCompanies.find(c => c.domain === domain);
            if (!company || !company.website) {
                alert('먼저 회사의 홈페이지 주소를 설정해주세요.');
                editCompany(domain);
                return;
            }
            
            let websiteUrl = company.website;
            if (!websiteUrl.startsWith('http://') && !websiteUrl.startsWith('https://')) {
                websiteUrl = 'https://' + websiteUrl;
            }
            
            window.open(websiteUrl, '_blank');
        }

        // 회사 삭제 함수
        async function deleteCompany(domain, companyName) {
            // 삭제 확인
            const confirmMessage = `정말로 "${companyName}" 회사를 삭제하시겠습니까?\n\n⚠️ 주의: 이 작업은 되돌릴 수 없으며, 다음 데이터가 모두 삭제됩니다:\n- 회사 정보\n- 모든 직원 계정\n- 업무일지 및 문서\n- 법인카드 사용내역\n- 기타 관련 데이터\n\n삭제하려면 '${companyName}'를 입력하세요:`;
            
            const userInput = prompt(confirmMessage);
            if (userInput !== companyName) {
                if (userInput !== null) {
                    alert('회사명이 정확하지 않습니다. 삭제가 취소되었습니다.');
                }
                return;
            }

            try {
                // 로딩 표시
                const deleteBtn = event.target.closest('button');
                const originalText = deleteBtn.innerHTML;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 삭제 중...';
                deleteBtn.disabled = true;

                if (db && db.client) {
                    // Supabase에서 회사 삭제 (CASCADE로 관련 데이터도 함께 삭제됨)
                    const { error } = await db.client
                        .from('companies')
                        .delete()
                        .eq('domain', domain);

                    if (error) throw error;
                } else {
                    // 로컬 저장소에서 회사 삭제
                    const companyIndex = allCompanies.findIndex(c => c.domain === domain);
                    if (companyIndex !== -1) {
                        allCompanies.splice(companyIndex, 1);
                        localStorage.setItem('companies', JSON.stringify(allCompanies));
                    }

                    // 관련된 사용자 데이터도 삭제
                    const usersToDelete = allUsers.filter(u => u.company_domain === domain);
                    allUsers = allUsers.filter(u => u.company_domain !== domain);
                    localStorage.setItem('users', JSON.stringify(allUsers));

                    // 관련된 로컬 저장소 데이터 삭제
                    for (let i = localStorage.length - 1; i >= 0; i--) {
                        const key = localStorage.key(i);
                        if (key && (
                            key.includes(domain) || 
                            key.includes(`_${domain}_`) ||
                            usersToDelete.some(user => key.includes(`_user_${user.id}`))
                        )) {
                            localStorage.removeItem(key);
                        }
                    }
                }

                // 데이터 새로고침
                await loadDashboardData();
                updateStatistics();
                renderCompaniesList();
                renderUsersList();

                alert(`"${companyName}" 회사가 성공적으로 삭제되었습니다.`);

            } catch (error) {
                console.error('회사 삭제 오류:', error);
                alert('회사 삭제 중 오류가 발생했습니다: ' + error.message);
                
                // 버튼 복원
                if (deleteBtn) {
                    deleteBtn.innerHTML = originalText;
                    deleteBtn.disabled = false;
                }
            }
        }

        // 회사 편집 모달 열기
        function editCompany(domain) {
            const company = allCompanies.find(c => c.domain === domain);
            if (!company) {
                alert('회사 정보를 찾을 수 없습니다.');
                return;
            }

            console.log('📝 editCompany - 회사 정보:', company);
            console.log('📋 tenant_settings:', company.tenant_settings);

            // tenant_settings에서 추가 정보 가져오기
            const settings = company.tenant_settings || {};

            // 기존 모달에 현재 회사 정보 채우기 (domain을 식별자로 사용)
            document.getElementById('editCompanyId').value = domain;
            document.getElementById('editCompanyName').value = company.company_name || '';
            document.getElementById('editBusinessNumber').value = company.business_number || '';
            
            // tenant_settings에서 가져오는 필드들
            document.getElementById('editCorporateNumber').value = settings.corporate_number || '';
            document.getElementById('editRepresentative').value = settings.representative || '';
            document.getElementById('editOpeningDate').value = settings.opening_date || '';
            document.getElementById('editBusinessType').value = settings.business_type || '';
            
            // 기본 필드들
            document.getElementById('editBusinessAddress').value = company.address || '';
            document.getElementById('editWebsiteUrl').value = company.website || '';
            document.getElementById('editCompanyEmail').value = company.email || '';

            // 모달 표시
            document.getElementById('editCompanyModal').style.display = 'flex';
        }

        // 회사 편집 모달 닫기
        function hideEditCompanyModal() {
            document.getElementById('editCompanyModal').style.display = 'none';
        }

        // 회사 정보 수정 처리
        async function handleEditCompany(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const companyId = formData.get('editCompanyId');
            
            const updateData = {
                company_name: formData.get('editCompanyName').trim(),
                business_number: formData.get('editBusinessNumber').trim(),
                corporate_number: formData.get('editCorporateNumber').trim(),
                representative: formData.get('editRepresentative').trim(),
                opening_date: formData.get('editOpeningDate'),
                address: formData.get('editBusinessAddress').trim(),
                business_type: formData.get('editBusinessType').trim(),
                website: formData.get('editWebsiteUrl').trim(),
                email: formData.get('editCompanyEmail').trim()
            };

            // 필수 필드 검증
            if (!updateData.company_name) {
                alert('법인명(단체명)은 필수 항목입니다.');
                return;
            }
            if (!updateData.business_number) {
                alert('사업자등록번호는 필수 항목입니다.');
                return;
            }
            if (!updateData.representative) {
                alert('대표자명은 필수 항목입니다.');
                return;
            }

            try {
                // domain으로 회사 찾기
                const companyIndex = allCompanies.findIndex(c => c.domain === companyId);
                
                if (companyIndex !== -1) {
                    companies[companyIndex] = { ...companies[companyIndex], ...updateData };
                    localStorage.setItem('companies', JSON.stringify(companies));
                    
                    // 전역 변수 업데이트
                    allCompanies = companies;
                    
                    // UI 업데이트
                    renderCompaniesList();
                    updateCompanyFilterDropdown();
                    updateStatistics();
                    
                    // 모달 닫기
                    hideEditCompanyModal();
                    
                    alert('회사 정보가 성공적으로 수정되었습니다.');
                } else {
                    alert('회사 정보를 찾을 수 없습니다.');
                }
                
            } catch (error) {
                console.error('회사 정보 수정 오류:', error);
                alert('회사 정보 수정 중 오류가 발생했습니다: ' + error.message);
            }
        }

        async function addNewCompany() {
            const companyName = prompt('새 회사명을 입력하세요:');
            if (!companyName) return;

            const domain = prompt('회사 도메인을 입력하세요 (예: company.com):');
            if (!domain) return;

            const website = prompt('회사 홈페이지 주소를 입력하세요:\n(예: https://consil800.com 또는 consil800.com)', '');
            // website가 null이면 취소 버튼을 누른 것
            if (website === null) return;

            try {
                const result = await domainManager.registerCompany({
                    companyName,
                    domain,
                    website,
                    adminData: {
                        username: 'admin',
                        password: 'admin123',
                        name: '관리자'
                    }
                });

                if (result.success) {
                    alert('새 회사가 성공적으로 등록되었습니다.');
                    await loadDashboardData();
                    updateStatistics();
                    renderCompaniesList();
                } else {
                    alert('회사 등록 실패: ' + result.error);
                }
            } catch (error) {
                console.error('회사 등록 오류:', error);
                alert('회사 등록 중 오류가 발생했습니다.');
            }
        }

        async function editUser(userId) {
            const user = allUsers.find(u => u.id == userId);
            if (!user) return;

            const newName = prompt('새 이름을 입력하세요:', user.name);
            if (!newName) return;

            try {
                if (db && db.client) {
                    const { error } = await db.client
                        .from('users')
                        .update({ name: newName })
                        .eq('id', userId);

                    if (error) throw error;
                    await loadDashboardData();
                    renderUsersList();
                    alert('사용자 정보가 수정되었습니다.');
                } else {
                    const userIndex = allUsers.findIndex(u => u.id == userId);
                    if (userIndex !== -1) {
                        allUsers[userIndex].name = newName;
                        localStorage.setItem('users', JSON.stringify(allUsers));
                        renderUsersList();
                        alert('사용자 정보가 수정되었습니다.');
                    }
                }
            } catch (error) {
                console.error('사용자 정보 수정 오류:', error);
                alert('사용자 정보 수정 중 오류가 발생했습니다.');
            }
        }

        async function resetUserPassword(userId) {
            if (!confirm('이 사용자의 비밀번호를 초기화하시겠습니까?')) return;

            const newPassword = 'reset123';

            try {
                if (db && db.client) {
                    const { error } = await db.client
                        .from('users')
                        .update({ password: newPassword })
                        .eq('id', userId);

                    if (error) throw error;
                    alert(`비밀번호가 "${newPassword}"로 초기화되었습니다.`);
                } else {
                    const userIndex = allUsers.findIndex(u => u.id == userId);
                    if (userIndex !== -1) {
                        allUsers[userIndex].password = newPassword;
                        localStorage.setItem('users', JSON.stringify(allUsers));
                        alert(`비밀번호가 "${newPassword}"로 초기화되었습니다.`);
                    }
                }
            } catch (error) {
                console.error('비밀번호 초기화 오류:', error);
                alert('비밀번호 초기화 중 오류가 발생했습니다.');
            }
        }

        function manageCompanyPermissions(domain) {
            alert(`${domain} 회사의 권한을 관리합니다. (구현 예정)`);
        }

        function backupDatabase() {
            alert('데이터베이스 백업을 시작합니다. (구현 예정)');
        }

        function clearCache() {
            localStorage.clear();
            sessionStorage.clear();
            alert('캐시가 정리되었습니다.');
        }

        function exportSystemLogs() {
            alert('시스템 로그를 내보냅니다. (구현 예정)');
        }

        function showSystemSettings() {
            alert('고급 설정 화면입니다. (구현 예정)');
        }

        function showAddCompanyModal() {
            addNewCompany();
        }

        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userRole');
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        function viewCompanyDashboard(companyId) {
            console.log('Viewing company dashboard:', companyId);
            window.location.href = `../3-company-dashboards/${companyId}/admin/index.html`;
        }



        // 사용자 관리 함수
        function editUser(userId) {
            console.log('Editing user:', userId);
            console.log('allUsers 배열:', allUsers);
            console.log('찾는 사용자 ID:', userId, typeof userId);
            
            // allUsers 배열에서 사용자 찾기 (문자열 및 숫자 비교 모두 시도)
            const user = allUsers.find(u => {
                console.log(`비교: ${u.id} (${typeof u.id}) === ${userId} (${typeof userId})`);
                return String(u.id) === String(userId) || u.id === userId;
            });
            
            console.log('찾은 사용자:', user);
            
            if (!user) {
                console.error('사용자를 찾을 수 없습니다. allUsers:', allUsers);
                alert('사용자를 찾을 수 없습니다.');
                return;
            }
            
            // 모달에 현재 사용자 정보 설정
            const editUserIdEl = document.getElementById('editUserId');
            const editUserNameEl = document.getElementById('editUserName');
            const editUserPhoneEl = document.getElementById('editUserPhone');
            const editUserDepartmentEl = document.getElementById('editUserDepartment');
            const editUserEmailEl = document.getElementById('editUserEmail');
            
            console.log('🔍 모달 요소들 확인:', {
                editUserId: editUserIdEl,
                editUserName: editUserNameEl,
                editUserPhone: editUserPhoneEl,
                editUserDepartment: editUserDepartmentEl,
                editUserEmail: editUserEmailEl
            });
            
            if (!editUserIdEl || !editUserNameEl || !editUserPhoneEl || !editUserDepartmentEl || !editUserEmailEl) {
                console.error('❌ 모달 요소를 찾을 수 없음');
                alert('편집 폼을 찾을 수 없습니다. 페이지를 새로고침해주세요.');
                return;
            }
            
            editUserIdEl.value = user.id;
            editUserNameEl.value = user.name || user.username || '';
            editUserPhoneEl.value = user.phone || '';
            editUserDepartmentEl.value = user.department || '';
            // 이메일은 username에 @ 포함시 기본값으로 설정, 없으면 빈값
            editUserEmailEl.value = user.email || (user.username && user.username.includes('@') ? user.username : '');
            
            console.log('✅ 모달에 사용자 정보 설정 완료:', {
                id: editUserIdEl.value,
                name: editUserNameEl.value,
                phone: editUserPhoneEl.value,
                department: editUserDepartmentEl.value,
                email: editUserEmailEl.value
            });
            
            // 모달 표시
            document.getElementById('editUserModal').style.display = 'flex';
        }

        // 사용자 편집 모달 닫기
        function hideEditUserModal() {
            const modal = document.getElementById('editUserModal');
            modal.style.display = 'none';
            
            // 데이터 속성 정리
            modal.removeAttribute('data-company-id');
            modal.removeAttribute('data-representative-key');
        }

        // 사용자 편집 폼 처리
        async function handleEditUser(event) {
            event.preventDefault();
            console.log('🔥🔥🔥 handleEditUser 함수 실행됨!');
            
            // 폼 데이터 직접 가져오기 (더 안전한 방법)
            const form = event.target;
            const userId = form.querySelector('#editUserId').value;
            const newName = form.querySelector('#editUserName').value.trim();
            const newPhone = form.querySelector('#editUserPhone').value.trim();
            const newDepartment = form.querySelector('#editUserDepartment').value.trim();
            const newEmail = form.querySelector('#editUserEmail').value.trim();
            
            console.log('📝 폼에서 가져온 데이터:', { userId, newName, newPhone, newDepartment, newEmail });
            
            // FormData로도 확인 (디버깅용)
            const formData = new FormData(event.target);
            console.log('📋 FormData 검증:', {
                userId: formData.get('editUserId'),
                name: formData.get('editUserName'),
                phone: formData.get('editUserPhone'),
                department: formData.get('editUserDepartment'),
                email: formData.get('editUserEmail')
            });
            
            if (!newName) {
                alert('이름은 필수 항목입니다.');
                return;
            }
            
            // 모달에서 회사 정보 가져오기
            const modal = document.getElementById('editUserModal');
            const companyId = modal.getAttribute('data-company-id');
            const representativeKey = modal.getAttribute('data-representative-key');
            
            console.log('🏢 회사 정보:', { companyId, representativeKey });
            
            // 회사 대표 편집 처리
            if (companyId && representativeKey) {
                console.log('✅ 회사 대표 편집 확인됨');
                
                const representative = JSON.parse(localStorage.getItem(representativeKey) || 'null');
                console.log('📋 기존 대표 정보:', representative);
                
                if (!representative) {
                    alert('대표 정보를 찾을 수 없습니다.');
                    return;
                }
                
                // 대표 정보 업데이트
                const updatedRepresentative = {
                    ...representative,
                    name: newName,
                    phone: newPhone,
                    email: newEmail,
                    updatedAt: new Date().toISOString()
                };
                
                console.log('💾 저장할 데이터:', updatedRepresentative);
                console.log('🔑 저장할 키:', representativeKey);
                
                // 저장 전 기존 데이터 백업
                const backupKey = representativeKey + '_backup';
                localStorage.setItem(backupKey, JSON.stringify(representative));
                
                // 메인 데이터 저장
                localStorage.setItem(representativeKey, JSON.stringify(updatedRepresentative));
                
                // 즉시 확인
                const check = JSON.parse(localStorage.getItem(representativeKey));
                console.log('✅ 저장 확인:', check);
                
                if (check && check.name === newName && check.phone === newPhone && check.email === newEmail) {
                    console.log('✅ 데이터 저장 성공 확인됨');
                    
                    // 모달 닫기
                    hideEditUserModal();
                    
                    // 약간의 지연 후 렌더링 (localStorage 반영 시간 확보)
                    console.log('🔄 편집 완료 후 렌더링 시작');
                    setTimeout(() => {
                        renderUsersList();
                        console.log('🎉 편집 완료 및 렌더링 완료!');
                    }, 150);
                    
                } else {
                    console.log('❌ 데이터 저장 실패 - 백업에서 복원');
                    localStorage.setItem(representativeKey, localStorage.getItem(backupKey));
                    alert('데이터 저장에 실패했습니다. 다시 시도해주세요.');
                }
                
                return;
            }
            
            // 일반 사용자 편집 처리 (데이터베이스)
            console.log('📝 일반 사용자 편집 처리 시작');
            
            // allUsers 배열에서 사용자 찾기
            const userIndex = allUsers.findIndex(u => String(u.id) === String(userId));
            
            if (userIndex === -1) {
                console.error('❌ allUsers에서 사용자를 찾을 수 없음:', userId);
                alert('사용자를 찾을 수 없습니다.');
                return;
            }
            
            const user = allUsers[userIndex];
            console.log('✅ 편집할 사용자 찾음:', user);
            
            // 사용자 정보 업데이트
            const updatedUser = {
                ...user,
                name: newName,
                phone: newPhone || user.phone,
                department: newDepartment || user.department,
                email: newEmail || user.email,
                updated_at: new Date().toISOString()
            };
            
            console.log('💾 업데이트할 사용자 데이터:', updatedUser);
            
            // allUsers 배열 업데이트
            allUsers[userIndex] = updatedUser;
            
            // 데이터베이스 업데이트 시도
            if (typeof db !== 'undefined' && db.updateUser) {
                console.log('🗄️ 데이터베이스 업데이트 시도');
                
                try {
                    const updateData = {
                        name: newName,
                        updated_at: new Date().toISOString()
                    };
                    
                    // department는 users 테이블에 있는 컬럼이므로 포함
                    if (newDepartment !== undefined) {
                        updateData.department = newDepartment;
                    }
                    
                    // phone과 email 컬럼이 이제 추가되었으므로 포함
                    if (newPhone !== undefined) {
                        updateData.phone = newPhone;
                    }
                    
                    if (newEmail !== undefined) {
                        updateData.email = newEmail;
                    }
                    
                    const result = await db.updateUser(userId, updateData);
                    
                    if (result.success) {
                        console.log('✅ 데이터베이스 업데이트 성공');
                        
                        // 모달 닫기
                        hideEditUserModal();
                        
                        // 사용자 목록 새로고침
                        setTimeout(() => {
                            renderUsersList();
                            console.log('🎉 사용자 편집 완료!');
                        }, 150);
                    } else {
                        console.error('❌ 데이터베이스 업데이트 실패:', result.error);
                        // 배열 롤백
                        allUsers[userIndex] = user;
                        alert('데이터베이스 업데이트에 실패했습니다: ' + result.error);
                    }
                } catch (error) {
                    console.error('❌ 데이터베이스 업데이트 중 오류:', error);
                    // 배열 롤백
                    allUsers[userIndex] = user;
                    alert('데이터베이스 업데이트 중 오류가 발생했습니다.');
                }
            } else {
                console.error('⚠️ 데이터베이스 연결 없음');
                alert('데이터베이스 연결이 필요합니다.');
            }
        }

        // 사용자 삭제 처리
        async function handleDeleteUser() {
            const userId = document.getElementById('editUserId').value;
            const userName = document.getElementById('editUserName').value;
            
            // 삭제 확인 다이얼로그
            const confirmDelete = confirm(`정말로 '${userName}' 사용자를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`);
            
            if (!confirmDelete) {
                return;
            }
            
            console.log('🗑️ 사용자 삭제 시작:', userId, userName);
            
            try {
                // allUsers 배열에서 사용자 찾기
                const userIndex = allUsers.findIndex(u => String(u.id) === String(userId));
                
                if (userIndex === -1) {
                    console.error('❌ allUsers에서 사용자를 찾을 수 없음:', userId);
                    alert('사용자를 찾을 수 없습니다.');
                    return;
                }
                
                const user = allUsers[userIndex];
                console.log('✅ 삭제할 사용자 찾음:', user);
                
                // 데이터베이스 삭제 시도
                if (typeof db !== 'undefined' && db.deleteUser) {
                    console.log('🗄️ 데이터베이스에서 사용자 삭제 시도');
                    
                    const result = await db.deleteUser(userId);
                    
                    if (result.success) {
                        console.log('✅ 데이터베이스에서 사용자 삭제 성공');
                        
                        // allUsers 배열에서 제거
                        allUsers.splice(userIndex, 1);
                        
                        // 모달 닫기
                        hideEditUserModal();
                        
                        // 사용자 목록 새로고침
                        setTimeout(() => {
                            renderUsersList();
                            console.log('🎉 사용자 삭제 완료!');
                            alert('사용자가 성공적으로 삭제되었습니다.');
                        }, 150);
                    } else {
                        console.error('❌ 데이터베이스 삭제 실패:', result.error);
                        alert('데이터베이스 삭제에 실패했습니다: ' + result.error);
                    }
                } else {
                    console.error('⚠️ 데이터베이스 연결 없음');
                    alert('데이터베이스 연결이 필요합니다.');
                }
                
            } catch (error) {
                console.error('❌ 사용자 삭제 중 오류:', error);
                alert('사용자 삭제 중 오류가 발생했습니다.');
            }
        }

        function viewUserActivity(userId) {
            console.log('Viewing user activity:', userId);
            
            const users = JSON.parse(localStorage.getItem('platform_users') || '[]');
            const user = users.find(u => u.id === userId);
            
            if (!user) {
                showNotification('사용자를 찾을 수 없습니다.', 'error');
                return;
            }
            
            // 간단한 활동 내역 표시
            const activity = [
                '로그인: 2024-06-12 09:00',
                '홈페이지 수정: 2024-06-11 14:30',
                '직원 추가: 2024-06-10 16:45'
            ];
            
            alert(`${user.name}의 최근 활동:\n\n${activity.join('\n')}`);
        }

        // [삭제됨 - 중복 renderUsersList 함수]
        /* 구버전 renderUsersList 삭제 시작
        function renderUsersList() {
            console.log('🔄 사용자 목록 렌더링 시작');
            
            // 강제로 데이터 새로고침을 위해 약간의 지연
            const companies = JSON.parse(localStorage.getItem('platform_companies') || '[]');
            const usersList = document.getElementById('usersList');
            
            if (!usersList) {
                console.log('❌ usersList 요소를 찾을 수 없습니다');
                return;
            }
            
            if (companies.length === 0) {
                usersList.innerHTML = '<p style="text-align: center; color: #9ca3af;">등록된 회사가 없습니다.</p>';
                return;
            }
            
            // 대표 데이터가 없을 때만 생성 (기존 데이터 보존)
            console.log('🔧 사용자 목록 렌더링 - 대표 데이터 확인 및 필요시 생성');
            ensureRepresentativesExistOnce();
            
            // 각 회사의 대표 정보 가져오기 (별도 저장된 대표 데이터 사용)
            const representativeUsers = [];
            
            console.log('🏢 등록된 회사 목록:', companies.map(c => c.companyName));
            
            companies.forEach(company => {
                const representativeKey = `company_${company.id}_representative`;
                // 강제로 최신 데이터를 가져오기 위해 다시 localStorage에서 읽기
                const representative = JSON.parse(localStorage.getItem(representativeKey) || 'null');
                
                console.log(`📊 ${company.companyName} (${company.id}) 대표:`, representative?.name || '없음');
                console.log(`🔑 저장 키: ${representativeKey}`);
                console.log(`📝 대표 전체 정보:`, representative);
                
                if (representative) {
                    representativeUsers.push({
                        ...representative,
                        companyName: company.companyName,
                        companyId: company.id
                    });
                    console.log(`✅ ${company.companyName} 대표 추가됨: ${representative.name} (${representative.phone || '연락처 없음'}) (${representative.email || '이메일 없음'})`);
                } else {
                    console.log(`❌ ${company.companyName}에 대표가 없습니다`);
                }
            });
            
            console.log('👥 대표 사용자 목록:', representativeUsers);
            
            if (representativeUsers.length === 0) {
                usersList.innerHTML = '<p style="text-align: center; color: #9ca3af;">등록된 대표가 없습니다. 잠시 후 다시 시도해주세요.</p>';
                
                // 즉시 대표 데이터 생성 시도 (자동 재시도 제거)
                console.log('🔄 대표 데이터 즉시 생성 시도');
                ensureCompanyRepresentativesExist();
                ensureRepresentativesExistOnce();
                // 자동 재시도 제거 - 사용자가 직접 탭을 다시 클릭하도록 안내
                return;
            }
            
            const htmlContent = representativeUsers.map(user => `
                <div class="company-item">
                    <div class="company-info">
                        <h3>${user.name} (${user.position || '대표이사'})</h3>
                        <p>${user.companyName} | ${user.email || '이메일 없음'} | 회사 대표</p>
                        <p>연락처: ${user.phone || '미설정'} | 부서: ${user.department || '경영진'}</p>
                    </div>
                    <div class="company-actions">
                        <button class="btn btn-primary" onclick="editCompanyRepresentative('${user.companyId}', '${user.id}')">
                            <i class="fas fa-edit"></i> 편집
                        </button>
                    </div>
                </div>
            `).join('');
            
            // 즉시 DOM 업데이트
            usersList.innerHTML = htmlContent;
            console.log('✅ 사용자 목록 렌더링 완료');
            console.log('🎨 렌더링된 HTML:', htmlContent.substring(0, 200) + '...');
            
            // 강제로 브라우저 리플로우 발생
            usersList.offsetHeight;
        }
        구버전 renderUsersList 삭제 끝 */
        
        // 디버깅 및 문제 해결 유틸리티 함수들
        window.debugEditFunction = function() {
            console.log('🔧 편집 기능 디버깅 정보');
            
            // 모달 상태 확인
            const modal = document.getElementById('editUserModal');
            console.log('📊 모달 상태:', {
                존재함: !!modal,
                표시됨: modal?.style.display,
                companyId: modal?.getAttribute('data-company-id'),
                representativeKey: modal?.getAttribute('data-representative-key')
            });
            
            // 폼 상태 확인
            const form = document.getElementById('editUserForm');
            console.log('📊 폼 상태:', {
                존재함: !!form,
                onsubmit: form?.getAttribute('onsubmit'),
                이벤트리스너: form?._eventListeners
            });
            
            // localStorage 데이터 확인
            const companies = JSON.parse(localStorage.getItem('platform_companies') || '[]');
            companies.forEach(company => {
                const key = `company_${company.id}_representative`;
                const data = localStorage.getItem(key);
                console.log(`📊 ${company.companyName} 대표 데이터:`, JSON.parse(data || 'null'));
            });
        };
        
        window.forceFixRepresentatives = function() {
            console.log('🔧 대표 데이터 강제 수정');
            
            // 고강석 대표 강제 업데이트
            const testCompanyKey = 'company_test-company-1_representative';
            const newData = {
                id: 'test-company-1-rep',
                name: '고강석',
                position: '대표이사', 
                department: '경영진',
                email: 'ceo123@testcompany1.co.kr',
                phone: '010-1234-1234',
                role: 'company_representative',
                companyId: 'test-company-1',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                status: 'active'
            };
            
            localStorage.setItem(testCompanyKey, JSON.stringify(newData));
            console.log('✅ 고강석 대표 데이터 강제 업데이트 완료');
            
            renderUsersList();
        };

        // 회사 대표 데이터 생성 및 확인 (샘플 데이터 제거됨)
        function ensureCompanyRepresentativesExist() {
            console.log('🔍 회사 대표 데이터 존재 확인');
            
            const companies = JSON.parse(localStorage.getItem('platform_companies') || '[]');
            
            // 데이터베이스에서 회사 데이터를 가져오므로 하드코딩된 샘플 데이터 제거
            console.log('📊 실제 데이터베이스 회사 정보 사용');
        }
        
        // 대표 데이터가 없을 때만 생성 (샘플 데이터 제거됨)
        function ensureRepresentativesExistOnce() {
            console.log('🔧 대표 데이터 존재 확인 및 필요시 생성');
            
            const companies = JSON.parse(localStorage.getItem('platform_companies') || '[]');
            
            companies.forEach(company => {
                const representativeKey = `company_${company.id}_representative`;
                const existing = localStorage.getItem(representativeKey);
                
                if (!existing) {
                    console.log(`🆕 ${company.companyName}에 대표 데이터가 없어서 기본 생성합니다`);
                    
                    // 기본 대표 정보 (하드코딩된 샘플 데이터 제거)
                    const defaultRepresentative = {
                        id: `${company.id}-rep`,
                        name: '대표이사',
                        position: '대표이사',
                        department: '경영진',
                        email: `ceo@${company.id}.co.kr`,
                        phone: '010-0000-0000',
                        role: 'company_representative',
                        companyId: company.id,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        status: 'active'
                    };
                    
                    localStorage.setItem(representativeKey, JSON.stringify(defaultRepresentative));
                    console.log(`✅ 대표 생성: ${defaultRepresentative.name} (${representativeKey})`);
                } else {
                    console.log(`📋 ${company.companyName}에 기존 대표 데이터가 있습니다 - 보존`);
                }
            });
        }
        
        // 샘플 데이터 생성 함수 제거됨 - 데이터베이스에서 실제 데이터 사용
        
        // 디버깅용 - localStorage 확인
        function debugLocalStorage() {
            console.log('🔧 localStorage 디버깅:');
            const keys = Object.keys(localStorage);
            const repKeys = keys.filter(key => key.includes('_representative'));
            console.log('대표 관련 키들:', repKeys);
            
            repKeys.forEach(key => {
                const data = localStorage.getItem(key);
                console.log(`${key}:`, JSON.parse(data));
            });
        }
        
        // 디버깅용 - 대표 데이터 완전 초기화
        function resetRepresentativeData() {
            console.log('🔧 대표 데이터 완전 초기화');
            const keys = Object.keys(localStorage);
            const repKeys = keys.filter(key => key.includes('_representative'));
            
            repKeys.forEach(key => {
                localStorage.removeItem(key);
                console.log(`❌ 삭제됨: ${key}`);
            });
            
            console.log('✅ 대표 데이터 초기화 완료');
            forceCreateRepresentatives();
            renderUsersList();
        }

        function editCompanyRepresentative(companyId, userId) {
            console.log('📝 회사 대표 편집:', companyId, userId);
            
            const representativeKey = `company_${companyId}_representative`;
            const representative = JSON.parse(localStorage.getItem(representativeKey) || 'null');
            
            console.log('🔍 로드된 대표 정보:', representative);
            console.log('🔑 사용된 키:', representativeKey);
            
            if (!representative) {
                alert('대표 정보를 찾을 수 없습니다.');
                console.log('❌ 대표 정보가 없습니다');
                return;
            }
            
            // 모달에 현재 대표 정보 설정
            document.getElementById('editUserId').value = representative.id;
            document.getElementById('editUserName').value = representative.name || '';
            document.getElementById('editUserPhone').value = representative.phone || '';
            document.getElementById('editUserEmail').value = representative.email || '';
            
            console.log('📋 모달에 설정된 값들:', {
                id: representative.id,
                name: representative.name,
                phone: representative.phone,
                email: representative.email
            });
            
            // 회사 정보도 저장 (폼 처리에서 사용)
            const modal = document.getElementById('editUserModal');
            modal.setAttribute('data-company-id', companyId);
            modal.setAttribute('data-representative-key', representativeKey);
            
            console.log('🏢 모달에 설정된 회사 정보:', {
                companyId: companyId,
                representativeKey: representativeKey
            });
            
            // 모달 표시
            modal.style.display = 'flex';
            console.log('✅ 모달 표시 완료');
        }


        // 회사 목록 업데이트 (샘플 데이터 자동 생성 제거)
        function updateCompanyList() {
            const companies = JSON.parse(localStorage.getItem('platform_companies') || '[]');
            
            // 샘플 회사 자동 생성 로직 제거 - 데이터베이스에서만 실제 회사 데이터 사용
            console.log('📊 실제 등록된 회사만 표시:', companies.length, '개');
            
            // 회사 목록 동적 렌더링
            const companyListContainer = document.querySelector('.company-list');
            if (companyListContainer) {
                const currentCompanies = JSON.parse(localStorage.getItem('platform_companies') || '[]');
                console.log('🏢 렌더링할 회사 목록:', currentCompanies);
                
                companyListContainer.innerHTML = currentCompanies.map(company => `
                    <div class="company-item">
                        <div class="company-info">
                            <h3>${company.companyName || company.name}</h3>
                            <p>가입일: ${new Date(company.createdAt).toLocaleDateString('ko-KR')} | 사용자: ${company.users || 0}명 | 상태: ${company.status === 'active' ? '활성' : '비활성'}</p>
                            ${company.businessType ? `<p>업종: ${company.businessType}</p>` : ''}
                            ${company.domainUrl ? `<p>도메인: <a href="${company.domainUrl}" target="_blank" style="color: #667eea;">${company.domainUrl}</a></p>` : ''}
                        </div>
                        <div class="company-actions">
                            <button class="btn btn-primary" onclick="manageCompany('${company.id}')">
                                <i class="fas fa-cog"></i> 관리
                            </button>
                            <button class="btn btn-secondary" onclick="viewCompanyHomepage('${company.id}', '${company.templateSelect}')">
                                <i class="fas fa-globe"></i> 홈페이지
                            </button>
                            <button class="btn btn-secondary" onclick="showEditCompanyModal('${company.id}')">
                                <i class="fas fa-edit"></i> 편집
                            </button>
                            <button class="btn btn-danger" onclick="deleteCompany('${company.id}', '${company.companyName || company.name}')">
                                <i class="fas fa-trash"></i> 삭제
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            // 통계 업데이트
            const currentCompanies = JSON.parse(localStorage.getItem('platform_companies') || '[]');
            const totalCompanies = currentCompanies.length || 3;
            const totalUsers = currentCompanies.reduce((sum, company) => sum + (company.users || 0), 0) || 248;
            
            document.querySelector('#totalCompanies .value').textContent = totalCompanies;
            document.querySelector('#totalUsers .value').textContent = totalUsers;
            
            // 마스터 대시보드 통계 동기화
            updateStatistics();
        }

        // 알림 표시 함수
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 12px;
                min-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            
            const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';
            const color = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
            
            notification.innerHTML = `
                <div style="width: 24px; height: 24px; background: ${color}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                    ${icon}
                </div>
                <div style="flex: 1; color: #1f2937;">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 설정 저장 함수
        function savePermissions() {
            console.log('Saving permissions');
            showNotification('권한 설정이 저장되었습니다.', 'success');
        }

        function saveSystemSettings() {
            console.log('Saving system settings');
            showNotification('시스템 설정이 저장되었습니다.', 'success');
        }

        // 로그아웃 함수
        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userName');
                window.location.href = '../../1-homepage/templates/index.html';
            }
        }

        // 모달 관리 함수
        function showAddCompanyModal() {
            const modal = document.getElementById('addCompanyModal');
            modal.style.display = 'flex';
        }

        function hideAddCompanyModal() {
            const modal = document.getElementById('addCompanyModal');
            modal.style.display = 'none';
            
            // 폼 초기화
            document.getElementById('addCompanyForm').reset();
        }

        // 회사 등록 처리 함수
        function handleAddCompany(event) {
            console.log('🚀 handleAddCompany 함수 시작');
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const companyData = {
                id: generateCompanyId(formData.get('companyName')),
                companyName: formData.get('companyName'),
                businessNumber: formData.get('businessNumber'),
                corporateNumber: formData.get('corporateNumber'),
                representative: formData.get('representative'),
                openingDate: formData.get('openingDate'),
                businessAddress: formData.get('businessAddress'),
                businessType: formData.get('businessType'),
                templateSelect: formData.get('templateSelect'),
                domainUrl: formData.get('domainUrl') || '',
                status: 'active',
                createdAt: new Date().toISOString(),
                users: 0
            };
            
            console.log('📋 수집된 회사 데이터:', companyData);
            
            // 입력 유효성 검사
            console.log('✅ 유효성 검사 시작');
            const validationResult = validateCompanyData(companyData);
            if (!validationResult.isValid) {
                console.log('❌ 유효성 검사 실패:', validationResult.message);
                showNotification(validationResult.message, 'error');
                return;
            }
            console.log('✅ 유효성 검사 통과');
            
            // 중복 체크
            console.log('🔍 중복 체크 시작');
            const duplicateCheck = checkDuplicateCompany(companyData);
            if (!duplicateCheck.isValid) {
                console.log('❌ 중복 체크 실패:', duplicateCheck.message);
                showNotification(duplicateCheck.message, 'error');
                return;
            }
            console.log('✅ 중복 체크 통과');
            
            // 로컬스토리지에 회사 정보 저장
            console.log('💾 localStorage에 회사 정보 저장 시작');
            const companies = JSON.parse(localStorage.getItem('platform_companies') || '[]');
            console.log('📂 기존 회사 목록:', companies);
            companies.push(companyData);
            localStorage.setItem('platform_companies', JSON.stringify(companies));
            console.log('💾 회사 정보 저장 완료. 총 회사 수:', companies.length);
            
            // 선택한 템플릿에 회사 정보 적용
            console.log('🎨 템플릿에 회사 정보 적용 시작');
            applyCompanyDataToTemplate(companyData);
            
            // 성공 메시지
            console.log('🎉 성공 메시지 표시');
            showNotification(`${companyData.companyName} 회사가 성공적으로 등록되었습니다.`, 'success');
            
            // 모달 닫기
            console.log('❌ 모달 닫기');
            hideAddCompanyModal();
            
            // 회사 목록 업데이트
            console.log('🔄 회사 목록 업데이트 시작');
            updateCompanyList();
            
            // 마스터 대시보드 통계 동기화
            console.log('📊 통계 동기화 시작');
            updateStatistics();
            
            console.log('✅ handleAddCompany 함수 완료');
        }

        // 회사 ID 생성 함수
        function generateCompanyId(companyName) {
            return companyName
                .toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9가-힣-]/g, '')
                .substring(0, 20);
        }

        // 회사 데이터를 선택한 템플릿에 적용하는 함수
        function applyCompanyDataToTemplate(companyData) {
            const templateKey = `template_${companyData.templateSelect}_settings`;
            
            // 전화번호 생성 (사업자등록번호 기반으로 간단한 로직)
            const phoneNumber = generatePhoneNumber(companyData.businessNumber);
            
            // 템플릿별 맞춤형 메시지 생성
            const templateMessages = {
                'scout': `${companyData.companyName}과 함께하는 글로벌 철강 솔루션`,
                'dewi': `전통과 신뢰의 철강전문기업 ${companyData.companyName}`,
                'visible': `첨단 기술로 미래를 연결하는 ${companyData.companyName}`,
                'nice-restaurant': `최고 품질의 철강 소재로 당신의 꿈을 실현하는 ${companyData.companyName}`,
                'instant': `믿을 수 있는 철강 솔루션 ${companyData.companyName}`,
                'upconstruction': `건설용 철강재 전문기업 ${companyData.companyName}`,
                'gp': `글로벌 파트너십으로 성장하는 ${companyData.companyName}`,
                'blogy': `철강 산업의 새로운 이야기를 만드는 ${companyData.companyName}`,
                'iportfolio': `철강 기술 혁신의 포트폴리오 ${companyData.companyName}`
            };
            
            const subTitleMessages = {
                'scout': `${companyData.businessType} 분야의 글로벌 리더로서 최고 품질의 제품과 서비스를 제공합니다.`,
                'dewi': `35년 전통의 철강 제조 기술로 최고 품질의 제품을 만들어가는 ${companyData.companyName}입니다.`,
                'visible': `4차 산업혁명 시대에 맞춘 첨단 철강 기술로 혁신적인 솔루션을 제공합니다.`,
                'nice-restaurant': `자동차 산업의 핵심 소재로 고객의 성공을 함께 만들어갑니다.`,
                'instant': `30년 전통의 기술력과 혁신으로 고객의 성공을 지원하는 최고의 철강 제품을 제공합니다.`,
                'upconstruction': `건설 현장의 든든한 파트너로서 최고 품질의 건설용 철강재를 공급합니다.`,
                'gp': `글로벌 네트워크와 첨단 기술력으로 세계 시장에서 경쟁력을 확보하고 있습니다.`,
                'blogy': `철강 산업의 트렌드와 혁신 기술을 선도하는 전문 기업입니다.`,
                'iportfolio': `다양한 산업 분야의 철강 솔루션 포트폴리오를 제공하는 전문 기업입니다.`
            };
            
            const templateSettings = {
                basic: {
                    companyName: companyData.companyName,
                    mainTitle: templateMessages[companyData.templateSelect] || `${companyData.companyName}에 오신 것을 환영합니다`,
                    subTitle: subTitleMessages[companyData.templateSelect] || `${companyData.businessType} 분야의 전문기업 ${companyData.companyName}입니다.`,
                    phone: phoneNumber,
                    address: companyData.businessAddress,
                    email: `info@${companyData.id}.co.kr`,
                    representative: companyData.representative
                },
                company: {
                    businessNumber: companyData.businessNumber,
                    corporateNumber: companyData.corporateNumber,
                    openingDate: companyData.openingDate,
                    businessType: companyData.businessType
                },
                applied: true,
                appliedAt: new Date().toISOString()
            };
            
            localStorage.setItem(templateKey, JSON.stringify(templateSettings));
            console.log(`템플릿 설정이 저장되었습니다: ${templateKey}`, templateSettings);
        }
        
        // 사업자등록번호를 기반으로 전화번호 생성
        function generatePhoneNumber(businessNumber) {
            if (!businessNumber) return '02-1234-5678';
            
            // 사업자등록번호에서 숫자만 추출
            const numbers = businessNumber.replace(/[^0-9]/g, '');
            if (numbers.length >= 10) {
                // 앞자리 3개, 중간 4개, 뒷자리 4개로 분할
                const area = numbers.substring(0, 3);
                const middle = numbers.substring(3, 7);
                const last = numbers.substring(7, 11);
                
                // 지역번호 매핑 (간단한 로직)
                const areaCode = ['02', '031', '032', '033', '041', '042', '043', '051', '052', '053', '054', '055', '061', '062', '063', '064'][parseInt(area.charAt(0)) % 16];
                
                return `${areaCode}-${middle.substring(0, 4)}-${last.substring(0, 4)}`;
            }
            
            return '02-1234-5678'; // 기본값
        }

        // 회사 삭제 함수
        function deleteCompany(companyId, companyName) {
            if (confirm(`정말로 "${companyName}" 회사를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없으며, 해당 회사의 모든 데이터가 영구적으로 삭제됩니다.`)) {
                // localStorage에서 회사 정보 삭제
                const companies = JSON.parse(localStorage.getItem('platform_companies') || '[]');
                const updatedCompanies = companies.filter(company => company.id !== companyId);
                localStorage.setItem('platform_companies', JSON.stringify(updatedCompanies));
                
                // 해당 회사의 템플릿 설정도 삭제
                const templateKey = `template_${companies.find(c => c.id === companyId)?.templateSelect}_settings`;
                localStorage.removeItem(templateKey);
                
                // 성공 메시지
                showNotification(`${companyName} 회사가 성공적으로 삭제되었습니다.`, 'success');
                
                // 회사 목록 업데이트
                updateCompanyList();
                
                // 마스터 대시보드 통계 동기화
                updateStatistics();
            }
        }

        // 회사 편집 모달 표시 함수
        function showEditCompanyModal(companyId) {
            console.log('🔧 편집 모달 열기 - 전달받은 회사 ID:', companyId, typeof companyId);
            
            // allCompanies 변수에서 회사 찾기 (데이터베이스에서 로드된 실제 데이터)
            console.log('📊 allCompanies 전체 목록:', allCompanies);
            console.log('📊 각 회사의 ID 정보:', allCompanies.map(c => ({id: c.id, name: c.company_name, domain: c.domain, type: typeof c.id})));
            
            const company = allCompanies.find(c => {
                console.log(`ID 비교: ${c.id} (${typeof c.id}) === ${companyId} (${typeof companyId}) || ${c.domain} === ${companyId}`);
                return String(c.id) === String(companyId) || String(c.domain) === String(companyId);
            });
            
            console.log('🎯 찾은 회사:', company);
            
            if (!company) {
                console.error('❌ 회사를 찾을 수 없음');
                showNotification('회사 정보를 찾을 수 없습니다.', 'error');
                return;
            }
            
            // 편집 폼에 기존 데이터 채우기 (데이터베이스 스키마에 맞게)
            console.log('📝 편집 폼에 설정할 회사 정보:', company);
            const settings = company.tenant_settings || {};
            
            document.getElementById('editCompanyId').value = company.domain; // domain을 ID로 사용
            document.getElementById('editCompanyName').value = company.company_name || '';
            document.getElementById('editBusinessNumber').value = company.business_number || '';
            document.getElementById('editCorporateNumber').value = settings.corporate_number || '';
            document.getElementById('editRepresentative').value = settings.representative || '';
            document.getElementById('editOpeningDate').value = settings.opening_date || '';
            document.getElementById('editBusinessAddress').value = company.address || '';
            document.getElementById('editBusinessType').value = settings.business_type || '';
            document.getElementById('editWebsiteUrl').value = company.website || '';
            document.getElementById('editCompanyEmail').value = company.email || '';
            
            // 모달 표시
            const modal = document.getElementById('editCompanyModal');
            modal.style.display = 'flex';
        }

        // 회사 편집 모달 숨기기 함수
        function hideEditCompanyModal() {
            const modal = document.getElementById('editCompanyModal');
            modal.style.display = 'none';
            
            // 폼 초기화
            document.getElementById('editCompanyForm').reset();
        }

        // 회사 편집 처리 함수
        async function handleEditCompany(event) {
            event.preventDefault();
            
            console.log('🚀 편집 폼 제출 시작');
            console.log('📋 제출된 폼:', event.target);
            
            const formData = new FormData(event.target);
            
            // 모든 폼 데이터 확인
            console.log('📝 폼에서 받은 모든 데이터:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value} (${typeof value})`);
            }
            
            const companyId = formData.get('editCompanyId');
            
            console.log('🔍 편집할 회사 ID:', companyId, typeof companyId);
            console.log('🔍 편집할 회사 ID가 비어있나?', !companyId || companyId === '');
            
            if (!companyId || companyId === '') {
                console.error('❌ 회사 ID가 없음');
                showNotification('회사 ID가 설정되지 않았습니다.', 'error');
                return;
            }
            
            // allCompanies에서 회사 찾기 (데이터베이스에서 로드된 실제 데이터)
            console.log('📊 allCompanies에서 회사 검색:', allCompanies.map(c => ({id: c.id, name: c.company_name, domain: c.domain, type: typeof c.id})));
            
            const companyIndex = allCompanies.findIndex(c => {
                console.log(`도메인 비교: ${c.domain} === ${companyId} 또는 ID 비교: ${c.id} === ${companyId}`);
                return String(c.domain) === String(companyId) || String(c.id) === String(companyId);
            });
            
            console.log('🎯 찾은 회사 인덱스:', companyIndex);
            
            if (companyIndex === -1) {
                showNotification('수정할 회사를 찾을 수 없습니다.', 'error');
                return;
            }
            
            // 업데이트할 회사 정보 준비 (데이터베이스 스키마에 맞게)
            const updatedCompany = {
                ...allCompanies[companyIndex],
                company_name: formData.get('editCompanyName'),
                business_number: formData.get('editBusinessNumber'),
                corporate_number: formData.get('editCorporateNumber'),
                representative: formData.get('editRepresentative'),
                opening_date: formData.get('editOpeningDate'),
                business_address: formData.get('editBusinessAddress'),
                business_type: formData.get('editBusinessType'),
                template_select: formData.get('editTemplateSelect'),
                domain_url: formData.get('editDomainUrl') || '',
                updated_at: new Date().toISOString()
            };
            
            console.log('📝 업데이트할 회사 정보:', updatedCompany);
            
            try {
                // 실제 회사 객체 가져오기
                const company = allCompanies[companyIndex];
                console.log('🏢 업데이트할 회사 객체:', company);
                
                // 데이터베이스에 업데이트 (기존 회사 객체의 필드명 확인 후 업데이트)
                console.log('🔍 기존 회사 객체의 모든 필드:', Object.keys(company));
                
                if (db && db.client) {
                    // 실제 존재하는 필드만 업데이트 (스키마에 확실히 있는 필드들만)
                    const updateFields = {
                        company_name: formData.get('editCompanyName'),
                        updated_at: new Date().toISOString()
                    };
                    
                    // 실제 데이터베이스 스키마에 존재하는 필드들만 추가
                    if ('business_number' in company) updateFields.business_number = formData.get('editBusinessNumber');
                    if ('address' in company) updateFields.address = formData.get('editBusinessAddress');
                    if ('phone' in company) updateFields.phone = formData.get('editPhone') || company.phone;
                    if ('email' in company) updateFields.email = formData.get('editCompanyEmail');
                    if ('website' in company) updateFields.website = formData.get('editWebsiteUrl');
                    
                    // tenant_settings에 추가 정보 저장
                    if ('tenant_settings' in company) {
                        const currentSettings = company.tenant_settings || {};
                        updateFields.tenant_settings = {
                            ...currentSettings,
                            representative: formData.get('editRepresentative'),
                            opening_date: formData.get('editOpeningDate'),
                            business_type: formData.get('editBusinessType'),
                            corporate_number: formData.get('editCorporateNumber')
                        };
                    }
                    
                    console.log('📤 실제 업데이트할 필드들:', updateFields);
                    
                    const { data, error } = await db.client
                        .from('companies')
                        .update(updateFields)
                        .eq('id', company.id)
                        .select();
                    
                    if (error) {
                        console.error('데이터베이스 업데이트 오류:', error);
                        showNotification('회사 정보 수정 중 오류가 발생했습니다.', 'error');
                        return;
                    }
                    
                    console.log('✅ 데이터베이스 업데이트 성공:', data);
                    
                    // 데이터베이스에서 반환된 업데이트된 데이터 사용
                    if (data && data.length > 0) {
                        allCompanies[companyIndex] = data[0];
                        console.log('✅ 데이터베이스에서 반환된 업데이트된 회사 정보:', data[0]);
                    }
                } else {
                    // 오프라인 모드 - 로컬에서만 업데이트
                    const updatedCompanyForArray = {
                        ...company,
                        company_name: formData.get('editCompanyName'),
                        updated_at: new Date().toISOString()
                    };
                    
                    // 실제 데이터베이스 스키마에 존재하는 필드들만 업데이트
                    if ('business_number' in company) updatedCompanyForArray.business_number = formData.get('editBusinessNumber');
                    if ('address' in company) updatedCompanyForArray.address = formData.get('editBusinessAddress');
                    if ('email' in company) updatedCompanyForArray.email = formData.get('editCompanyEmail');
                    if ('website' in company) updatedCompanyForArray.website = formData.get('editWebsiteUrl');
                    
                    // tenant_settings에 추가 정보 저장
                    if ('tenant_settings' in company) {
                        const currentSettings = company.tenant_settings || {};
                        updatedCompanyForArray.tenant_settings = {
                            ...currentSettings,
                            representative: formData.get('editRepresentative'),
                            opening_date: formData.get('editOpeningDate'),
                            business_type: formData.get('editBusinessType'),
                            corporate_number: formData.get('editCorporateNumber')
                        };
                    }
                    
                    allCompanies[companyIndex] = updatedCompanyForArray;
                    console.log('✅ allCompanies 업데이트 완료 (오프라인):', updatedCompanyForArray);
                }
                
                // 성공 메시지
                const updatedCompanyName = allCompanies[companyIndex].company_name || formData.get('editCompanyName');
                showNotification(`${updatedCompanyName} 회사 정보가 성공적으로 수정되었습니다.`, 'success');
                
                // 모달 닫기
                hideEditCompanyModal();
                
                // 회사 목록 업데이트
                if (typeof renderCompaniesList === 'function') {
                    renderCompaniesList();
                }
                
                // 대시보드 데이터 새로고침
                await loadDashboardData();
                updateStatistics();
                
            } catch (error) {
                console.error('❌ 회사 정보 수정 중 오류 발생:', error);
                showNotification('회사 정보 수정 중 오류가 발생했습니다.', 'error');
            }
        }

        // 입력 유효성 검사 함수
        function validateCompanyData(companyData) {
            // 필수 필드 검사
            if (!companyData.companyName || companyData.companyName.trim() === '') {
                return { isValid: false, message: '법인명(단체명)을 입력해주세요.' };
            }
            
            if (!companyData.businessNumber || companyData.businessNumber.trim() === '') {
                return { isValid: false, message: '사업자등록번호를 입력해주세요.' };
            }
            
            if (!companyData.representative || companyData.representative.trim() === '') {
                return { isValid: false, message: '대표자명을 입력해주세요.' };
            }
            
            if (!companyData.openingDate) {
                return { isValid: false, message: '개업연월일을 입력해주세요.' };
            }
            
            if (!companyData.businessAddress || companyData.businessAddress.trim() === '') {
                return { isValid: false, message: '사업자 소재지를 입력해주세요.' };
            }
            
            if (!companyData.businessType || companyData.businessType.trim() === '') {
                return { isValid: false, message: '사업의 종류를 입력해주세요.' };
            }
            
            if (!companyData.templateSelect) {
                return { isValid: false, message: '홈페이지 템플릿을 선택해주세요.' };
            }
            
            // 사업자등록번호 형식 검사 (000-00-00000)
            const businessNumberPattern = /^\d{3}-\d{2}-\d{5}$/;
            if (!businessNumberPattern.test(companyData.businessNumber)) {
                return { isValid: false, message: '사업자등록번호는 000-00-00000 형식으로 입력해주세요.' };
            }
            
            // 법인등록번호 형식 검사 (선택 사항이지만 입력된 경우)
            if (companyData.corporateNumber && companyData.corporateNumber.trim() !== '') {
                const corporateNumberPattern = /^\d{6}-\d{7}$/;
                if (!corporateNumberPattern.test(companyData.corporateNumber)) {
                    return { isValid: false, message: '법인등록번호는 000000-0000000 형식으로 입력해주세요.' };
                }
            }
            
            // 개업연월일 유효성 검사 (미래 날짜 불가)
            const openingDate = new Date(companyData.openingDate);
            const today = new Date();
            if (openingDate > today) {
                return { isValid: false, message: '개업연월일은 오늘 날짜 이전이어야 합니다.' };
            }
            
            // 회사명 길이 검사
            if (companyData.companyName.length > 50) {
                return { isValid: false, message: '법인명(단체명)은 50자 이내로 입력해주세요.' };
            }
            
            return { isValid: true, message: '유효성 검사 통과' };
        }
        
        // 중복 체크 함수
        function checkDuplicateCompany(companyData) {
            const companies = JSON.parse(localStorage.getItem('platform_companies') || '[]');
            console.log('🔍 기존 회사 목록 확인:', companies);
            
            // 사업자등록번호 중복 체크
            const duplicateBusinessNumber = companies.find(company => 
                company.businessNumber === companyData.businessNumber
            );
            if (duplicateBusinessNumber) {
                const companyName = duplicateBusinessNumber.companyName || duplicateBusinessNumber.name || '이름 없음';
                return { 
                    isValid: false, 
                    message: `사업자등록번호 ${companyData.businessNumber}가 이미 등록되어 있습니다. (회사명: ${companyName})` 
                };
            }
            
            // 법인등록번호 중복 체크 (입력된 경우에만)
            if (companyData.corporateNumber && companyData.corporateNumber.trim() !== '') {
                const duplicateCorporateNumber = companies.find(company => 
                    company.corporateNumber === companyData.corporateNumber
                );
                if (duplicateCorporateNumber) {
                    const companyName = duplicateCorporateNumber.companyName || duplicateCorporateNumber.name || '이름 없음';
                    return { 
                        isValid: false, 
                        message: `법인등록번호 ${companyData.corporateNumber}가 이미 등록되어 있습니다. (회사명: ${companyName})` 
                    };
                }
            }
            
            // 회사명 중복 체크 (정확히 일치하는 경우)
            const duplicateCompanyName = companies.find(company => {
                const existingName = company.companyName || company.name || '';
                const newName = companyData.companyName || '';
                return existingName.toLowerCase() === newName.toLowerCase();
            });
            if (duplicateCompanyName) {
                return { 
                    isValid: false, 
                    message: `회사명 "${companyData.companyName}"이 이미 등록되어 있습니다.` 
                };
            }
            
            console.log('✅ 중복 체크 완료 - 중복 없음');
            return { isValid: true, message: '중복 체크 통과' };
        }

        // 편집용 중복 체크 함수 (자기 자신 제외)
        function checkDuplicateCompanyForEdit(companyData, editingCompanyId) {
            const companies = JSON.parse(localStorage.getItem('platform_companies') || '[]');
            console.log('🔍 편집용 중복 체크 - 편집 중인 회사 ID:', editingCompanyId);
            
            // 사업자등록번호 중복 체크 (자기 자신 제외)
            const duplicateBusinessNumber = companies.find(company => 
                String(company.id) !== String(editingCompanyId) && 
                company.businessNumber === companyData.businessNumber
            );
            if (duplicateBusinessNumber) {
                const companyName = duplicateBusinessNumber.companyName || duplicateBusinessNumber.name || '이름 없음';
                return { 
                    isValid: false, 
                    message: `사업자등록번호 ${companyData.businessNumber}가 이미 등록되어 있습니다. (회사명: ${companyName})` 
                };
            }
            
            // 법인등록번호 중복 체크 (입력된 경우에만, 자기 자신 제외)
            if (companyData.corporateNumber && companyData.corporateNumber.trim() !== '') {
                const duplicateCorporateNumber = companies.find(company => 
                    String(company.id) !== String(editingCompanyId) && 
                    company.corporateNumber === companyData.corporateNumber
                );
                if (duplicateCorporateNumber) {
                    const companyName = duplicateCorporateNumber.companyName || duplicateCorporateNumber.name || '이름 없음';
                    return { 
                        isValid: false, 
                        message: `법인등록번호 ${companyData.corporateNumber}가 이미 등록되어 있습니다. (회사명: ${companyName})` 
                    };
                }
            }
            
            // 회사명 중복 체크 (자기 자신 제외)
            const duplicateCompanyName = companies.find(company => {
                if (String(company.id) === String(editingCompanyId)) return false;
                const existingName = company.companyName || company.name || '';
                const newName = companyData.companyName || '';
                return existingName.toLowerCase() === newName.toLowerCase();
            });
            if (duplicateCompanyName) {
                return { 
                    isValid: false, 
                    message: `회사명 "${companyData.companyName}"이 이미 등록되어 있습니다.` 
                };
            }
            
            console.log('✅ 편집용 중복 체크 완료 - 중복 없음');
            return { isValid: true, message: '편집용 중복 체크 통과' };
        }

        // 마스터 대시보드 통계 계산 함수 (정확한 계산)
        function updateMasterDashboardStats() {
            console.log('📊 마스터 대시보드 통계 업데이트');
            
            // allCompanies와 allUsers 배열 사용 (실제 데이터베이스 데이터)
            const totalCompanies = allCompanies.length;
            const totalUsers = allUsers.length;
            
            // 활성 홈페이지 수 계산 (is_active가 false가 아닌 회사들)
            const activeWebsites = allCompanies.filter(company => 
                company.is_active !== false
            ).length;
            
            console.log(`📊 총 회사: ${totalCompanies}개`);
            console.log(`📊 총 사용자: ${totalUsers}명`);
            console.log(`📊 활성 홈페이지: ${activeWebsites}개`);
            
            // UI 업데이트
            updateStatCard('totalCompanies', totalCompanies);
            updateStatCard('totalUsers', totalUsers);
            updateStatCard('activeWebsites', activeWebsites);
            updateSystemStatus(totalCompanies > 0 ? 100 : 0);
            
            // systemStats 전역 객체도 업데이트
            systemStats.totalCompanies = totalCompanies;
            systemStats.totalUsers = totalUsers;
            systemStats.activeWebsites = activeWebsites;
        }
        
        // updateMasterDashboardStats를 전역 함수로 등록
        window.updateMasterDashboardStats = updateMasterDashboardStats;
        
        // 통계 카드 업데이트 함수
        function updateStatCard(cardId, value) {
            const card = document.getElementById(cardId);
            if (card) {
                const valueElement = card.querySelector('.value');
                if (valueElement) {
                    // 숫자 애니메이션 효과
                    animateNumber(valueElement, parseInt(valueElement.textContent) || 0, value);
                }
            }
        }
        
        // 시스템 상태 업데이트 함수
        function updateSystemStatus(uptime) {
            const statusCard = document.getElementById('systemStatus');
            if (statusCard) {
                const trendElement = statusCard.querySelector('.trend');
                if (trendElement) {
                    trendElement.textContent = `${uptime.toFixed(1)}% 가동률`;
                }
            }
        }
        
        // 숫자 애니메이션 함수
        function animateNumber(element, start, end, duration = 1000) {
            const startTime = performance.now();
            const difference = end - start;
            
            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // easeOutQuart 이징 함수
                const easedProgress = 1 - Math.pow(1 - progress, 4);
                const current = Math.round(start + (difference * easedProgress));
                
                element.textContent = current;
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }
            
            requestAnimationFrame(updateNumber);
        }

        // 시스템 관리 함수들

        // 데이터베이스 백업 함수
        async function backupDatabase() {
            console.log('🗄️ 데이터베이스 백업 시작');
            
            try {
                // 진행 상황 표시
                showNotification('데이터베이스 백업을 시작합니다...', 'info');
                
                // 모든 테이블의 데이터 수집
                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    companies: allCompanies,
                    users: allUsers
                };
                
                // localStorage 데이터도 포함
                const localStorageData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    localStorageData[key] = localStorage.getItem(key);
                }
                backupData.localStorage = localStorageData;
                
                // JSON 파일로 다운로드
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `steelworks_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('✅ 데이터베이스 백업 완료');
                showNotification('데이터베이스 백업이 완료되었습니다.', 'success');
                
                // 백업 시간 업데이트
                updateLastBackupTime();
                
            } catch (error) {
                console.error('❌ 데이터베이스 백업 실패:', error);
                showNotification('데이터베이스 백업 중 오류가 발생했습니다.', 'error');
            }
        }

        // 캐시 정리 함수
        function clearCache() {
            console.log('🧹 캐시 정리 시작');
            
            try {
                // localStorage 캐시 데이터 정리 (중요한 데이터는 제외)
                const preserveKeys = ['platform_companies', 'users', 'system_settings'];
                const keysToRemove = [];
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && !preserveKeys.some(preserve => key.includes(preserve))) {
                        // 임시 캐시나 세션 데이터만 제거
                        if (key.includes('temp_') || key.includes('cache_') || key.includes('session_')) {
                            keysToRemove.push(key);
                        }
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                // 브라우저 캐시 정리 (가능한 경우)
                if ('caches' in window) {
                    caches.keys().then(cacheNames => {
                        cacheNames.forEach(cacheName => {
                            caches.delete(cacheName);
                        });
                    });
                }
                
                console.log(`✅ 캐시 정리 완료 (${keysToRemove.length}개 항목 제거)`);
                showNotification(`캐시가 정리되었습니다. (${keysToRemove.length}개 항목 제거)`, 'success');
                
                // 시스템 설정 새로고침
                setTimeout(() => {
                    renderSystemSettings();
                }, 1000);
                
            } catch (error) {
                console.error('❌ 캐시 정리 실패:', error);
                showNotification('캐시 정리 중 오류가 발생했습니다.', 'error');
            }
        }

        // 시스템 로그 내보내기 함수
        function exportSystemLogs() {
            console.log('📋 시스템 로그 내보내기 시작');
            
            try {
                // 시스템 로그 데이터 수집
                const logs = {
                    timestamp: new Date().toISOString(),
                    systemInfo: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        language: navigator.language,
                        cookieEnabled: navigator.cookieEnabled,
                        onLine: navigator.onLine
                    },
                    databaseStatus: {
                        connected: !!(db && db.client),
                        companiesCount: allCompanies.length,
                        usersCount: allUsers.length
                    },
                    performanceInfo: {
                        memoryUsage: performance.memory ? {
                            usedJSHeapSize: performance.memory.usedJSHeapSize,
                            totalJSHeapSize: performance.memory.totalJSHeapSize,
                            jsHeapSizeLimit: performance.memory.jsHeapSizeLimit
                        } : 'Not available',
                        timing: performance.timing
                    },
                    localStorageInfo: {
                        itemCount: localStorage.length,
                        estimatedSize: JSON.stringify(localStorage).length
                    },
                    recentActivities: [
                        {
                            type: 'system_start',
                            message: '시스템 시작',
                            timestamp: new Date().toISOString()
                        },
                        {
                            type: 'companies_loaded',
                            message: `${allCompanies.length}개 회사 로드됨`,
                            timestamp: new Date().toISOString()
                        },
                        {
                            type: 'users_loaded',
                            message: `${allUsers.length}명 사용자 로드됨`,
                            timestamp: new Date().toISOString()
                        }
                    ]
                };
                
                // 로그를 텍스트 파일로 다운로드
                const logText = `=== SteelWorks Platform 시스템 로그 ===
생성 시간: ${logs.timestamp}

=== 시스템 정보 ===
사용자 에이전트: ${logs.systemInfo.userAgent}
플랫폼: ${logs.systemInfo.platform}
언어: ${logs.systemInfo.language}
쿠키 사용 가능: ${logs.systemInfo.cookieEnabled}
온라인 상태: ${logs.systemInfo.onLine}

=== 데이터베이스 상태 ===
연결 상태: ${logs.databaseStatus.connected ? '연결됨' : '연결 안됨'}
등록된 회사 수: ${logs.databaseStatus.companiesCount}
등록된 사용자 수: ${logs.databaseStatus.usersCount}

=== 성능 정보 ===
메모리 사용량: ${typeof logs.performanceInfo.memoryUsage === 'object' ? 
    `사용량: ${(logs.performanceInfo.memoryUsage.usedJSHeapSize / 1024 / 1024).toFixed(2)}MB` : 
    logs.performanceInfo.memoryUsage}

=== localStorage 정보 ===
저장된 항목 수: ${logs.localStorageInfo.itemCount}
예상 크기: ${(logs.localStorageInfo.estimatedSize / 1024).toFixed(2)}KB

=== 최근 활동 ===
${logs.recentActivities.map(activity => `${activity.timestamp}: ${activity.message}`).join('\n')}

=== 상세 데이터 (JSON) ===
${JSON.stringify(logs, null, 2)}
`;
                
                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `steelworks_system_log_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('✅ 시스템 로그 내보내기 완료');
                showNotification('시스템 로그가 내보내졌습니다.', 'success');
                
            } catch (error) {
                console.error('❌ 시스템 로그 내보내기 실패:', error);
                showNotification('시스템 로그 내보내기 중 오류가 발생했습니다.', 'error');
            }
        }

        // 고급 설정 모달 표시 함수
        function showSystemSettings() {
            console.log('⚙️ 고급 설정 열기');
            
            // 고급 설정 모달 HTML 생성
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'advancedSettingsModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>⚙️ 고급 시스템 설정</h2>
                        <button class="close-btn" onclick="hideAdvancedSettings()">&times;</button>
                    </div>
                    
                    <div style="max-height: 60vh; overflow-y: auto;">
                        <div class="form-group">
                            <h3>🔧 시스템 설정</h3>
                            <label>
                                <input type="checkbox" id="enableDebugMode" ${localStorage.getItem('debugMode') === 'true' ? 'checked' : ''}> 
                                디버그 모드 활성화
                            </label>
                            <small style="display: block; color: #666; margin-top: 5px;">
                                개발자 도구에 상세한 로그를 출력합니다.
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="enableAutoBackup" ${localStorage.getItem('autoBackup') === 'true' ? 'checked' : ''}> 
                                자동 백업 활성화
                            </label>
                            <small style="display: block; color: #666; margin-top: 5px;">
                                매일 자정에 자동으로 데이터베이스를 백업합니다.
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <h3>📊 성능 설정</h3>
                            <label for="cacheTimeout">캐시 만료 시간 (분)</label>
                            <input type="number" id="cacheTimeout" value="${localStorage.getItem('cacheTimeout') || '60'}" min="1" max="1440">
                            <small style="display: block; color: #666; margin-top: 5px;">
                                데이터 캐시가 만료되는 시간을 설정합니다.
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="maxLogEntries">최대 로그 항목 수</label>
                            <input type="number" id="maxLogEntries" value="${localStorage.getItem('maxLogEntries') || '1000'}" min="100" max="10000">
                            <small style="display: block; color: #666; margin-top: 5px;">
                                시스템에서 보관할 최대 로그 항목 수입니다.
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <h3>🛡️ 보안 설정</h3>
                            <label>
                                <input type="checkbox" id="enableSecurityLog" ${localStorage.getItem('securityLog') === 'true' ? 'checked' : ''}> 
                                보안 로그 활성화
                            </label>
                            <small style="display: block; color: #666; margin-top: 5px;">
                                로그인, 권한 변경 등의 보안 관련 활동을 기록합니다.
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <h3>🎨 UI 설정</h3>
                            <label for="themeMode">테마 모드</label>
                            <select id="themeMode">
                                <option value="light" ${localStorage.getItem('themeMode') === 'light' ? 'selected' : ''}>라이트 모드</option>
                                <option value="dark" ${localStorage.getItem('themeMode') === 'dark' ? 'selected' : ''}>다크 모드</option>
                                <option value="auto" ${(!localStorage.getItem('themeMode') || localStorage.getItem('themeMode') === 'auto') ? 'selected' : ''}>자동</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <h3>💾 데이터 관리</h3>
                            <div class="action-buttons" style="gap: 10px;">
                                <button onclick="resetAllData()" class="btn btn-danger">
                                    <i class="fas fa-exclamation-triangle"></i> 모든 데이터 초기화
                                </button>
                                <button onclick="repairDatabase()" class="btn btn-warning">
                                    <i class="fas fa-wrench"></i> 데이터베이스 복구
                                </button>
                                <button onclick="optimizeDatabase()" class="btn btn-info">
                                    <i class="fas fa-tachometer-alt"></i> 데이터베이스 최적화
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group" style="margin-top: 20px;">
                        <button onclick="saveAdvancedSettings()" class="btn-submit">설정 저장</button>
                        <button onclick="hideAdvancedSettings()" class="btn-cancel">취소</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        // 고급 설정 저장 함수
        function saveAdvancedSettings() {
            try {
                localStorage.setItem('debugMode', document.getElementById('enableDebugMode').checked);
                localStorage.setItem('autoBackup', document.getElementById('enableAutoBackup').checked);
                localStorage.setItem('cacheTimeout', document.getElementById('cacheTimeout').value);
                localStorage.setItem('maxLogEntries', document.getElementById('maxLogEntries').value);
                localStorage.setItem('securityLog', document.getElementById('enableSecurityLog').checked);
                localStorage.setItem('themeMode', document.getElementById('themeMode').value);
                
                console.log('✅ 고급 설정 저장 완료');
                showNotification('시스템 설정이 저장되었습니다.', 'success');
                hideAdvancedSettings();
                
                // 설정 적용
                applySystemSettings();
                
            } catch (error) {
                console.error('❌ 설정 저장 실패:', error);
                showNotification('설정 저장 중 오류가 발생했습니다.', 'error');
            }
        }

        // 고급 설정 모달 닫기
        function hideAdvancedSettings() {
            const modal = document.getElementById('advancedSettingsModal');
            if (modal) {
                modal.remove();
            }
        }

        // 시스템 설정 적용 함수
        function applySystemSettings() {
            // 테마 적용
            const themeMode = localStorage.getItem('themeMode') || 'auto';
            if (themeMode === 'dark') {
                document.body.classList.add('dark-theme');
            } else if (themeMode === 'light') {
                document.body.classList.remove('dark-theme');
            } else {
                // 자동 모드 - 시스템 설정에 따라
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }
            }
        }

        // 모든 데이터 초기화 함수
        function resetAllData() {
            if (!confirm('⚠️ 모든 데이터가 삭제됩니다. 계속하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
                return;
            }
            
            if (!confirm('🔴 정말로 모든 데이터를 삭제하시겠습니까?\n\n- 모든 회사 정보\n- 모든 사용자 정보\n- 모든 설정\n- 모든 로그')) {
                return;
            }
            
            try {
                // localStorage 완전 초기화
                localStorage.clear();
                
                // 전역 변수 초기화
                allCompanies = [];
                allUsers = [];
                
                console.log('🔴 모든 데이터 초기화 완료');
                showNotification('모든 데이터가 초기화되었습니다. 페이지를 새로고침합니다.', 'success');
                
                // 페이지 새로고침
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('❌ 데이터 초기화 실패:', error);
                showNotification('데이터 초기화 중 오류가 발생했습니다.', 'error');
            }
        }

        // 데이터베이스 복구 함수
        async function repairDatabase() {
            console.log('🔧 데이터베이스 복구 시작');
            showNotification('데이터베이스 복구를 시작합니다...', 'info');
            
            try {
                // 데이터 무결성 검사 및 복구
                let repairedCount = 0;
                
                // 1. 회사 데이터 검사
                allCompanies.forEach((company, index) => {
                    if (!company.id || !company.company_name) {
                        console.log(`🔧 회사 데이터 복구: 인덱스 ${index}`);
                        if (!company.id) company.id = Date.now() + index;
                        if (!company.company_name) company.company_name = `회사 ${index + 1}`;
                        repairedCount++;
                    }
                });
                
                // 2. 사용자 데이터 검사
                allUsers.forEach((user, index) => {
                    if (!user.id || !user.name) {
                        console.log(`🔧 사용자 데이터 복구: 인덱스 ${index}`);
                        if (!user.id) user.id = Date.now() + index;
                        if (!user.name) user.name = `사용자 ${index + 1}`;
                        repairedCount++;
                    }
                });
                
                console.log(`✅ 데이터베이스 복구 완료 (${repairedCount}개 항목 복구)`);
                showNotification(`데이터베이스 복구가 완료되었습니다. (${repairedCount}개 항목 복구)`, 'success');
                
                // UI 새로고침
                await loadDashboardData();
                updateStatistics();
                
            } catch (error) {
                console.error('❌ 데이터베이스 복구 실패:', error);
                showNotification('데이터베이스 복구 중 오류가 발생했습니다.', 'error');
            }
        }

        // 데이터베이스 최적화 함수
        function optimizeDatabase() {
            console.log('⚡ 데이터베이스 최적화 시작');
            showNotification('데이터베이스 최적화를 시작합니다...', 'info');
            
            try {
                let optimizedCount = 0;
                
                // 중복 제거
                const uniqueCompanies = allCompanies.filter((company, index, self) => 
                    index === self.findIndex(c => c.id === company.id)
                );
                const uniqueUsers = allUsers.filter((user, index, self) => 
                    index === self.findIndex(u => u.id === user.id)
                );
                
                optimizedCount += (allCompanies.length - uniqueCompanies.length);
                optimizedCount += (allUsers.length - uniqueUsers.length);
                
                allCompanies = uniqueCompanies;
                allUsers = uniqueUsers;
                
                // 불필요한 localStorage 항목 정리
                const unnecessary = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('temp_') || key.includes('cache_old_'))) {
                        unnecessary.push(key);
                    }
                }
                unnecessary.forEach(key => localStorage.removeItem(key));
                optimizedCount += unnecessary.length;
                
                console.log(`⚡ 데이터베이스 최적화 완료 (${optimizedCount}개 항목 정리)`);
                showNotification(`데이터베이스 최적화가 완료되었습니다. (${optimizedCount}개 항목 정리)`, 'success');
                
                // UI 새로고침
                updateStatistics();
                
            } catch (error) {
                console.error('❌ 데이터베이스 최적화 실패:', error);
                showNotification('데이터베이스 최적화 중 오류가 발생했습니다.', 'error');
            }
        }

        // 마지막 백업 시간 가져오기 함수
        function getLastBackupTime() {
            const lastBackup = localStorage.getItem('lastBackupTime');
            if (lastBackup) {
                return new Date(lastBackup).toLocaleDateString('ko-KR');
            }
            return '백업 없음';
        }

        // 마지막 백업 시간 업데이트 함수
        function updateLastBackupTime() {
            localStorage.setItem('lastBackupTime', new Date().toISOString());
            renderSystemSettings(); // 시스템 설정 화면 새로고침
        }


        // 모든 회사를 Scout 템플릿으로 설정하는 함수
        function setAllCompaniesToScout() {
            console.log('🎨 모든 회사를 Scout 템플릿으로 설정 시작');
            
            const companies = JSON.parse(localStorage.getItem('platform_companies') || '[]');
            let updatedCount = 0;
            
            companies.forEach(company => {
                if (company.templateSelect !== 'scout') {
                    company.templateSelect = 'scout';
                    updatedCount++;
                }
            });
            
            localStorage.setItem('platform_companies', JSON.stringify(companies));
            
            if (updatedCount > 0) {
                console.log(`✅ ${updatedCount}개 회사의 템플릿을 Scout으로 변경 완료`);
                showNotification(`${updatedCount}개 회사의 템플릿이 Scout으로 변경되었습니다`, 'success');
                updateCompanyList();
            } else {
                console.log('ℹ️ 모든 회사가 이미 Scout 템플릿 사용 중');
                showNotification('모든 회사가 이미 Scout 템플릿을 사용하고 있습니다', 'info');
            }
        }

        // 기존 회사 데이터 정리
        function cleanupOldCompanyData() {
            console.log('🧹 기존 회사 데이터 정리 시작...');
            
            // 기존 5개 회사 데이터 삭제
            localStorage.removeItem('platform_companies');
            
            console.log('✅ 기존 회사 데이터 정리 완료');
        }
        
        // STEP 1: 모든 기존 데이터 완전 정리
        function cleanAllEmployeeData() {
            console.log('🧹 모든 기존 직원 데이터 완전 정리 시작...');
            
            // 모든 플래그 제거
            localStorage.removeItem('employees_reset_v2');
            localStorage.removeItem('employees_reset_v3');
            localStorage.removeItem('employees_fixed_v4');
            localStorage.removeItem('employees_initialized');
            
            // 모든 회사별 직원 데이터 삭제
            const companyIds = ['test-company-1', 'test-company-2', 'test-company-3', 'seokyoung-snt', 'posco', 'hyundai-steel', 'namkyung-steel', 'new-test-company'];
            companyIds.forEach(companyId => {
                localStorage.removeItem(`company_${companyId}_employees`);
                console.log(`🗑️ ${companyId} 직원 데이터 삭제`);
            });
            
            // 통합 직원 목록 삭제
            localStorage.removeItem('employees');
            console.log('🗑️ 통합 직원 목록 삭제');
            
            console.log('✅ 모든 기존 데이터 정리 완료');
        }
        
        // 샘플 직원 데이터 생성 함수 제거됨 - 데이터베이스에서 실제 직원 데이터 사용
        function createExactEmployeeData() {
            console.log('📊 데이터베이스에서 실제 직원 데이터 사용 - 샘플 데이터 생성 안함');
            return 0;
        }
        
        // STEP 3: 회사별 사용자 수 업데이트
        function updateCompanyUserCounts() {
            console.log('📊 회사별 사용자 수 업데이트 시작...');
            
            const companies = JSON.parse(localStorage.getItem('platform_companies') || '[]');
            
            companies.forEach(company => {
                const companyKey = `company_${company.id}_employees`;
                const employees = JSON.parse(localStorage.getItem(companyKey) || '[]');
                company.users = employees.length;
                console.log(`📊 ${company.companyName || company.name}: ${employees.length}명`);
            });
            
            localStorage.setItem('platform_companies', JSON.stringify(companies));
            console.log('✅ 회사별 사용자 수 업데이트 완료');
            
            return companies.reduce((sum, company) => sum + company.users, 0);
        }
        
        // STEP 4: 전체 프로세스 실행
        function fixAllCompanyEmployees() {
            console.log('🔧 직원 데이터 정리 프로세스 시작...');
            
            try {
                // 1단계: 기존 데이터 완전 정리
                cleanAllEmployeeData();
                
                // 2단계: 정확한 직원 데이터 생성
                const totalEmployees = createExactEmployeeData();
                
                // 3단계: 회사별 사용자 수 업데이트
                const totalUsers = updateCompanyUserCounts();
                
                // 4단계: UI 업데이트
                setTimeout(() => {
                    updateStatistics();
                    updateCompanyList();
                }, 300);
                
                console.log(`🎉 프로세스 완료! 총 ${totalUsers}명 (3개 회사 × 3명)`);
                showNotification(`직원 데이터 정리 완료: 총 ${totalUsers}명`, 'success');
                
            } catch (error) {
                console.error('❌ 직원 데이터 정리 중 오류:', error);
                showNotification('직원 데이터 정리 중 오류가 발생했습니다.', 'error');
            }
        }

        // 테스트 데이터 리셋 함수
        function resetTestData() {
            if (confirm('모든 테스트 데이터를 초기 상태로 리셋하시겠습니까?\n\n추가한 직원 정보가 모두 삭제됩니다.')) {
                console.log('🔄 테스트 데이터 리셋 시작');
                
                // 초기화 플래그 제거
                localStorage.removeItem('test_companies_initialized_v1');
                
                // 모든 데이터 정리
                cleanupOldCompanyData();
                cleanAllEmployeeData();
                
                // 페이지 새로고침
                window.location.reload();
            }
        }
        
        // 페이지 로드 시 권한 체크
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = JSON.parse(localStorage.getItem('steelplatform_currentUser') || localStorage.getItem('currentUser') || '{}');
            
            console.log('현재 사용자:', currentUser); // 디버깅용
            
            // 마스터가 아니면 리다이렉트
            if (!currentUser || currentUser.role !== 'master') {
                console.log('마스터 권한 없음:', currentUser.role); // 디버깅용
                alert('마스터 권한이 필요합니다.');
                window.location.href = '../../1-homepage/templates/index.html';
                return;
            }
            
            // 사용자 정보 표시
            const userInfoElement = document.querySelector('.user-info');
            if (userInfoElement) {
                userInfoElement.innerHTML = `
                    <i class="fas fa-crown" style="color: gold;"></i> ${currentUser.name || '마스터 관리자'}
                `;
            }
            
            // 정확한 순서로 초기화 실행
            console.log('🚀 마스터 대시보드 초기화 시작');
            
            // 초기 설정이 완료되었는지 확인
            const isInitialized = localStorage.getItem('test_companies_initialized_v1');
            
            if (!isInitialized) {
                console.log('🔄 최초 실행 - 데이터 초기화');
                
                // 1. 기존 데이터 완전 정리
                cleanupOldCompanyData();
                
                // 2. 회사 목록 초기화 (users: 0으로 설정)
                updateCompanyList();
                
                // 3. 직원 데이터 정리 (각 회사당 정확히 3명)
                fixAllCompanyEmployees();
                
                // 4. 대표 데이터 생성 (최초 실행 시에만)
                console.log('🔄 최초 실행 - 대표 데이터 생성');
                ensureRepresentativesExistOnce();
                
                // 초기화 완료 플래그 설정
                localStorage.setItem('test_companies_initialized_v1', 'true');
                
                console.log('✅ 최초 초기화 완료');
            } else {
                console.log('✅ 이미 초기화됨 - 기존 데이터 유지');
                
                // 회사 목록만 업데이트 (직원 데이터는 유지)
                updateCompanyList();
                
                // 통계 업데이트
                updateStatistics();
                
                // 회사 대표 데이터 확인 (기존 데이터 보존)
                console.log('🔄 페이지 로드 시 대표 데이터 확인');
                ensureRepresentativesExistOnce();
                
                // 사용자 목록 초기화
                renderUsersList();
            }
            
            console.log('✅ 마스터 대시보드 초기화 완료');
            
            // 사용자 편집 폼 이벤트 리스너 추가 (백업용)
            const editUserForm = document.getElementById('editUserForm');
            if (editUserForm) {
                editUserForm.addEventListener('submit', function(e) {
                    console.log('🔥 폼 제출 이벤트 발생! (백업 리스너)');
                    handleEditUser(e);
                });
                console.log('✅ 편집 폼 이벤트 리스너 추가됨');
            }
            
            // 자동 재생성 제거 - 이제 사용자 상호작용 시에만 업데이트
        });

        // 이벤트 기반 통계 업데이트 (자동 새로고침 제거)
        // setInterval 제거 - 이제 이벤트 발생 시에만 업데이트
        
        // 사용자 상호작용 시 통계 업데이트
        document.addEventListener('click', function(e) {
            // 특정 버튼 클릭 시에만 통계 업데이트
            if (e.target.closest('.tab-btn') || 
                e.target.closest('.btn-primary') || 
                e.target.closest('.btn-secondary') ||
                e.target.closest('.add-new-btn')) {
                
                console.log('🔄 사용자 상호작용으로 인한 통계 업데이트');
                setTimeout(() => {
                    updateStatistics();
                }, 100);
            }
        });

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 마스터 대시보드 초기화 시작');
            
            // 샘플 데이터 정리
            cleanupSampleData();
            
            // 데이터베이스에서 데이터 로드
            await loadDashboardData();
            
            // 데이터 로드 확인
            console.log('📊 로드된 데이터 확인:');
            console.log(`  - allCompanies: ${allCompanies.length}개`);
            console.log(`  - allUsers: ${allUsers.length}명`);
            
            // 통계 업데이트
            updateStatistics();
            
            // 기본 탭 활성화
            showTab('companies');
            
            console.log('✅ 마스터 대시보드 초기화 완료');
        });
    </script>

</body>
</html>